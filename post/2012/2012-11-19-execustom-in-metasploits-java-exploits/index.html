<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en-us">
<head>
  <title>
    EXE::Custom in Metasploit&#39;s Java Exploits // Room362
  </title>

  <link href="http://gmpg.org/xfn/11" rel="profile">
<meta http-equiv="content-type" content="text/html; charset=utf-8">


<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">

<meta name="description" content="">
<meta name="keywords" content="">
<meta name="author" content="mubix">
<meta name="generator" content="Hugo 0.17" />

  <meta property="og:title" content="EXE::Custom in Metasploit&#39;s Java Exploits" />
<meta property="og:description" content="" />
<meta property="og:type" content="website" />
<meta property="og:locale" content="en_US" />
<meta property="og:url" content="https://room362.com/post/2012/2012-11-19-execustom-in-metasploits-java-exploits/" />


  
  <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/pure/0.5.0/base-min.css">
  <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/pure/0.5.0/pure-min.css">
  
  
    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/pure/0.5.0/grids-responsive-min.css">
  
  

  <link rel="stylesheet" href="https://room362.com//css/redlounge.css">
  <link href="//maxcdn.bootstrapcdn.com/font-awesome/4.5.0/css/font-awesome.min.css" rel="stylesheet">
  <link href='//fonts.googleapis.com/css?family=Raleway:400,200,100,700,300,500,600,800' rel='stylesheet' type='text/css'>
  <link href='//fonts.googleapis.com/css?family=Libre+Baskerville:400,700,400italic' rel='stylesheet' type='text/css'>

  
  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/touch-icon-144-precomposed.png">
  <link rel="shortcut icon" href="/favicon.png">

  
  <link href="" rel="alternate" type="application/rss+xml" title="Room362" />

    
  
  <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/8.7/styles/tomorrow-night-bright.min.css">
  
  <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/8.7/highlight.min.js"></script>
  <script>hljs.initHighlightingOnLoad();</script>


  

  

  

  
</head>

<body>
	

	<div id="layout" class="pure-g">
    <div class="sidebar pure-u-1 pure-u-md-1-4">
  <div class="header">
    

	
	  <img src="/images/headshot_small.png" class="sidebarphoto">
	

    <h1 class="brand-title">Room362</h1>
    <h2 class="brand-tagline">Blatherings of a security addict</h2>

    <nav class="nav">
      <ul class="nav-list">
        <li class="nav-item"><span class="nav-item-separator">//</span><a href="https://room362.com/">Home</a></li><br>
        
          <li class="nav-item"><span class="nav-item-separator">//</span><a href="/brandon/">Brandon</a></li><br>
        
          <li class="nav-item"><span class="nav-item-separator">//</span><a href="/about/">About</a></li><br>
        
      </ul>
    </nav>

    
    <div class="social-buttons">
      
        
        <a href="/index.xml" target="_blank"><i class='fa fa-rss'></i></a>
        
      
        
        <a href="https://linkedin.com/in/mubix" target="_blank"><i class='fa fa-linkedin'></i></a>
        
      
        
        <a href="https://twitter.com/mubix" target="_blank"><i class='fa fa-twitter'></i></a>
        
      
      
    </div>
    
    <br>
    <h2 class="brand-tagline">Support Me</h2>
    <nav class="nav">
      <ul class="nav-list">
        <li class="nav-item"><span class="nav-item-separator">//</span><a href="https://paypal.me/mubix/10">Paypal Donation</a></li><br>
          <li class="nav-item"><span class="nav-item-separator">//</span><a href="https://patreon.com/mubix">Patreon Subscription</a></li>
      </ul>
    </nav>

  </div>
</div>

	
	

    <div class="content pure-u-1 pure-u-md-3-4">
		<a name="top"></a>
		

		
			
	    
  		<section class="post">
            <h1 class="post-title">
              <a href="/post/2012/2012-11-19-execustom-in-metasploits-java-exploits/">EXE::Custom in Metasploit&#39;s Java Exploits</a>
            </h1>
            <h3 class="post-subtitle">
            	
            </h3>
            
            	<span class="post-date">
                	<span class="post-date-day"><sup>19</sup></span><span class="post-date-separator">/</span><span class="post-date-month">Nov</span> <span class="post-date-year">2012</span>
            	</span>
            	
            
            	
            		<span class="post-author-single">By <a class="post-author"  target="">mubix</a></span>
            		




            	
            

			
			
				<div class="post-categories">
				
					<a class="post-category post-category-java" href="https://room362.com//categories/java">java</a>
				
					<a class="post-category post-category-metasploit" href="https://room362.com//categories/metasploit">metasploit</a>
				
				</div>
			

			

			

            <p>Let me say first off that this isn&rsquo;t the most elegant of ways to accomplish it. It is in the &ldquo;it works for me&rdquo; stage.</p>

<p>A quick primer on EXE::Custom: This is a setting just like RHOST in Metasploit wherever an EXE is built for Windows payloads. Such as PSEXEC, BypassUAC, etc. It tells Metasploit to ignore all of your payload settings and just use the EXE you have specified. Now this does come at a bit of a cost. If you don&rsquo;t have a handler set up to catch whatever is in your EXE and you have bogus information in your payload settings for your module, Metasploit won&rsquo;t be able to magically determine what you want it to do. So make sure that you either have the payload settings correct (even though it won&rsquo;t use them for the exploit) or set the option &ldquo;DisablePayloadHandler&rdquo; to true and start your own handler somewhere else.</p>

<p>With that said, the Java Signed Applet attack is one of the most widely used, one problem in the Metasploit module version is that you have no external control (such as EXE::Custom) for the binary that is dropped if you are using a Windows native payload. (I do highly recommend trying out Java Meterpreter, but that it for another post)</p>

<p>Here is the hack that gets me by until a more elegant solution is thought up by smarter people than I:</p>

<p>We are going to use the Java Rhino exploit, and this story starts with an undetectable.exe sitting in /tmp/ - How you bypass the AV you are up against is up to you. The first thing we need to do is make a core library change. Yes, this is as scary as it sounds and you should document any time you do so you can revert as needed.</p>

<p>In your MSF directory open up lib/msf/util/exe.rb - should look something like this:</p>

<p><img src="/images/postimages/201211_customejavaexe_1.png" alt="" /></p>

<p>Scroll down or search for <code>self.to_jar</code> - should look something like this:</p>

<p><img src="/images/postimages/201211_customejavaexe_2.png" alt="" /></p>

<p>Now add <code>exe = File.read('/path/to/your/evil.exe')</code> as demonstrated below:</p>

<p><img src="/images/postimages/201211_customejavaexe_3.png" alt="" /></p>

<p>Cool. We&rsquo;ve made our change, now we have to pull down a jar generated with our evil bin, and the Rhino exploit. We can do that by spinning up Metasploit with our newly editing core library. Load up the Rhino exploit via <code>use exploit/multi/browser/java_rhino</code>.</p>

<p><img src="/images/postimages/201211_customejavaexe_4.png" alt="" /></p>

<p>One trip up that I messed up even just creating this blog post (and a constant headache in the #Metasploit channel on Freenode) is forgetting to set the TARGET variable in Java exploits. The default payload type being Java. Since we are using a native windows binary we need to specify Windows by setting TARGET 1.</p>

<p><img src="/images/postimages/201211_customejavaexe_5.png" alt="" /></p>

<p>Run the exploit with any settings, since we&rsquo;ll be just pulling out what we need. Then pull down the exploit JAR file with wget:</p>

<p><img src="/images/postimages/201211_customejavaexe_6.png" alt="" /></p>

<p>(Most java exploits are set to answer ANY .jar extension request with the payload.)</p>

<p>The HTML to load the JAR is pretty straight forward, but if you&rsquo;ve never seen it before here it is:</p>

<p><img src="/images/postimages/201211_customejavaexe_7.png" alt="" /></p>

<p>Thats it. A very blank page with an exploit in it. We can do better than that:</p>

<p><img src="/images/postimages/201211_customejavaexe_8.png" alt="" /></p>

<p>Obviously you can do whatever you want with the HTML, mirror a site or what have you. Notice that I&rsquo;ve also changed the name of the JAR. (You can&rsquo;t change the class unless you start making changes to the exploit directly and I wanted to keep this as generically applicable as possible)</p>

<p>Move the Applet.jar to SuperMario.jar and start up a Web server (for demo using Python&rsquo;s awesome SimpleHTTPServer, but apache will serve as well)</p>

<p><img src="/images/postimages/201211_customejavaexe_9.png" alt="" /></p>

<p>Don&rsquo;t forget to start up a handler for our now-external exploit:</p>

<p><img src="/images/postimages/201211_customejavaexe_10.png" alt="" /></p>

<p>Victim views the site:</p>

<p><img src="/images/postimages/201211_customejavaexe_11.png" alt="" /></p>

<p>And WA-LA! we haz shell:</p>

<p><img src="/images/postimages/201211_customejavaexe_12.png" alt="" /></p>

<p>Yayâ€¦ Game over..</p>

	
			

			

			
				<div class="paging">
					<span class="paging-label">More Reading</span>
					
					<div class="paging-newer">
						<span class="dark-red">Newer</span><span class="decorative-marker">//</span>
						<a class="paging-link" href="/post/2012/2012-12-24-delete-trustedinstaller-only-files-and-folders/">Delete TrustedInstaller-only Files and Folders</a>
		            </div>
		            

					
					<div class="paging-older">
						<span class="dark-red">Older</span><span class="decorative-marker">//</span>
			            <a class="paging-link" href="/post/2012/2012-11-13-smash-and-grab-windows-dir-lists/">Smash and Grab: Windows Dir Lists</a>
		            </div>
		            
	            </div>
            
          </section>
          
          	<div id="disqus_thread"></div>
<script type="text/javascript">

(function() {
    
    
    if (window.location.hostname == "localhost")
        return;
    if (window.location.hostname == "127.0.0.1")
        return;
    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
    var disqus_shortname = 'room362';
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
})();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com/" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
          
        
      <div class="footer">
	<hr class="thin" />
	<div class="pure-menu pure-menu-horizontal pure-menu-open">
		<ul class="footer-menu">
		
			<li><a href="/about">About</a></li>
		
			<li><a href="/post">Blog</a></li>
		
		</ul>
	</div>

	<p>&copy; 2016. All rights reserved.</p>
</div>
    </div>
  </div>
	

	

  
</body>
</html>
