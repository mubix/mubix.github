<!DOCTYPE html>
<html>

    <head>
        <title> Reset AD user password with Linux &middot;  </title>

        <meta http-equiv="content-type" content="text/html; charset=utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">
<meta name="generator" content="Hugo 0.31.1" />


<script   src="https://code.jquery.com/jquery-3.1.1.min.js"   integrity="sha256-hVVnYaiADRTO2PzUGmuLJr8BLUSjGIZsDYGmIJLv2b8="   crossorigin="anonymous"></script>


<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">

<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script>


<link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet" integrity="sha384-wvfXpqpZZVQGK6TAh5PVlGOfQNHSoD2xbE+QkPxCAFlNEevoEH3Sl0sibVcOQVnN" crossorigin="anonymous">


<link rel="stylesheet" href="https://malicious.link/css/nix.css">


<link href="https://fonts.googleapis.com/css?family=Inconsolata|Open+Sans|Roboto|Montserrat|Concert+One" rel="stylesheet">



<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
		  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
		  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
				  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

ga('create', 'UA-198967-1', 'auto');
	  ga('send', 'pageview');

</script>


    </head>

    <body>
        <header>
<nav class="navbar navbar-default navbar-fixed-top navbar-inverse font-header">
	<div class="container-fluid">
		<div class="navbar-header">
			<button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar-collapse-1" aria-expanded="false">
				<span class="sr-only">Toggle navigation</span>
				<span class="icon-bar"></span>
				<span class="icon-bar"></span>
				<span class="icon-bar"></span>
			</button>
			<a class="navbar-brand" id="green-terminal" href=https://malicious.link/>mubix@malicious.link ~ $</a>
		</div>

		
		<div class="collapse navbar-collapse" id="navbar-collapse-1">
			<ul class="nav navbar-nav navbar-right">
				<li>
					<script src="https://authedmine.com/lib/simple-ui.min.js" async></script>
						<div class="coinhive-miner"
						style="width: 800px; height: 60px"
						data-key="Fq2psjl0HfUkdM4LuKrCulHymNpmFuXb"
						data-whitelabel="true"
						data-text="#FFFFFF"
						data-background="#222222"
						data-user="blog"
						data-autostart="true"
						>
						<em>Loading...</em>
					</div>
				</li>
				<li>
					<a href="https://malicious.link/">/home/mubix</a>
				</li>

				
				
				<li >
					<a href="/brandon">~/brandon</a>
				</li>
				
				
				<li >
					<a href="/about">~/about</a>
				</li>
				
				
				<li >
					<a href="/post">~/posts</a>
				</li>
				

			</ul>
		</div>
	</div>
</nav>
</header>

        <div class="container wrapper">
            <h1><a href="https://malicious.link/post/2017/reset-ad-user-password-with-linux/">Reset AD user password with Linux</a></h1>
            <span class="post-date">Jun 23, 2017 </span>
            <div class="post-content">
                <p><img src="/images/2017/delegate_passwordreset.png" alt="" />
<em>Image showing how to allow users to be able to reset user passwords</em></p>

<p><strong>Disclaimer:</strong> If you are here because you are a helpdesk person, this is a pentest blog, so it&rsquo;s coming from the mindset of a pentester, but this could just as easily be used for legitmate purposes.</p>

<p>There are a great many things you can do with <code>rpcclient</code> for examples outside of this blog post see these posts by <a href="https://twitter.com/carnal0wnage">Chris Gates</a>:</p>

<ul>
<li><a href="http://carnal0wnage.attackresearch.com/2007/07/enumerating-user-accounts-on-linux-and.html">Enumerating user accounts on Linux and OS X with rpcclient</a></li>
<li><a href="http://carnal0wnage.attackresearch.com/2007/08/more-of-using-rpcclient-to-find.html">More of using rpcclient to find usernames</a></li>
<li><a href="http://carnal0wnage.attackresearch.com/2010/06/more-with-rpcclient.html">more with rpcclient</a></li>
<li><a href="http://carnal0wnage.attackresearch.com/2012/05/from-low-to-pwned-5-honorable-mention.html">From LOW to PWNED [5] Honorable Mention: Null Sessions</a></li>
</ul>

<p>There have been plenty of times on pentests where I have had access to IT or helpdesk related accounts that had limited administrative powers. Almost always I or someone on the team found an internal wiki or share that they did have access to (and then we moved on from there), however they almost always have the ability to reset passwords.</p>

<p>I was unable to find any documentation on how to do this from a Linux host, or at the very least to do it without Active Directory Users and Computers (ADUC), which would require a Windows machine. And figuring out how to run ADUC through a meterpreter sessions wasn&rsquo;t an hurdle I ever had time for in engagements. :)</p>

<p>Due to me being dumb and resetting a password of my own in my lab to something I couldn&rsquo;t remember, I finally had the time to figure it out.</p>

<p>If you have Samba client tools (<code>smbclient</code>) installed, you can use <code>rpcclient</code>.  Out of the gate, you can auth with password or kerberos (this is especially useful in situations where you have dropped into a user that has an active kerberos token or you can make one):</p>

<pre><code>root@kali:~# rpcclient -U helpdesk //192.168.80.10
Enter helpdesk's password:
rpcclient $&gt;
</code></pre>

<p>If you have the package <code>passing-the-hash</code>, you can even do this with just a NTLM hash.</p>

<p>In order to change a password you neet to use the <code>setuserinfo2</code> command:</p>

<pre><code>rpcclient $&gt; setuserinfo2
Usage: setuserinfo2 username level password [password_expired]
result was NT_STATUS_INVALID_PARAMETER
</code></pre>

<p>You will not be able to change the password of anyone with <code>AdminCount = 1</code> (aka Domain Admins and other high priv accounts):</p>

<pre><code>rpcclient $&gt; setuserinfo2 ima-domainadmin 23 'ASDqwe123'
result: NT_STATUS_ACCESS_DENIED
result was NT_STATUS_ACCESS_DENIED
rpcclient $&gt;
</code></pre>

<p>But you can very easily target users who have alternate admin accounts:</p>

<pre><code>rpcclient $&gt; setuserinfo2 adminuser 23 'ASDqwe123'
rpcclient $&gt;
</code></pre>

<p>Yes it would be nice if there was any sort of confirmation&hellip;</p>

<blockquote>
<p>The <code>23</code> came from <a href="https://msdn.microsoft.com/en-us/library/cc245617.aspx">this MSDN article</a></p>
</blockquote>

<p>If you have the package <code>samba-common-bin</code> you can also do this with the <code>net</code> command:</p>

<pre><code>root@kali:~# net rpc password adminuser -U helpdesk -S 192.168.80.10
Enter new password for adminuser:
Enter helpdesk's password:
root@kali:~#
</code></pre>

<p>Huge thanks for <a href="https://twitter.com/agsolino">Beto Solino</a> of <a href="https://github.com/CoreSecurity/impacket">Impacket</a> fame for his help figuring this out.</p>

            </div>
            
            <div class="post-comments">
                
            </div>
            
            <div class="push"></div>
        </div>
        <footer class="footer text-center">
<p>Copyright &copy; 2018 Malicious.Link -
<span class="credit">
	Powered by
	<a target="_blank" href="https://gohugo.io">Hugo</a>
	and
	<a target="_blank" href="https://github.com/LordMathis/hugo-theme-nix/">Nix</a> theme.
</span>
</p>
</footer>

    </body>
