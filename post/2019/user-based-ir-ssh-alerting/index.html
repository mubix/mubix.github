<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="ie=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="author"
    content="">
<meta name="description"
    content="What is User-Based Incident Response? I believe that user based IR is a fundamental to getting security correct in an organization. What does that mean? Empowering users to be your threat intelligence feeds. This comes in many forms, such as:
 Utilizing incentive based user awareness training (Video) or PDF on the same topic by a different author - Using Gamification to Transform Security Awareness Asking the user if they performed an action." />
<meta name="keywords" content="" />
<meta name="robots" content="noodp" />
<link rel="canonical" href="https://malicious.link/post/2019/user-based-ir-ssh-alerting/" />


<title>
    
    User Based IR - SSH Alerting :: malicious.link  â€” welcome
    
</title>



<link href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:400,700|Source+Code+Pro" rel="stylesheet"
    type="text/css">
<link href="https://cdnjs.cloudflare.com/ajax/libs/flag-icon-css/3.2.1/css/flag-icon.min.css" rel="stylesheet"
    type="text/css">


<link rel="stylesheet" href="https://malicious.link/scss/main.min.099699ab246bf26f50616f7c9f00c79d46110459d1bd727b2d07d6fc09ece082.css">



<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/site.webmanifest">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#252627">
<link rel="shortcut icon" href="/favicon.ico">
<meta name="theme-color" content="#252627">
<meta itemprop="name" content="User Based IR - SSH Alerting">
<meta itemprop="description" content="What is User-Based Incident Response? I believe that user based IR is a fundamental to getting security correct in an organization. What does that mean? Empowering users to be your threat intelligence feeds. This comes in many forms, such as:
 Utilizing incentive based user awareness training (Video) or PDF on the same topic by a different author - Using Gamification to Transform Security Awareness Asking the user if they performed an action.">


<meta itemprop="datePublished" content="2019-06-27T08:30:44-05:00" />
<meta itemprop="dateModified" content="2019-06-27T08:30:44-05:00" />
<meta itemprop="wordCount" content="463">



<meta itemprop="keywords" content="ssh,scripts,ir,sysadmin,users," />
<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="User Based IR - SSH Alerting"/>
<meta name="twitter:description" content="What is User-Based Incident Response? I believe that user based IR is a fundamental to getting security correct in an organization. What does that mean? Empowering users to be your threat intelligence feeds. This comes in many forms, such as:
 Utilizing incentive based user awareness training (Video) or PDF on the same topic by a different author - Using Gamification to Transform Security Awareness Asking the user if they performed an action."/>




<meta property="article:published_time" content="2019-06-27 08:30:44 -0500 -0500" />








    </head>

    <body class="">
        <div class="container">
            <header class="header">
    <span class="header__inner">
        <a href="/post/" style="text-decoration: none;">
    <div class="logo">
        
            <span class="logo__mark">></span>
            <span class="logo__text">boot mubix.kernel</span>
            <span class="logo__cursor"></span>
        
    </div>
</a>


        <span class="header__right">
            
                <nav class="menu">
    <ul class="menu__inner"><li><a href="https://malicious.link/about">About</a></li><li><a href="https://malicious.link/brandon">Brandon</a></li><li><a href="https://malicious.link/post">Posts</a></li><li><a href="https://malicious.link/start">Start</a></li><li><a href="https://malicious.link/tags">Tags</a></li>
    </ul>
</nav>

                <span class="menu-trigger">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                        <path d="M0 0h24v24H0z" fill="none"/>
                        <path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"/>
                    </svg>
                </span>
            

            <span class="theme-toggle"><svg class="theme-toggler" width="24" height="24" viewBox="0 0 48 48" fill="none" xmlns="http://www.w3.org/2000/svg">
  <path d="M22 41C32.4934 41 41 32.4934 41 22C41 11.5066 32.4934 3 22
  3C11.5066 3 3 11.5066 3 22C3 32.4934 11.5066 41 22 41ZM7 22C7
  13.7157 13.7157 7 22 7V37C13.7157 37 7 30.2843 7 22Z"/>
</svg>
</span>
        </span>
    </span>
</header>


            <div class="content">
                
    <main class="post">

        <div class="post-info">
            
            </p>
        </div>

        <article>
            <h2 class="post-title"><a href="https://malicious.link/post/2019/user-based-ir-ssh-alerting/">User Based IR - SSH Alerting</a></h2>

            

            <div class="post-content">
                

<h2 id="what-is-user-based-incident-response">What is User-Based Incident Response?</h2>

<p>I believe that user based IR is a fundamental to getting security correct in an organization. What does that mean? Empowering users to be your threat intelligence feeds. This comes in many forms, such as:</p>

<ol>
<li>Utilizing <a href="https://www.youtube.com/watch?time_continue=171&amp;v=VdTqLjPg2gA">incentive based user awareness training (Video)</a> or PDF on the same topic by a different author - <a href="https://www.sans.org/cyber-security-summit/archives/file/summit-archive-1493221150.pdf">Using Gamification to Transform Security Awareness</a></li>
<li>Asking the user if they performed an action. This already happens in many websites like Google, Facebook and is core to 2FA solutions. However, this is usually relegated to logins, and only

<ol>
<li><a href="https://twitter.com/ryanhuber">Ryan Huber</a> posted in 2016 in his &ldquo;<a href="https://slack.engineering/distributed-security-alerting-c89414c992d6">Distributed Security Alerting</a>&rdquo; medium post that this type of alerting and verification should be extended to actions as well, in particular administrative actions.</li>
</ol></li>
</ol>

<p>In this blog post we&rsquo;ll walk down the track of enabling #2 for your fleet of Linux boxes. I hope to turn this into a series where I walk through enabling first login alerting for Linux, Windows, and Mac systems, but also alerting for administrative actions like Ryan suggests.</p>

<h2 id="ssh-login-push-notifications">SSH Login Push Notifications</h2>

<p>Most logins on Linux machines happen over SSH, so lets start there.</p>

<h3 id="first-create-the-alert">First, create the alert</h3>

<p>First things first, we have to create an alert. I&rsquo;m not worried about alerting every time there is a failed attempt to log in, that doesn&rsquo;t tell me much and depending on where this is deployed that can be an insane amount of alerts, but successful logins, that&rsquo;s important.</p>

<p>I found this Ask Ubuntu question when googling around for the answer: <a href="https://askubuntu.com/questions/179889/how-do-i-set-up-an-email-alert-when-a-ssh-login-is-successful">How do I set up an email alert when a ssh login is successful</a></p>

<p>Which provides this script:</p>

<pre><code>#!/bin/sh

# Change these two lines:
sender=&quot;sender-address@example.com&quot;
recipient=&quot;notify-address@example.org&quot;

if [ &quot;$PAM_TYPE&quot; != &quot;close_session&quot; ]; then
    host=&quot;`hostname`&quot;
    subject=&quot;SSH Login: $PAM_USER from $PAM_RHOST on $host&quot;
    # Message to send, e.g. the current environment variables.
    message=&quot;`env`&quot;
    echo &quot;$message&quot; | mailx -r &quot;$sender&quot; -s &quot;$subject&quot; &quot;$recipient&quot;
fi
</code></pre>

<p>Then you put the file somewhere, mark it as executable and add the following to the <code>/etc/pam.d/sshd</code> config file:</p>

<p><code>session optional pam_exec.so seteuid /path/to/login-notify.sh</code></p>

<p>This is all fine and dandy if you want all of the alerts going to a single email address (or group email) and for it to go completely ignored due to crazy amounts of emails.</p>

<p>I modified the script slightly to use a webhook instead</p>

<pre><code>#!/bin/sh

if [ &quot;$PAM_TYPE&quot; != &quot;close_session&quot; ]; then
        host=&quot;`hostname`&quot;
        info=&quot;$PAM_USER-$PAM_RHOST-$host&quot;
        test=&quot;`echo $info | base64`&quot;
        curl https://www.webhook.site/9b064a79-37a5-49f5-b80b-c9ed120fc280/?$test
fi
</code></pre>

<pre><code>#!/usr/bin/env python
import os
import json
import socket
import urllib3

# Get Primary IP Address
s = socket.socket(socket.AF_INET, socket.SOCK_DGRAM)
s.connect((&quot;8.8.8.8&quot;, 80))
ip = s.getsockname()[0]
s.close()

user = os.environ['PAM_USER']
rhost = os.environ['PAM_RHOST']
hostname = socket.gethostname()

data = { 'user': user, 'rhost':rhost, 'lhost':ip, 'lhostname':hostname }
jsondata = json.dumps(data)
url = 'https://www.webhook.site/9b064a79-37a5-49f5-b80b-c9ed120fc280'
http = urllib3.PoolManager()

test = http.request('POST', 
	url, 
	headers={'Content-Type': 'application/json'},
	body=jsondata )
</code></pre>

            </div>
        </article>

        <hr />

        <div class="post-info">
  				<p>
  					<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-tag meta-icon"><path d="M20.59 13.41l-7.17 7.17a2 2 0 0 1-2.83 0L2 12V2h10l8.59 8.59a2 2 0 0 1 0 2.82z"></path><line x1="7" y1="7" x2="7" y2="7"></line></svg><span class="tag"><a href="https://malicious.link/tags/ssh">ssh</a></span><span class="tag"><a href="https://malicious.link/tags/scripts">scripts</a></span><span class="tag"><a href="https://malicious.link/tags/ir">ir</a></span><span class="tag"><a href="https://malicious.link/tags/sysadmin">sysadmin</a></span><span class="tag"><a href="https://malicious.link/tags/users">users</a></span>
  				</p>
  			</div>

        
    </main>

            </div>

            
                <footer class="footer">
    <div class="footer__inner">
        <div class="footer__content">
            <span>&copy; 2019</span>
            
            <span></span>
            <span> <a href="https://malicious.link/posts/index.xml" target="_blank" title="rss"><svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 20 20" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-rss"><path d="M4 11a9 9 0 0 1 9 9"></path><path d="M4 4a16 16 0 0 1 16 16"></path><circle cx="5" cy="19" r="1"></circle></svg></a></span>
        </div>
    </div>
    <div class="footer__inner">
        <div class="footer__content">

        </div>
    </div>
    <div class="footer__inner">
        <div class="footer__content">
            <span>Powered by <a href="http://gohugo.io">Hugo</a></span>
            <span>Made with &#10084; by <a href="https://github.com/rhazdon">rhazdon</a></span>
        </div>
    </div>
</footer>

            
        </div>

        





<script type="text/javascript" src="https://malicious.link/js/bundle.4b80fbbfab88198dcef181b034822e60a3e68b1c128d1dc05392a32943a18ec2f866fbcd9ce31dcf84134397161647ad605ea5c25ecf12e5fcf9d28b47e64bb5.js" integrity="sha512-S4D7v6uIGY3O8YGwNIIuYKPmixwSjR3AU5KjKUOhjsL4ZvvNnOMdz4QTQ5cWFketYF6lwl7PEuX8&#43;dKLR&#43;ZLtQ=="></script>



    </body>
</html>
