<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
        <title>EXE::Custom in Metasploit&#39;s Java Exploits &middot; Rob &#39;mubix&#39; Fuller</title>
        <meta name="description" content="Let me say first off that this isn&rsquo;t the most elegant of ways to accomplish it. It is in the &ldquo;it works for me&rdquo; stage.
A quick primer on EXE::Custom: This is a setting just like RHOST in Metasploit wherever an EXE is built for Windows payloads. Such as PSEXEC, BypassUAC, etc. It tells Metasploit to ignore all of your payload settings and just use the EXE you have specified. Now this does come at a bit of a cost.">
        <meta name="HandheldFriendly" content="True">
        <meta name="MobileOptimized" content="320">
        <meta name="generator" content="Hugo 0.17" />
        <meta name="robots" content="index,follow">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        
        <link rel="stylesheet" href="https://room362.com/css/normalize.css">
        <link rel="stylesheet" href="https://room362.com/css/highlight.css">
        <link rel="stylesheet" href="https://room362.com/css/style.css">
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,400,600,700,300&subset=latin,cyrillic-ext,latin-ext,cyrillic">
        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css">
    </head>
    <body>
        
<script>
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','//www.google-analytics.com/analytics.js','ga');

ga('create', 'UA-198967-1', 'auto');
ga('send', 'pageview');
</script>


        <div id="wrapper">
            <header class="site-header">
                <div class="container">
                    <div class="site-title-wrapper">
                        
                            <h1 class="site-title">
                                <a title="Room362" href="https://room362.com/">Room362</a>
                            </h1>
                        
                        <a class="button-square" href="https://room362.com/index.xml"><i class="fa fa-rss"></i></a>
                        
                            <a class="button-square button-social hint--top" data-hint="Twitter" title="Twitter" href="https://twitter.com/mubix">
                                <i class="fa fa-twitter"></i>
                            </a>
                        
                        
                        
                            <a class="button-square button-social hint--top" data-hint="Github" title="Github" href="https://github.com/mubix">
                                <i class="fa fa-github-alt"></i>
                            </a>
                        
                        
                        
                            <a class="button-square button-social hint--top" data-hint="LinkedIn" title="LinkedIn" href="https://linkedin.com/in/mubix">
                                <i class="fa fa-linkedin"></i>
                            </a>
                        
                        
                            <a class="button-square button-social hint--top" data-hint="Google+" title="Google+" href="https://google.com/&#43;mubix">
                                <i class="fa fa-google-plus"></i>
                            </a>
                        
                    </div>

                    <ul class="site-nav">
                        
    <li class="site-nav-item">
        <a title="Brandon" href="/brandon/">Brandon</a>
    </li>

    <li class="site-nav-item">
        <a title="About" href="/about/">About</a>
    </li>

    <li class="site-nav-item">
        <a title="Start in Infosec" href="/start/">Start in Infosec</a>
    </li>

    <li class="site-nav-item">
        <a title="Projects" href="/projects/">Projects</a>
    </li>

    <li class="site-nav-item">
        <a title="PwnWiki" href="http://pwnwiki.io">PwnWiki</a>
    </li>

                    </ul>
                </div>
            </header>

            <div id="container">


<div class="container">
    <article class="post-container">
        <header class="post-header">
    <h1 class="post-title">EXE::Custom in Metasploit&#39;s Java Exploits</h1>
    
</header>

        <div class="post-content clearfix">
    

    <p>Let me say first off that this isn&rsquo;t the most elegant of ways to accomplish it. It is in the &ldquo;it works for me&rdquo; stage.</p>

<p>A quick primer on EXE::Custom: This is a setting just like RHOST in Metasploit wherever an EXE is built for Windows payloads. Such as PSEXEC, BypassUAC, etc. It tells Metasploit to ignore all of your payload settings and just use the EXE you have specified. Now this does come at a bit of a cost. If you don&rsquo;t have a handler set up to catch whatever is in your EXE and you have bogus information in your payload settings for your module, Metasploit won&rsquo;t be able to magically determine what you want it to do. So make sure that you either have the payload settings correct (even though it won&rsquo;t use them for the exploit) or set the option &ldquo;DisablePayloadHandler&rdquo; to true and start your own handler somewhere else.</p>

<p>With that said, the Java Signed Applet attack is one of the most widely used, one problem in the Metasploit module version is that you have no external control (such as EXE::Custom) for the binary that is dropped if you are using a Windows native payload. (I do highly recommend trying out Java Meterpreter, but that it for another post)</p>

<p>Here is the hack that gets me by until a more elegant solution is thought up by smarter people than I:</p>

<p>We are going to use the Java Rhino exploit, and this story starts with an undetectable.exe sitting in /tmp/ - How you bypass the AV you are up against is up to you. The first thing we need to do is make a core library change. Yes, this is as scary as it sounds and you should document any time you do so you can revert as needed.</p>

<p>In your MSF directory open up lib/msf/util/exe.rb - should look something like this:</p>

<p><img src="/images/postimages/201211_customejavaexe_1.png" alt="" /></p>

<p>Scroll down or search for <code>self.to_jar</code> - should look something like this:</p>

<p><img src="/images/postimages/201211_customejavaexe_2.png" alt="" /></p>

<p>Now add <code>exe = File.read('/path/to/your/evil.exe')</code> as demonstrated below:</p>

<p><img src="/images/postimages/201211_customejavaexe_3.png" alt="" /></p>

<p>Cool. We&rsquo;ve made our change, now we have to pull down a jar generated with our evil bin, and the Rhino exploit. We can do that by spinning up Metasploit with our newly editing core library. Load up the Rhino exploit via <code>use exploit/multi/browser/java_rhino</code>.</p>

<p><img src="/images/postimages/201211_customejavaexe_4.png" alt="" /></p>

<p>One trip up that I messed up even just creating this blog post (and a constant headache in the #Metasploit channel on Freenode) is forgetting to set the TARGET variable in Java exploits. The default payload type being Java. Since we are using a native windows binary we need to specify Windows by setting TARGET 1.</p>

<p><img src="/images/postimages/201211_customejavaexe_5.png" alt="" /></p>

<p>Run the exploit with any settings, since we&rsquo;ll be just pulling out what we need. Then pull down the exploit JAR file with wget:</p>

<p><img src="/images/postimages/201211_customejavaexe_6.png" alt="" /></p>

<p>(Most java exploits are set to answer ANY .jar extension request with the payload.)</p>

<p>The HTML to load the JAR is pretty straight forward, but if you&rsquo;ve never seen it before here it is:</p>

<p><img src="/images/postimages/201211_customejavaexe_7.png" alt="" /></p>

<p>Thats it. A very blank page with an exploit in it. We can do better than that:</p>

<p><img src="/images/postimages/201211_customejavaexe_8.png" alt="" /></p>

<p>Obviously you can do whatever you want with the HTML, mirror a site or what have you. Notice that I&rsquo;ve also changed the name of the JAR. (You can&rsquo;t change the class unless you start making changes to the exploit directly and I wanted to keep this as generically applicable as possible)</p>

<p>Move the Applet.jar to SuperMario.jar and start up a Web server (for demo using Python&rsquo;s awesome SimpleHTTPServer, but apache will serve as well)</p>

<p><img src="/images/postimages/201211_customejavaexe_9.png" alt="" /></p>

<p>Don&rsquo;t forget to start up a handler for our now-external exploit:</p>

<p><img src="/images/postimages/201211_customejavaexe_10.png" alt="" /></p>

<p>Victim views the site:</p>

<p><img src="/images/postimages/201211_customejavaexe_11.png" alt="" /></p>

<p>And WA-LA! we haz shell:</p>

<p><img src="/images/postimages/201211_customejavaexe_12.png" alt="" /></p>

<p>Yayâ€¦ Game over..</p>

</div>

        <footer class="post-footer clearfix">
    

    <div class="share">
        <a class="icon-twitter" href="https://twitter.com/share?text=EXE%3a%3aCustom%20in%20Metasploit%27s%20Java%20Exploits&url=https%3a%2f%2froom362.com%2fpost%2f2012%2f2012-11-19-execustom-in-metasploits-java-exploits%2f"
            onclick="window.open(this.href, 'twitter-share', 'width=550,height=235');return false;">
            <i class="fa fa-twitter"></i>
            <span class="hidden">Twitter</span>
        </a>

        <a class="icon-facebook" href="https://www.facebook.com/sharer/sharer.php?u=https%3a%2f%2froom362.com%2fpost%2f2012%2f2012-11-19-execustom-in-metasploits-java-exploits%2f"
            onclick="window.open(this.href, 'facebook-share','width=580,height=296');return false;">
            <i class="fa fa-facebook"></i>
            <span class="hidden">Facebook</span>
        </a>

        <a class="icon-google-plus" href="https://plus.google.com/share?url=https%3a%2f%2froom362.com%2fpost%2f2012%2f2012-11-19-execustom-in-metasploits-java-exploits%2f"
           onclick="window.open(this.href, 'google-plus-share', 'width=490,height=530');return false;">
           <i class="fa fa-google-plus"></i>
            <span class="hidden">Google+</span>
        </a>
    </div>
</footer>
    </article>
</div>

            </div>
        </div>

        <footer class="footer">
            <div class="container">
                <div class="site-title-wrapper">
                    <h1 class="site-title">
                        <a title="Room362" href="https://room362.com/">Room362</a>
                    </h1>
                    <a class="button-square button-jump-top js-jump-top" href="#">
                        <i class="fa fa-angle-up"></i>
                    </a>
                </div>

                <p class="footer-copyright">
                    <span>&copy; 2016 / Powered by <a href="https://gohugo.io/">Hugo</a></span>
                </p>
                <p class="footer-copyright">
                    <span><a href="https://github.com/roryg/ghostwriter">Ghostwriter theme</a> By <a href="http://jollygoodthemes.com">JollyGoodThemes</a></span>
                    <span>/ <a href="https://github.com/jbub/ghostwriter">Ported</a> to Hugo By <a href="https://github.com/jbub">jbub</a></span>
                </p>
            </div>
        </footer>

        <script src="https://room362.com/js/jquery-1.11.3.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.9.0/highlight.min.js"></script>
        <script src="https://room362.com/js/jquery.fitvids.js"></script>
        <script src="https://room362.com/js/scripts.js"></script>
    </body>
</html>

