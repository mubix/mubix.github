<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
        <title>Reset AD user password with Linux &middot; Rob &#39;mubix&#39; Fuller</title>
        <meta name="description" content="Image showing how to allow users to be able to reset user passwords
Disclaimer: If you are here because you are a helpdesk person, this is a pentest blog, so it&rsquo;s coming from the mindset of a pentester, but this could just as easily be used for legitmate purposes.
There are a great many things you can do with rpcclient for examples outside of this blog post see these posts by Chris Gates:">
        <meta name="HandheldFriendly" content="True">
        <meta name="MobileOptimized" content="320">
        <meta name="generator" content="Hugo 0.26" />
        <meta name="robots" content="index,follow">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        
        <link rel="stylesheet" href="https://room362.com/dist/styles.css">
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,400,600,700,300&subset=latin,cyrillic-ext,latin-ext,cyrillic">
        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css">
        
    </head>
    <body>
        
<script>
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

ga('create', 'UA-198967-1', 'auto');
ga('send', 'pageview');
</script>


        <div id="wrapper">
            <header class="site-header">
                <div class="container">
                    <div class="site-title-wrapper">
                        
                            <h1 class="site-title">
                                <a title="Room362" href="https://room362.com/">Room362</a>
                            </h1>
                        
                        <a class="button-square" href="https://room362.com/index.xml"><i class="fa fa-rss"></i></a>
                        
                            <a class="button-square button-social hint--top" data-hint="Twitter" title="Twitter" href="https://twitter.com/mubix">
                                <i class="fa fa-twitter"></i>
                            </a>
                        
                        
                        
                            <a class="button-square button-social hint--top" data-hint="Github" title="Github" href="https://github.com/mubix">
                                <i class="fa fa-github-alt"></i>
                            </a>
                        
                        
                        
                            <a class="button-square button-social hint--top" data-hint="LinkedIn" title="LinkedIn" href="https://linkedin.com/in/mubix">
                                <i class="fa fa-linkedin"></i>
                            </a>
                        
                        
                            <a class="button-square button-social hint--top" data-hint="Google+" title="Google+" href="https://google.com/&#43;mubix">
                                <i class="fa fa-google-plus"></i>
                            </a>
                        
                        
                    </div>

                    <ul class="site-nav">
                        
    <li class="site-nav-item">
        <a title="Brandon" href="/brandon/">Brandon</a>
    </li>

    <li class="site-nav-item">
        <a title="About Me" href="/about/">About Me</a>
    </li>

    <li class="site-nav-item">
        <a title="Start in Infosec" href="/start/">Start in Infosec</a>
    </li>

    <li class="site-nav-item">
        <a title="Attacker KB" href="https://attackerkb.com/">Attacker KB</a>
    </li>

    <li class="site-nav-item">
        <a title="Projects" href="/projects/">Projects</a>
    </li>

                    </ul>
                </div>
            </header>

            <div id="container">


<div class="container">
    <article class="post-container" itemscope="" itemtype="http://schema.org/BlogPosting">
        <header class="post-header">
    <h1 class="post-title" itemprop="name headline">Reset AD user password with Linux</h1>
    
    <p class="post-date">
        <span>Published <time datetime="2017-06-23" itemprop="datePublished">Fri, Jun 23, 2017</time></span>
        <span>by</span>
        <span itemscope="" itemprop="author" itemtype="https://schema.org/Person">
            <span itemprop="name">
                <a href="https://twitter.com/mubix" itemprop="url" rel="author">Rob &#39;mubix&#39; Fuller</a>
            </span>
        </span>
    </p>
</header>

        <div class="post-content clearfix" itemprop="articleBody">
    

    <p><img src="/images/2017/delegate_passwordreset.png" alt="" />
<em>Image showing how to allow users to be able to reset user passwords</em></p>

<p><strong>Disclaimer:</strong> If you are here because you are a helpdesk person, this is a pentest blog, so it&rsquo;s coming from the mindset of a pentester, but this could just as easily be used for legitmate purposes.</p>

<p>There are a great many things you can do with <code>rpcclient</code> for examples outside of this blog post see these posts by <a href="https://twitter.com/carnal0wnage">Chris Gates</a>:</p>

<ul>
<li><a href="http://carnal0wnage.attackresearch.com/2007/07/enumerating-user-accounts-on-linux-and.html">Enumerating user accounts on Linux and OS X with rpcclient</a></li>
<li><a href="http://carnal0wnage.attackresearch.com/2007/08/more-of-using-rpcclient-to-find.html">More of using rpcclient to find usernames</a></li>
<li><a href="http://carnal0wnage.attackresearch.com/2010/06/more-with-rpcclient.html">more with rpcclient</a></li>
<li><a href="http://carnal0wnage.attackresearch.com/2012/05/from-low-to-pwned-5-honorable-mention.html">From LOW to PWNED [5] Honorable Mention: Null Sessions</a></li>
</ul>

<p>There have been plenty of times on pentests where I have had access to IT or helpdesk related accounts that had limited administrative powers. Almost always I or someone on the team found an internal wiki or share that they did have access to (and then we moved on from there), however they almost always have the ability to reset passwords.</p>

<p>I was unable to find any documentation on how to do this from a Linux host, or at the very least to do it without Active Directory Users and Computers (ADUC), which would require a Windows machine. And figuring out how to run ADUC through a meterpreter sessions wasn&rsquo;t an hurdle I ever had time for in engagements. :)</p>

<p>Due to me being dumb and resetting a password of my own in my lab to something I couldn&rsquo;t remember, I finally had the time to figure it out.</p>

<p>If you have Samba client tools (<code>smbclient</code>) installed, you can use <code>rpcclient</code>.  Out of the gate, you can auth with password or kerberos (this is especially useful in situations where you have dropped into a user that has an active kerberos token or you can make one):</p>

<pre><code>root@kali:~# rpcclient -U helpdesk //192.168.80.10
Enter helpdesk's password:
rpcclient $&gt;
</code></pre>

<p>If you have the package <code>passing-the-hash</code>, you can even do this with just a NTLM hash.</p>

<p>In order to change a password you neet to use the <code>setuserinfo2</code> command:</p>

<pre><code>rpcclient $&gt; setuserinfo2
Usage: setuserinfo2 username level password [password_expired]
result was NT_STATUS_INVALID_PARAMETER
</code></pre>

<p>You will not be able to change the password of anyone with <code>AdminCount = 1</code> (aka Domain Admins and other high priv accounts):</p>

<pre><code>rpcclient $&gt; setuserinfo2 ima-domainadmin 23 'ASDqwe123'
result: NT_STATUS_ACCESS_DENIED
result was NT_STATUS_ACCESS_DENIED
rpcclient $&gt;
</code></pre>

<p>But you can very easily target users who have alternate admin accounts:</p>

<pre><code>rpcclient $&gt; setuserinfo2 adminuser 23 'ASDqwe123'
rpcclient $&gt;
</code></pre>

<p>Yes it would be nice if there was any sort of confirmation&hellip;</p>

<blockquote>
<p>The <code>23</code> came from <a href="https://msdn.microsoft.com/en-us/library/cc245617.aspx">this MSDN article</a></p>
</blockquote>

<p>If you have the package <code>samba-common-bin</code> you can also do this with the <code>net</code> command:</p>

<pre><code>root@kali:~# net rpc password adminuser -U helpdesk -S 192.168.80.10
Enter new password for adminuser:
Enter helpdesk's password:
root@kali:~#
</code></pre>

<p>Huge thanks for <a href="https://twitter.com/agsolino">Beto Solino</a> of <a href="https://github.com/CoreSecurity/impacket">Impacket</a> fame for his help figuring this out.</p>

</div>

        <footer class="post-footer clearfix">
    
        <p class="post-tags">
            <span>Tagged:</span>
            
            
                <a href="/tags/rpcclient/">rpcclient</a>, 
            
                <a href="/tags/net/">net</a>, 
            
                <a href="/tags/redteaming/">redteaming</a>
            
        </p>
    

    <a class="muut" href="https://muut.com/i/room362/comments" type="dynamic">room362</a> <script src="//cdn.muut.com/1/moot.min.js"></script>

    <div class="share">
        
            <a class="icon-twitter" href="https://twitter.com/share?text=Reset%20AD%20user%20password%20with%20Linux&url=https%3a%2f%2froom362.com%2fpost%2f2017%2freset-ad-user-password-with-linux%2f"
                onclick="window.open(this.href, 'twitter-share', 'width=550,height=235');return false;">
                <i class="fa fa-twitter"></i>
                <span class="hidden">Twitter</span>
            </a>
        

        
            <a class="icon-facebook" href="https://www.facebook.com/sharer/sharer.php?u=https%3a%2f%2froom362.com%2fpost%2f2017%2freset-ad-user-password-with-linux%2f"
                onclick="window.open(this.href, 'facebook-share','width=580,height=296');return false;">
                <i class="fa fa-facebook"></i>
                <span class="hidden">Facebook</span>
            </a>
        

        
            <a class="icon-google-plus" href="https://plus.google.com/share?url=https%3a%2f%2froom362.com%2fpost%2f2017%2freset-ad-user-password-with-linux%2f"
              onclick="window.open(this.href, 'google-plus-share', 'width=490,height=530');return false;">
              <i class="fa fa-google-plus"></i>
                <span class="hidden">Google+</span>
            </a>
        
        
    </div>
</footer>


        
    </article>
</div>

            </div>
        </div>

        <footer class="footer">
            <div class="container">
                <div class="site-title-wrapper">
                    <h1 class="site-title">
                        <a title="Room362" href="https://room362.com/">Room362</a>
                    </h1>
                    <a class="button-square button-jump-top js-jump-top" href="#">
                        <i class="fa fa-angle-up"></i>
                    </a>
                </div>

                <p class="footer-copyright">
                    <span>&copy; 2017 / Powered by <a href="https://gohugo.io/">Hugo</a></span>
                </p>
                <p class="footer-copyright">
                    <span><a href="https://github.com/roryg/ghostwriter">Ghostwriter theme</a> By <a href="http://jollygoodthemes.com">JollyGoodThemes</a></span>
                    <span>/ <a href="https://github.com/jbub/ghostwriter">Ported</a> to Hugo By <a href="https://github.com/jbub">jbub</a></span>
                </p>
            </div>
        </footer>

        <script src="https://room362.com/js/jquery-1.11.3.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.9.0/highlight.min.js"></script>
        <script src="https://room362.com/js/jquery.fitvids.js"></script>
        <script src="https://room362.com/js/scripts.js"></script>
    </body>
</html>

