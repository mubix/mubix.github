<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="ie=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="author"
    content="mubix">
<meta name="description"
    content="Let me say first off that this isn&amp;rsquo;t the most elegant of ways to accomplish it. It is in the &amp;ldquo;it works for me&amp;rdquo; stage.
A quick primer on EXE::Custom: This is a setting just like RHOST in Metasploit wherever an EXE is built for Windows payloads. Such as PSEXEC, BypassUAC, etc. It tells Metasploit to ignore all of your payload settings and just use the EXE you have specified. Now this does come at a bit of a cost." />
<meta name="keywords" content="" />
<meta name="robots" content="noodp" />
<link rel="canonical" href="/post/2012/2012-11-19-execustom-in-metasploits-java-exploits/" />


<title>
    
    EXE::Custom in Metasploit&#39;s Java Exploits :: malicious.link  — welcome
    
</title>



<link href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:400,700|Source+Code+Pro" rel="stylesheet"
    type="text/css">
<link href="https://cdnjs.cloudflare.com/ajax/libs/flag-icon-css/3.2.1/css/flag-icon.min.css" rel="stylesheet"
    type="text/css">


<link rel="stylesheet" href="/scss/main.min.099699ab246bf26f50616f7c9f00c79d46110459d1bd727b2d07d6fc09ece082.css">



<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/site.webmanifest">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#252627">
<link rel="shortcut icon" href="/favicon.ico">
<meta name="theme-color" content="#252627">
<meta itemprop="name" content="EXE::Custom in Metasploit&#39;s Java Exploits">
<meta itemprop="description" content="Let me say first off that this isn&rsquo;t the most elegant of ways to accomplish it. It is in the &ldquo;it works for me&rdquo; stage.
A quick primer on EXE::Custom: This is a setting just like RHOST in Metasploit wherever an EXE is built for Windows payloads. Such as PSEXEC, BypassUAC, etc. It tells Metasploit to ignore all of your payload settings and just use the EXE you have specified. Now this does come at a bit of a cost.">


<meta itemprop="datePublished" content="2012-11-19T05:59:10&#43;00:00" />
<meta itemprop="dateModified" content="2012-11-19T05:59:10&#43;00:00" />
<meta itemprop="wordCount" content="609">



<meta itemprop="keywords" content="" />
<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="EXE::Custom in Metasploit&#39;s Java Exploits"/>
<meta name="twitter:description" content="Let me say first off that this isn&rsquo;t the most elegant of ways to accomplish it. It is in the &ldquo;it works for me&rdquo; stage.
A quick primer on EXE::Custom: This is a setting just like RHOST in Metasploit wherever an EXE is built for Windows payloads. Such as PSEXEC, BypassUAC, etc. It tells Metasploit to ignore all of your payload settings and just use the EXE you have specified. Now this does come at a bit of a cost."/>



<meta property="article:section" content="java" />
<meta property="article:section" content="metasploit" />

<meta property="article:published_time" content="2012-11-19 05:59:10 &#43;0000 &#43;0000" />








    </head>

    <body class="">
        <div class="container">
            <header class="header">
    <span class="header__inner">
        <a href="/post/" style="text-decoration: none;">
    <div class="logo">
        
            <span class="logo__mark">></span>
            <span class="logo__text">boot mubix.kernel</span>
            <span class="logo__cursor"></span>
        
    </div>
</a>


        <span class="header__right">
            
                <nav class="menu">
    <ul class="menu__inner"><li><a href="/about">About</a></li><li><a href="/brandon">Brandon</a></li><li><a href="/post">Posts</a></li><li><a href="/start">Start</a></li>
    </ul>
</nav>

                <span class="menu-trigger">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                        <path d="M0 0h24v24H0z" fill="none"/>
                        <path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"/>
                    </svg>
                </span>
            

            <span class="theme-toggle"><svg class="theme-toggler" width="24" height="24" viewBox="0 0 48 48" fill="none" xmlns="http://www.w3.org/2000/svg">
  <path d="M22 41C32.4934 41 41 32.4934 41 22C41 11.5066 32.4934 3 22
  3C11.5066 3 3 11.5066 3 22C3 32.4934 11.5066 41 22 41ZM7 22C7
  13.7157 13.7157 7 22 7V37C13.7157 37 7 30.2843 7 22Z"/>
</svg>
</span>
        </span>
    </span>
</header>


            <div class="content">
                
    <main class="post">

        <div class="post-info">
            
            </p>
        </div>

        <article>
            <h2 class="post-title"><a href="/post/2012/2012-11-19-execustom-in-metasploits-java-exploits/">EXE::Custom in Metasploit&rsquo;s Java Exploits</a></h2>

            

            <div class="post-content">
                <p>Let me say first off that this isn&rsquo;t the most elegant of ways to accomplish it. It is in the &ldquo;it works for me&rdquo; stage.</p>

<p>A quick primer on EXE::Custom: This is a setting just like RHOST in Metasploit wherever an EXE is built for Windows payloads. Such as PSEXEC, BypassUAC, etc. It tells Metasploit to ignore all of your payload settings and just use the EXE you have specified. Now this does come at a bit of a cost. If you don&rsquo;t have a handler set up to catch whatever is in your EXE and you have bogus information in your payload settings for your module, Metasploit won&rsquo;t be able to magically determine what you want it to do. So make sure that you either have the payload settings correct (even though it won&rsquo;t use them for the exploit) or set the option &ldquo;DisablePayloadHandler&rdquo; to true and start your own handler somewhere else.</p>

<p>With that said, the Java Signed Applet attack is one of the most widely used, one problem in the Metasploit module version is that you have no external control (such as EXE::Custom) for the binary that is dropped if you are using a Windows native payload. (I do highly recommend trying out Java Meterpreter, but that it for another post)</p>

<p>Here is the hack that gets me by until a more elegant solution is thought up by smarter people than I:</p>

<p>We are going to use the Java Rhino exploit, and this story starts with an undetectable.exe sitting in /tmp/ - How you bypass the AV you are up against is up to you. The first thing we need to do is make a core library change. Yes, this is as scary as it sounds and you should document any time you do so you can revert as needed.</p>

<p>In your MSF directory open up lib/msf/util/exe.rb - should look something like this:</p>

<p><img src="/images/postimages/201211_customejavaexe_1.png" alt="" /></p>

<p>Scroll down or search for <code>self.to_jar</code> - should look something like this:</p>

<p><img src="/images/postimages/201211_customejavaexe_2.png" alt="" /></p>

<p>Now add <code>exe = File.read('/path/to/your/evil.exe')</code> as demonstrated below:</p>

<p><img src="/images/postimages/201211_customejavaexe_3.png" alt="" /></p>

<p>Cool. We&rsquo;ve made our change, now we have to pull down a jar generated with our evil bin, and the Rhino exploit. We can do that by spinning up Metasploit with our newly editing core library. Load up the Rhino exploit via <code>use exploit/multi/browser/java_rhino</code>.</p>

<p><img src="/images/postimages/201211_customejavaexe_4.png" alt="" /></p>

<p>One trip up that I messed up even just creating this blog post (and a constant headache in the #Metasploit channel on Freenode) is forgetting to set the TARGET variable in Java exploits. The default payload type being Java. Since we are using a native windows binary we need to specify Windows by setting TARGET 1.</p>

<p><img src="/images/postimages/201211_customejavaexe_5.png" alt="" /></p>

<p>Run the exploit with any settings, since we&rsquo;ll be just pulling out what we need. Then pull down the exploit JAR file with wget:</p>

<p><img src="/images/postimages/201211_customejavaexe_6.png" alt="" /></p>

<p>(Most java exploits are set to answer ANY .jar extension request with the payload.)</p>

<p>The HTML to load the JAR is pretty straight forward, but if you&rsquo;ve never seen it before here it is:</p>

<p><img src="/images/postimages/201211_customejavaexe_7.png" alt="" /></p>

<p>Thats it. A very blank page with an exploit in it. We can do better than that:</p>

<p><img src="/images/postimages/201211_customejavaexe_8.png" alt="" /></p>

<p>Obviously you can do whatever you want with the HTML, mirror a site or what have you. Notice that I&rsquo;ve also changed the name of the JAR. (You can&rsquo;t change the class unless you start making changes to the exploit directly and I wanted to keep this as generically applicable as possible)</p>

<p>Move the Applet.jar to SuperMario.jar and start up a Web server (for demo using Python&rsquo;s awesome SimpleHTTPServer, but apache will serve as well)</p>

<p><img src="/images/postimages/201211_customejavaexe_9.png" alt="" /></p>

<p>Don&rsquo;t forget to start up a handler for our now-external exploit:</p>

<p><img src="/images/postimages/201211_customejavaexe_10.png" alt="" /></p>

<p>Victim views the site:</p>

<p><img src="/images/postimages/201211_customejavaexe_11.png" alt="" /></p>

<p>And WA-LA! we haz shell:</p>

<p><img src="/images/postimages/201211_customejavaexe_12.png" alt="" /></p>

<p>Yay… Game over..</p>

            </div>
        </article>

        <hr />

        <div class="post-info">
  			</div>

        
          <div id="comments" class="thin">
</div>
        
    </main>

            </div>

            
                <footer class="footer">
    <div class="footer__inner">
        <div class="footer__content">
            <span>&copy; 2019</span>
            
            <span></span>
            <span> <a href="/posts/index.xml" target="_blank" title="rss"><svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 20 20" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-rss"><path d="M4 11a9 9 0 0 1 9 9"></path><path d="M4 4a16 16 0 0 1 16 16"></path><circle cx="5" cy="19" r="1"></circle></svg></a></span>
        </div>
    </div>
    <div class="footer__inner">
        <div class="footer__content">

        </div>
    </div>
    <div class="footer__inner">
        <div class="footer__content">
            <span>Powered by <a href="http://gohugo.io">Hugo</a></span>
            <span>Made with &#10084; by <a href="https://github.com/rhazdon">rhazdon</a></span>
        </div>
    </div>
</footer>

            
        </div>

        





<script type="text/javascript" src="/js/bundle.4b80fbbfab88198dcef181b034822e60a3e68b1c128d1dc05392a32943a18ec2f866fbcd9ce31dcf84134397161647ad605ea5c25ecf12e5fcf9d28b47e64bb5.js" integrity="sha512-S4D7v6uIGY3O8YGwNIIuYKPmixwSjR3AU5KjKUOhjsL4ZvvNnOMdz4QTQ5cWFketYF6lwl7PEuX8&#43;dKLR&#43;ZLtQ=="></script>



    </body>
</html>
